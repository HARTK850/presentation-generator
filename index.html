<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideGenius AI Pro - מחולל מצגות מתקדם עם בינה מלאכותית</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PptxGenJS -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800;900&family=Assistant:wght@200;300;400;500;600;700&family=Heebo:wght@100;200;300;400;500;600;700;800;900&family=Alef:wght@400;700&family=David+Libre:wght@400;500;700&family=Secular+One&family=Varela+Round&family=Noto+Sans+Hebrew:wght@100;200;300;400;500;600;700;800;900&family=Amatic+SC:wght@400;700&family=Gverets&family=Frank+Ruhl+Libre:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modified font family */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl; /* Ensured RTL direction */
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        /* שיפור responsive design עם breakpoints נוספים */
        @media (min-width: 640px) {
            .container {
                padding: 15px;
            }
        }

        @media (min-width: 768px) {
            .container {
                padding: 20px;
                max-width: 1400px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                padding: 30px;
            }
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 20px 30px;
                margin-bottom: 20px;
            }
        }


        /* גלילה מותאמת */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* אנימציות */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* New animation for modal */
        @keyframes modalSlideIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        /* כרטיס שקף */
        .slide-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .slide-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .slide-card.active {
            border: 3px solid #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .slide-card:active {
            cursor: grabbing;
        }

        /* אזור עריכה */
        .slide-canvas {
            background: white;
            aspect-ratio: 16/9;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        /* מסך טעינה */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* כפתורים מעוצבים */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid #667eea;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* טוסט התראה */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
            min-width: 200px;
        }

        .toast.success {
            border-right: 4px solid #10b981;
        }

        .toast.error {
            border-right: 4px solid #ef4444;
        }
        .toast.info {
            border-right: 4px solid #3b82f6;
        }


        /* עיצוב שקף */
        .slide-layout-standard .slide-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .slide-layout-centered {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .slide-layout-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        /* אפקטים מיוחדים */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* רספונסיביות */
        /* שיפור רספונסיביות לכל גדלי מסך */
    @media (max-width: 1400px) {
        .main-container {
            padding: 1rem;
        }
        
        .slide-canvas {
            max-width: 90%;
        }
    }

    @media (max-width: 1024px) {
        .editor-container {
            flex-direction: column;
        }
        
        .slides-sidebar {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .slide-editor {
            width: 100%;
        }
        
        .toolbar {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .toolbar button {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
    }

    @media (max-width: 768px) {
        .slide-canvas {
            max-width: 100%;
            height: auto;
            aspect-ratio: 16/9;
        }
        
        .modal-content {
            width: 95%;
            max-width: none;
            margin: 1rem;
        }
        
        .header {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }
        
        .header-title {
            font-size: 1.5rem;
        }
        
        .btn-group {
            flex-wrap: wrap;
            width: 100%;
        }
        
        .btn-group button {
            flex: 1;
            min-width: 120px;
        }
    }

    @media (max-width: 480px) {
        .header-title {
            font-size: 1.25rem;
        }
        
        .toolbar {
            flex-direction: column;
        }
        
        .toolbar button {
            width: 100%;
        }
        
        .notification {
            width: 95%;
            font-size: 0.875rem;
        }
    }

    /* שיפור תצוגת הודעות */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 400px;
        min-width: 300px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        font-size: 1rem;
        line-height: 1.5;
    }

    .notification.success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .notification.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }


        /* עיצובים דינמיים */
        .pattern-dots {
            background-image: radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .pattern-grid {
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .pattern-diagonal {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.03) 10px,
                rgba(0,0,0,0.03) 20px
            );
        }

        /* תוכן שקף ניתן לעריכה */
        [contenteditable]:focus {
            outline: 2px solid #667eea;
            outline-offset: 4px;
            border-radius: 4px;
        }

        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
        }

        /* טיפ-טול */
        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 8px;
        }

        /* סגנון מודאל */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
        }

        /* גלריית תבניות */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .template-card {
            aspect-ratio: 16/9;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            min-height: 140px;
        }

        .template-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .template-card.selected {
            border-color: #667eea;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
        }

        .slide-thumbnail {
            padding: 20px;
            border-radius: 12px;
            min-height: 150px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .slide-thumbnail:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .slide-thumbnail.active {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.3);
        }

    </style>
</head>
<body>

    <!-- חלון טעינה -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-[9999]" style="display: none;">
        <div class="bg-white rounded-2xl p-8 shadow-2xl text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
            <p id="loadingText" class="text-xl font-bold text-gray-800">טוען...</p>
        </div>
    </div>

    <!-- מסך התחלה -->
    <div id="welcomeScreen" class="fixed inset-0 bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-600 flex items-center justify-center z-50">
        <div class="text-center text-white max-w-3xl px-8">
            <div class="mb-8">
                <div class="inline-flex items-center justify-center w-24 h-24 bg-white bg-opacity-20 backdrop-blur-lg rounded-3xl mb-6">
                    <i class="fas fa-wand-magic-sparkles text-5xl"></i>
                </div>
                <h1 class="text-6xl font-black mb-4 animate-pulse">SlideGenius AI Pro</h1>
                <p class="text-2xl font-light opacity-90">מחולל מצגות מתקדם עם בינה מלאכותית</p>
            </div>
            
            <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-rocket ml-2"></i>
                    איך תרצה להתחיל?
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <button onclick="app.ui.startWithAI()" 
                            class="bg-white text-purple-600 px-8 py-6 rounded-xl font-bold text-xl hover:bg-opacity-90 transition transform hover:scale-105 shadow-xl">
                        <i class="fas fa-sparkles text-3xl mb-2 block"></i>
                        צור מצגת עם AI
                    </button>
                    
                    <button onclick="app.ui.startManual()" 
                            class="bg-white bg-opacity-20 text-white border-2 border-white px-8 py-6 rounded-xl font-bold text-xl hover:bg-opacity-30 transition transform hover:scale-105">
                        <i class="fas fa-pen text-3xl mb-2 block"></i>
                        צור מצגת ידנית
                    </button>
                </div>
                
                <button onclick="app.ui.showPresentationsHistory()" 
                        class="bg-indigo-500 bg-opacity-80 text-white px-6 py-3 rounded-xl font-semibold hover:bg-opacity-100 transition">
                    <i class="fas fa-history ml-2"></i>
                    היסטוריית מצגות
                </button>
            </div>
            
            <div class="flex items-center justify-center gap-8 text-sm opacity-75">
                <div class="flex items-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    <span>יצירה מהירה</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    <span>עיצוב מתקדם</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    <span>ייצוא PPTX</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" style="display: none;">
        <!-- Header -->
        <header class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-2xl sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="bg-white bg-opacity-20 backdrop-blur-lg p-3 rounded-2xl">
                            <i class="fas fa-wand-magic-sparkles text-3xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-black">SlideGenius AI Pro</h1>
                            <p class="text-sm opacity-90">מחולל מצגות מתקדם עם בינה מלאכותית</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <button onclick="app.ui.createNewPresentation()" 
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-3 rounded-xl font-semibold transition flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            <span>מצגת חדשה</span>
                        </button>
                        
                        <button onclick="app.export.exportToPptx()" 
                                class="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-xl font-semibold transition flex items-center gap-2 shadow-lg">
                            <i class="fas fa-download"></i>
                            <span>ייצוא PPTX</span>
                        </button>
                        
                        <button onclick="app.ui.toggleSettings()" 
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 p-3 rounded-xl transition">
                            <i class="fas fa-cog text-xl"></i>
                        </button>
                        
                        <div id="apiKeyStatus" class="flex items-center gap-2 bg-white bg-opacity-20 px-4 py-2 rounded-xl">
                            <i class="fas fa-circle-check text-green-400"></i>
                            <span class="text-sm font-medium">מפתח API מזוהר</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto px-6 py-8">
            <div class="grid grid-cols-12 gap-6">
                
                <!-- Right Sidebar - Thumbnails -->
                <div class="col-span-12 lg:col-span-3">
                    <div class="bg-white rounded-2xl shadow-xl p-6 sticky top-24">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">השקפים שלי</h3>
                            <span id="slideCount" class="bg-purple-100 text-purple-600 px-4 py-2 rounded-full font-bold">0</span>
                        </div>
                        
                        <div class="space-y-3 mb-4">
                            <button onclick="app.slides.addSlide()" 
                                    class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-6 py-4 rounded-xl font-bold hover:shadow-lg transition transform hover:scale-105 flex items-center justify-center gap-2">
                                <i class="fas fa-plus text-xl"></i>
                                <span>הוסף שקף</span>
                            </button>
                            
                            <button onclick="app.slides.refreshView()" 
                                    class="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-200 transition flex items-center justify-center gap-2">
                                <i class="fas fa-sync-alt"></i>
                                <span>רענן תצוגה</span>
                            </button>
                            
                            <button onclick="app.history.undo()" 
                                    class="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-200 transition flex items-center justify-center gap-2">
                                <i class="fas fa-undo"></i>
                                <span>בטל פעולה</span>
                            </button>
                        </div>
                        
                        <div id="slideThumbnails" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Thumbnails will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Center - Current Slide -->
                <div class="col-span-12 lg:col-span-6">
                    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                        <!-- Toolbar -->
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 border-b-2 flex flex-wrap gap-3 justify-center items-center">
                            
                            <button onclick="app.ui.showAIRefinementModal()" 
                                    class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition flex items-center gap-2">
                                <i class="fas fa-wand-magic-sparkles"></i>
                                <span>שפר מצגת</span>
                            </button>
                            
                            <button onclick="app.ui.showTemplateGallery()" 
                                    class="bg-blue-50 text-blue-600 border-2 border-blue-200 px-4 py-2 rounded-xl hover:bg-blue-100 transition font-semibold flex items-center gap-2">
                                <i class="fas fa-palette"></i>
                                <span>תבניות</span>
                            </button>
                            
                            <button onclick="app.ui.showTextSummaryModal()" 
                                    class="bg-purple-50 text-purple-600 border-2 border-purple-200 px-4 py-2 rounded-xl hover:bg-purple-100 transition font-semibold flex items-center gap-2">
                                <i class="fas fa-file-alt"></i>
                                <span>שמלל</span>
                            </button>
                            
                            <button onclick="app.ui.showImageModal()" 
                                    class="bg-green-50 text-green-600 border-2 border-green-200 px-4 py-2 rounded-xl hover:bg-green-100 transition font-semibold flex items-center gap-2">
                                <i class="fas fa-image"></i>
                                <span>תמונה</span>
                            </button>
                            
                            <button onclick="app.ui.showSmartEditor()" 
                                    class="bg-orange-50 text-orange-600 border-2 border-orange-200 px-4 py-2 rounded-xl hover:bg-orange-100 transition font-semibold flex items-center gap-2">
                                <i class="fas fa-edit"></i>
                                <span>עריכה חכמה</span>
                            </button>
                            
                            <button onclick="app.slides.duplicateSlide()" 
                                    class="bg-indigo-50 text-indigo-600 border-2 border-indigo-200 px-4 py-2 rounded-xl hover:bg-indigo-100 transition font-semibold flex items-center gap-2">
                                <i class="fas fa-copy"></i>
                                <span>שכפל דקות</span>
                            </button>
                            
                        </div>
                        
                        <!-- Slide Display -->
                        <div id="currentSlideDisplay" class="p-8 min-h-96 flex items-center justify-center bg-gray-50">
                            <div class="text-center text-gray-400">
                                <i class="fas fa-file-powerpoint text-6xl mb-4 opacity-50"></i>
                                <p class="text-2xl font-bold">אין שקפים עדיין</p>
                                <p class="text-lg mt-2">צור מצגת חדשה כדי להתחיל</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Left Sidebar - Slide Editor -->
                <div class="col-span-12 lg:col-span-3">
                    <div class="bg-white rounded-2xl shadow-xl p-6 sticky top-24">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-edit text-purple-600"></i>
                            <span>עורך שקף</span>
                        </h3>
                        
                        <div id="slideEditor" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">בחר שקף לעריכה</p>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Modal: הגדרות -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-cog"></i> הגדרות מערכת
                </h3>
                <button onclick="app.ui.toggleSettings()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-key ml-2 text-purple-600"></i>
                        Gemini API Key
                    </label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" 
                               class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-purple-300 focus:border-purple-500 text-lg" 
                               placeholder="הדבק את המפתח שלך כאן...">
                        <button onclick="app.settings.saveApiKey()" 
                                class="absolute left-2 top-2 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
                            שמור
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-info-circle ml-1"></i>
                        המפתח נשמר מקומית בדפדפן שלך בלבד - אין העברה לשרת
                    </p>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                       class="text-sm text-purple-600 hover:text-purple-800 font-medium mt-2 inline-block">
                        <i class="fas fa-external-link-alt ml-1"></i>
                        קבל מפתח API בחינם מ-Google
                    </a>
                </div>

                <div class="border-t-2 pt-6">
                    <button onclick="app.settings.clearAllData()" 
                            class="w-full bg-red-50 text-red-600 border-2 border-red-200 px-4 py-3 rounded-xl hover:bg-red-100 transition font-semibold">
                        <i class="fas fa-trash-alt ml-2"></i>
                        מחק את כל הנתונים ואפס את המערכת
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: יצירת מצגת עם AI -->
    <div id="aiPromptModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-wand-magic-sparkles"></i> צור מצגת עם AI
                </h3>
                <button onclick="app.ui.closeAIPromptModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-lightbulb ml-2 text-yellow-500"></i>
                        תאר את המצגת שהיית רוצה ליצור...
                    </label>
                    <textarea id="aiPromptInput" 
                              class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-purple-300 focus:border-purple-500 text-lg min-h-32" 
                              placeholder="לדוגמה: מצגת על יתרונות הבינה המלאכותית בעולם העסקים עם 5 שקפים"></textarea>
                </div>
                
                <!-- הוספת אפשרות להעלאת קבצים -->
                <div>
                    <label class="block text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-upload ml-2 text-indigo-600"></i>
                        העלה קבצים (אופציונלי)
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-purple-500 transition cursor-pointer"
                         onclick="document.getElementById('fileUploadInput').click()">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">לחץ להעלאת קבצים או גרור לכאן</p>
                        <p class="text-sm text-gray-500 mt-2">תומך בתמונות, PDF, Word, PowerPoint, Excel ועוד</p>
                        <input type="file" id="fileUploadInput" multiple accept="image/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt" 
                               style="display: none;" onchange="app.ai.handleFileUpload(event)">
                    </div>
                    <div id="uploadedFilesList" class="mt-3 space-y-2">
                        <!-- Uploaded files will appear here -->
                    </div>
                </div>
                
                <button onclick="app.ai.generateFromPrompt()" 
                        class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-8 py-4 rounded-xl font-bold text-xl hover:shadow-lg transition transform hover:scale-105">
                    <i class="fas fa-sparkles ml-2"></i>
                    צור מצגת מדהימה!
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: תיקון מצגת עם AI -->
    <div id="aiRefinementModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-magic"></i> תקן ושפר את המצגת
                </h3>
                <button onclick="app.ui.closeAIRefinementModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-comment-dots ml-2 text-indigo-600"></i>
                        מה תרצה לשנות או לשפר במצגת?
                    </label>
                    <textarea id="refinementPromptInput" 
                              class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-indigo-300 focus:border-indigo-500 text-lg min-h-32" 
                              placeholder="לדוגמה: הוסף עוד דוגמאות, שנה את הצבעים לכחול, הוסף גרפים וסטטיסטיקות"></textarea>
                </div>
                
                <div id="refinementHistory" class="border-2 border-gray-200 rounded-xl p-4 max-h-40 overflow-y-auto bg-gray-50">
                    <p class="text-gray-500 text-sm text-center">היסטוריית תיקונים תופיע כאן</p>
                </div>
                
                <button onclick="app.ai.refinePresentation()" 
                        class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-8 py-4 rounded-xl font-bold text-xl hover:shadow-lg transition transform hover:scale-105">
                    <i class="fas fa-wand-sparkles ml-2"></i>
                    שפר את המצגת!
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: היסטוריית מצגות -->
    <div id="presentationsHistoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-history"></i> היסטוריית מצגות
                </h3>
                <button onclick="app.ui.closePresentationsHistory()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8">
                <div id="presentationsHistoryList" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- History items will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- מודאל גלריית תבניות -->
    <div id="templateModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl">גלריית תבניות עיצוב</h3>
                <button onclick="app.ui.closeTemplateGallery()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="templateGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                    <!-- Templates will be inserted here -->
                </div>
                <div class="flex gap-3">
                    <button onclick="app.ui.applyRandomDesignToAll()" 
                            class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition">
                        החל עיצוב אקראי לכל השקפים
                    </button>
                    <button onclick="app.ui.applyRandomStyleToAll()" 
                            class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-lg transition">
                        החל סגנון אקראי לכל השקפים
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודאל סיכום טקסט -->
    <div id="summaryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl">סיכום טקסט חכם</h3>
                <button onclick="app.ui.closeSummaryModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <textarea id="textToSummarize" 
                          class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-blue-300 min-h-48 mb-4" 
                          placeholder="הדבק כאן טקסט ארוך לסיכום..."></textarea>
                <button onclick="app.ai.summarizeText()" 
                        class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition">
                    סכם והוסף לשקף
                </button>
            </div>
        </div>
    </div>

    <!-- מודאל הוספת תמונה -->
    <div id="imageModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl">הוסף תמונה</h3>
                <button onclick="app.ui.closeImageModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block font-semibold text-gray-800 mb-2">תאר את התמונה שאתה רוצה:</label>
                    <input type="text" id="imagePromptInput" 
                           class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-green-300" 
                           placeholder="לדוגמה: נוף של הרים מושלגים בשקיעה">
                </div>
                <button onclick="app.ai.generateAndAddImage()" 
                        class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition">
                    צור והוסף תמונה
                </button>
            </div>
        </div>
    </div>

    <!-- מודאל עורך חכם -->
    <div id="smartEditorModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl">עורך חכם</h3>
                <button onclick="app.ui.closeSmartEditor()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6" id="smartEditorContent">
                <!-- Smart editor controls will be inserted here -->
            </div>
        </div>
    </div>

    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // ========================================
        // Core Data & Utilities
        // ========================================

        class Utils {
            static generateId() {
                return 'slide-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }

            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
             static getContrastColor(hexcolor) {
                if (!hexcolor || hexcolor === 'transparent') return '#000000';
                hexcolor = hexcolor.replace("#", "");
                if (hexcolor.length === 3) {
                    hexcolor = hexcolor[0] + hexcolor[0] + hexcolor[1] + hexcolor[1] + hexcolor[2] + hexcolor[2];
                }
                const r = parseInt(hexcolor.substr(0, 2), 16);
                const g = parseInt(hexcolor.substr(2, 2), 16);
                const b = parseInt(hexcolor.substr(4, 2), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#000000' : '#ffffff';
            }
            
            static escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ========================================
        // Advanced Design System - 100+ Options
        // ========================================
        class AdvancedDesignSystem {
            constructor() {
                
                this.fonts = [
                    'Rubik', 'Assistant', 'Heebo', 'Alef', 'David Libre',
                    'Secular One', 'Varela Round', 'Noto Sans Hebrew',
                    'Amatic SC', 'Frank Ruhl Libre', 'Gverets',
                    'Arial', 'Georgia', 'Courier New', 'Trebuchet MS',
                    'Verdana', 'Times New Roman', 'Comic Sans MS', 'Impact', 'Tahoma',
                    // הוספת גופנים נוספים
                    'Open Sans', 'Roboto', 'Lato', 'Montserrat', 'Oswald',
                    'Source Sans Pro', 'Raleway', 'PT Sans', 'Merriweather',
                    'Ubuntu', 'Playfair Display', 'Poppins', 'Nunito', 'Cabin',
                    // Added fonts from updates
                    'Miriam Libre', 'Suez One', 'Bellefair', 'Arimo', 'Noto Serif Hebrew', 'Tinos', 'Arimo Hebrew', 'Cousine', 'Karantina'
                ];
                
                this.colorSchemes = [
                    { name: 'Ocean', colors: ['#1e3a8a', '#3b82f6', '#60a5fa', '#93c5fd', '#dbeafe'] },
                    { name: 'Sunset', colors: ['#7c2d12', '#ea580c', '#fb923c', '#fdba74', '#fed7aa'] },
                    { name: 'Forest', colors: ['#14532d', '#16a34a', '#4ade80', '#86efac', '#d1fae5'] },
                    { name: 'Royal', colors: ['#4c1d95', '#7c3aed', '#a78bfa', '#c4b5fd', '#ede9fe'] },
                    { name: 'Cherry', colors: ['#881337', '#e11d48', '#fb7185', '#fda4af', '#fecdd3'] },
                    { name: 'Ocean Blue', colors: ['#0c4a6e', '#0284c7', '#0ea5e9', '#38bdf8', '#7dd3fc'] },
                    { name: 'Emerald', colors: ['#064e3b', '#059669', '#10b981', '#34d399', '#6ee7b7'] },
                    { name: 'Amber', colors: ['#78350f', '#d97706', '#f59e0b', '#fbbf24', '#fcd34d'] },
                    { name: 'Purple', colors: ['#581c87', '#9333ea', '#a855f7', '#c084fc', '#e9d5ff'] },
                    { name: 'Pink', colors: ['#831843', '#db2777', '#ec4899', '#f472b6', '#fbcfe8'] },
                    { name: 'Teal', colors: ['#134e4a', '#0f766e', '#14b8a6', '#2dd4bf', '#5eead4'] },
                    { name: 'Indigo', colors: ['#312e81', '#4f46e5', '#6366f1', '#818cf8', '#a5b4fc'] },
                    { name: 'Rose', colors: ['#881337', '#e11d48', '#f43f5e', '#fb7185', '#fda4af'] },
                    { name: 'Cyan', colors: ['#164e63', '#0891b2', '#06b6d4', '#22d3ee', '#67e8f9'] },
                    { name: 'Lime', colors: ['#365314', '#65a30d', '#84cc16', '#a3e635', '#d9f99d'] },
                    { name: 'Fuchsia', colors: ['#701a75', '#c026d3', '#d946ef', '#e879f9', '#f5d0fe'] },
                    { name: 'Slate', colors: ['#1e293b', '#475569', '#64748b', '#94a3b8', '#cbd5e1'] },
                    { name: 'Stone', colors: ['#292524', '#57534e', '#78716c', '#a8a29e', '#d6d3d1'] },
                    { name: 'Zinc', colors: ['#27272a', '#52525b', '#71717a', '#a1a1aa', '#d4d4d8'] },
                    { name: 'Neutral', colors: ['#262626', '#525252', '#737373', '#a3a3a3', '#d4d4d4'] },
                    { name: 'Warm', colors: ['#92400e', '#d97706', '#f59e0b', '#fbbf24', '#fde68a'] },
                    { name: 'Cool', colors: ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd', '#dbeafe'] },
                    { name: 'Monochrome', colors: ['#000000', '#404040', '#808080', '#c0c0c0', '#ffffff'] },
                    { name: 'Pastel', colors: ['#fef3c7', '#fde68a', '#fcd34d', '#fbbf24', '#f59e0b'] },
                    { name: 'Vibrant', colors: ['#dc2626', '#ea580c', '#f59e0b', '#84cc16', '#10b981'] },
                    // הוספת ערכות צבעים נוספים
                    { name: 'Midnight', colors: ['#0f172a', '#1e293b', '#334155', '#475569', '#64748b'] },
                    { name: 'Peach', colors: ['#fed7aa', '#fdba74', '#fb923c', '#f97316', '#ea580c'] },
                    { name: 'Lavender', colors: ['#f3e8ff', '#e9d5ff', '#d8b4fe', '#c084fc', '#a855f7'] },
                    { name: 'Mint', colors: ['#d1fae5', '#a7f3d0', '#6ee7b7', '#34d399', '#10b981'] },
                    { name: 'Coral', colors: ['#fecaca', '#fca5a5', '#f87171', '#ef4444', '#dc2626'] },
                    { name: 'Sky', colors: ['#e0f2fe', '#bae6fd', '#7dd3fc', '#38bdf8', '#0ea5e9'] },
                    { name: 'Grape', colors: ['#ede9fe', '#ddd6fe', '#c4b5fd', '#a78bfa', '#8b5cf6'] },
                    { name: 'Lemon', colors: ['#fef9c3', '#fef08a', '#fde047', '#facc15', '#eab308'] },
                    { name: 'Salmon', colors: ['#ffe4e6', '#fecdd3', '#fda4af', '#fb7185', '#f43f5e'] },
                    { name: 'Turquoise', colors: ['#ccfbf1', '#99f6e4', '#5eead4', '#2dd4bf', '#14b8a6'] }
                ];
                
                this.backgroundPatterns = [
                    { id: 'none', style: 'none' },
                    { id: 'dots', style: 'radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px)', size: '20px 20px' },
                    { id: 'grid', style: 'linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px)', size: '20px 20px' },
                    { id: 'diagonal', style: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px)' },
                    { id: 'waves', style: 'repeating-radial-gradient(circle at 0 0, transparent 0, rgba(0,0,0,0.05) 10px, transparent 20px)' },
                    { id: 'zigzag', style: 'linear-gradient(135deg, rgba(0,0,0,0.05) 25%, transparent 25%), linear-gradient(225deg, rgba(0,0,0,0.05) 25%, transparent 25%)', size: '20px 20px' },
                    { id: 'cross', style: 'linear-gradient(rgba(0,0,0,0.1) 2px, transparent 2px), linear-gradient(90deg, rgba(0,0,0,0.1) 2px, transparent 2px)', size: '30px 30px' },
                    { id: 'hexagon', style: 'radial-gradient(circle at 50% 50%, rgba(0,0,0,0.05) 30%, transparent 31%)', size: '40px 40px' },
                    { id: 'triangles', style: 'linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.05) 75%), size: '30px 30px' },
                    { id: 'circles', style: 'radial-gradient(circle, rgba(0,0,0,0.05) 10%, transparent 11%)', size: '40px 40px' },
                    { id: 'stripes-v', style: 'linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.05) 50%)', size: '20px 20px' },
                    { id: 'stripes-h', style: 'linear-gradient(180deg, transparent 50%, rgba(0,0,0,0.05) 50%)', size: '20px 20px' },
                    { id: 'checkerboard', style: 'linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.05) 75%), linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.05) 75%)', size: '20px 20px', position: '0 0, 10px 10px' },
                    { id: 'polka', style: 'radial-gradient(circle, rgba(0,0,0,0.08) 25%, transparent 26%)', size: '30px 30px' },
                    { id: 'moroccan', style: 'radial-gradient(circle at 100% 150%, transparent 24%, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.05) 28%, transparent 29%, transparent 36%, rgba(0,0,0,0.05) 36%, rgba(0,0,0,0.05) 40%, transparent 40%, transparent), radial-gradient(circle at 0 150%, transparent 24%, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.05) 28%, transparent 29%, transparent 36%, rgba(0,0,0,0.05) 36%, rgba(0,0,0,0.05) 40%, transparent 40%, transparent)', size: '60px 60px' },
                    { id: 'bubbles', style: 'radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 5%, transparent 5%), radial-gradient(circle at 60% 70%, rgba(255,255,255,0.1) 8%, transparent 8%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 6%, transparent 6%)', size: '100px 100px' },
                    { id: 'carbon', style: 'linear-gradient(27deg, rgba(0,0,0,0.05) 5%, transparent 5%), linear-gradient(207deg, rgba(0,0,0,0.05) 5%, transparent 5%), linear-gradient(127deg, transparent 5%, rgba(0,0,0,0.05) 5%)', size: '10px 10px' },
                    { id: 'blueprint', style: 'linear-gradient(90deg, rgba(255,255,255,0.1) 2px, transparent 2px), linear-gradient(rgba(255,255,255,0.1) 2px, transparent 2px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px)', size: '100px 100px, 100px 100px, 20px 20px, 20px 20px', position: '-2px -2px, -2px -2px, -1px -1px, -1px -1px' },
                    { id: 'honeycomb', style: 'radial-gradient(circle farthest-side at 0% 50%, rgba(0,0,0,0) 23.5%, rgba(0,0,0,0.05) 0), radial-gradient(circle farthest-side at 0% 50%, rgba(0,0,0,0.05) 24%, rgba(0,0,0,0) 0)', size: '20px 20px' },
                    { id: 'stars', style: 'radial-gradient(2px 2px at 20px 30px, white, transparent), radial-gradient(2px 2px at 60px 70px, white, transparent), radial-gradient(1px 1px at 50px 50px, white, transparent)', size: '80px 80px' },
                    { id: 'diamond', style: 'linear-gradient(45deg, transparent 40%, rgba(0,0,0,0.05) 40%, rgba(0,0,0,0.05) 60%, transparent 60%), linear-gradient(-45deg, transparent 40%, rgba(0,0,0,0.05) 40%, rgba(0,0,0,0.05) 60%, transparent 60%)', size: '40px 40px' },
                    { id: 'brick', style: 'linear-gradient(335deg, rgba(0,0,0,0.05) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.05) 23px, transparent 23px), linear-gradient(335deg, transparent 23px, rgba(0,0,0,0.05) 23px), linear-gradient(155deg, transparent 23px, rgba(0,0,0,0.05) 23px)', size: '58px 58px' },
                    { id: 'weave', style: 'linear-gradient(135deg, rgba(0,0,0,0.02) 25%, transparent 25%), linear-gradient(225deg, rgba(0,0,0,0.02) 25%, transparent 25%), linear-gradient(45deg, rgba(0,0,0,0.02) 25%, transparent 25%), linear-gradient(315deg, rgba(0,0,0,0.02) 25%, transparent 25%)', size: '40px 40px' },
                    { id: 'plaid', style: 'repeating-linear-gradient(90deg, rgba(0,0,0,0.03), rgba(0,0,0,0.03) 1px, transparent 1px, transparent 20px), repeating-linear-gradient(0deg, rgba(0,0,0,0.03), rgba(0,0,0,0.03) 1px, transparent 1px, transparent 20px), repeating-linear-gradient(90deg, rgba(0,0,0,0.05), rgba(0,0,0,0.05) 2px, transparent 2px, transparent 60px), repeating-linear-gradient(0deg, rgba(0,0,0,0.05), rgba(0,0,0,0.05) 2px, transparent 2px, transparent 60px)' },
                    { id: 'argyle', style: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px), repeating-linear-gradient(-45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px)' },
                    { id: 'circuit', style: 'linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), radial-gradient(circle, rgba(0,0,0,0.1) 2px, transparent 3px)', size: '50px 50px, 50px 50px, 25px 25px' },
                    { id: 'plus', style: 'linear-gradient(rgba(0,0,0,0.05) 4px, transparent 4px), linear-gradient(90deg, rgba(0,0,0,0.05) 4px, transparent 4px)', size: '40px 40px', position: '-2px -2px' },
                    { id: 'herringbone', style: 'linear-gradient(45deg, transparent 45%, rgba(0,0,0,0.04) 45%, rgba(0,0,0,0.04) 55%, transparent 55%), linear-gradient(-45deg, transparent 45%, rgba(0,0,0,0.04) 45%, rgba(0,0,0,0.04) 55%, transparent 55%)', size: '20px 20px' },
                    { id: 'scales', style: 'radial-gradient(circle at 0% 50%, transparent 9px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 15px, transparent 16px), radial-gradient(circle at 100% 50%, transparent 9px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 15px, transparent 16px)', size: '40px 40px' },
                    { id: 'dots-3d', style: 'radial-gradient(ellipse at center, rgba(0,0,0,0.1) 0%, transparent 50%), radial-gradient(ellipse at center, rgba(255,255,255,0.2) 0%, transparent 50%)', size: '20px 20px', position: '0 0, 10px 10px' },
                    { id: 'rain', style: 'linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.02) 50%), linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.02) 50%), linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.02) 50%)', size: '2px 20px, 3px 30px, 4px 40px', position: '0 0, 10px 10px, 20px 0' },
                    { id: 'bamboo', style: 'repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(0,0,0,0.03) 40px, rgba(0,0,0,0.03) 44px), repeating-linear-gradient(0deg, transparent, transparent 4px, rgba(0,0,0,0.02) 4px, rgba(0,0,0,0.02) 8px)' },
                    { id: 'triangles-3d', style: 'linear-gradient(30deg, rgba(0,0,0,0.04) 12%, transparent 12.5%, transparent 87%, rgba(0,0,0,0.04) 87.5%, rgba(0,0,0,0.04)), linear-gradient(150deg, rgba(0,0,0,0.04) 12%, transparent 12.5%, transparent 87%, rgba(0,0,0,0.04) 87.5%, rgba(0,0,0,0.04))', size: '60px 60px' },
                    { id: 'cubes', style: 'linear-gradient(30deg, transparent 40%, rgba(0,0,0,0.05) 40%, rgba(0,0,0,0.05) 60%, transparent 60%), linear-gradient(90deg, rgba(0,0,0,0.025) 50%, transparent 50%)', size: '60px 60px' },
                    { id: 'steps', style: 'repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px), repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(0deg, rgba(0,0,0,0.05) 1px, transparent 1px)', size: '20px 20px, 20px 20px, 10px 10px, 10px 10px' },
                    { id: 'diagonal-squares', style: 'linear-gradient(45deg, rgba(0,0,0,0.03) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.03) 75%, rgba(0,0,0,0.03)), linear-gradient(-45deg, rgba(0,0,0,0.03) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.03) 75%, rgba(0,0,0,0.03))', size: '40px 40px' },
                    { id: 'art-deco', style: 'linear-gradient(0deg, transparent 24%, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.05) 26%, transparent 27%, transparent 74%, rgba(0,0,0,0.05) 75%, rgba(0,0,0,0.05) 76%, transparent 77%), linear-gradient(90deg, transparent 24%, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.05) 26%, transparent 27%, transparent 74%, rgba(0,0,0,0.05) 75%, rgba(0,0,0,0.05) 76%, transparent 77%)', size: '50px 50px' },
                    { id: 'fan', style: 'repeating-conic-gradient(from 0deg at 50% 50%, rgba(0,0,0,0.05) 0deg, transparent 5deg, transparent 10deg, rgba(0,0,0,0.05) 15deg)' },
                    { id: 'paper', style: 'repeating-linear-gradient(0deg, transparent, transparent 29px, rgba(0,0,0,0.03) 29px, rgba(0,0,0,0.03) 30px), repeating-linear-gradient(90deg, rgba(0,0,0,0.02) 0, rgba(0,0,0,0.02) 1px, transparent 1px, transparent)' },
                    { id: 'sunburst', style: 'repeating-conic-gradient(from 0deg at 50% 50%, transparent 0deg 3deg, rgba(0,0,0,0.03) 3deg 6deg)' }
                ];
                
                this.textStyles = [
                    { id: 'bold', weight: 'bold', transform: 'none', decoration: 'none' },
                    { id: 'italic', weight: 'normal', transform: 'none', decoration: 'none', style: 'italic' },
                    { id: 'uppercase', weight: 'bold', transform: 'uppercase', decoration: 'none' },
                    { id: 'underline', weight: 'normal', transform: 'none', decoration: 'underline' },
                    { id: 'shadow', weight: 'bold', transform: 'none', decoration: 'none', shadow: '2px 2px 4px rgba(0,0,0,0.3)' },
                    { id: 'outline', weight: 'bold', transform: 'none', decoration: 'none', outline: '2px' },
                    { id: 'glow', weight: 'bold', transform: 'none', decoration: 'none', textShadow: '0 0 10px currentColor' },
                    { id: '3d', weight: 'bold', transform: 'none', decoration: 'none', textShadow: '1px 1px 0 rgba(0,0,0,0.2), 2px 2px 0 rgba(0,0,0,0.2), 3px 3px 0 rgba(0,0,0,0.2)' },
                    { id: 'neon', weight: 'bold', transform: 'none', decoration: 'none', textShadow: '0 0 5px currentColor, 0 0 10px currentColor, 0 0 15px currentColor' },
                    { id: 'retro', weight: '900', transform: 'uppercase', decoration: 'none', letterSpacing: '0.2em' },
                    // הוספת סגנונות טקסט נוספים
                    { id: 'gradient-text', weight: 'bold', transform: 'none', decoration: 'none', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                    { id: 'embossed', weight: 'bold', transform: 'none', decoration: 'none', textShadow: '-1px -1px 0 rgba(255,255,255,0.3), 1px 1px 0 rgba(0,0,0,0.8)' },
                    { id: 'double-shadow', weight: 'bold', transform: 'none', decoration: 'none', textShadow: '3px 3px 0 rgba(0,0,0,0.2), 6px 6px 0 rgba(0,0,0,0.1)' },
                    { id: 'stroke', weight: 'bold', transform: 'none', decoration: 'none', webkitTextStroke: '1px rgba(0,0,0,0.5)' }
                ];
                
                this.borderStyles = [
                    { id: 'none', width: '0', style: 'none', color: 'transparent', radius: '0' },
                    { id: 'solid', width: '2px', style: 'solid', radius: '8px' },
                    { id: 'dashed', width: '2px', style: 'dashed', radius: '8px' },
                    { id: 'dotted', width: '2px', style: 'dotted', radius: '8px' },
                    { id: 'double', width: '4px', style: 'double', radius: '8px' },
                    { id: 'groove', width: '4px', style: 'groove', radius: '8px' },
                    { id: 'ridge', width: '4px', style: 'ridge', radius: '8px' },
                    { id: 'thick', width: '5px', style: 'solid', radius: '12px' },
                    { id: 'rounded', width: '2px', style: 'solid', radius: '20px' },
                    { id: 'pill', width: '2px', style: 'solid', radius: '9999px' },
                    // הוספת סגנונות מסגרת נוספים
                    { id: 'inset', width: '2px', style: 'inset', radius: '8px' },
                    { id: 'outset', width: '2px', style: 'outset', radius: '8px' },
                    { id: 'gradient-border', width: '3px', style: 'solid', radius: '12px', gradient: true }
                ];
                
                this.shadowStyles = [
                    { id: 'none', shadow: 'none' },
                    { id: 'sm', shadow: '0 1px 2px rgba(0,0,0,0.05)' },
                    { id: 'md', shadow: '0 4px 6px rgba(0,0,0,0.1)' },
                    { id: 'lg', shadow: '0 10px 15px rgba(0,0,0,0.1)' },
                    { id: 'xl', shadow: '0 20px 25px rgba(0,0,0,0.15)' },
                    { id: '2xl', shadow: '0 25px 50px rgba(0,0,0,0.25)' },
                    { id: 'inner', shadow: 'inset 0 2px 4px rgba(0,0,0,0.06)' },
                    { id: 'glow', shadow: '0 0 20px rgba(255,255,255,0.5)' },
                    { id: 'colored', shadow: '0 10px 30px rgba(139, 92, 246, 0.3)' },
                    { id: 'multi', shadow: '0 4px 6px rgba(0,0,0,0.1), 0 10px 15px rgba(0,0,0,0.1)' },
                    // הוספת סגנונות צל נוספים
                    { id: 'soft', shadow: '0 2px 15px rgba(0,0,0,0.08)' },
                    { id: 'hard', shadow: '10px 10px 0 rgba(0,0,0,0.2)' },
                    { id: 'neon-glow', shadow: '0 0 20px rgba(139, 92, 246, 0.6), 0 0 40px rgba(139, 92, 246, 0.4)' },
                    { id: 'elevated', shadow: '0 10px 40px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08)' }
                ];
                
                this.cornerStyles = [
                    { id: 'sharp', radius: '0' },
                    { id: 'sm', radius: '4px' },
                    { id: 'md', radius: '8px' },
                    { id: 'lg', radius: '12px' },
                    { id: 'xl', radius: '16px' },
                    { id: '2xl', radius: '24px' },
                    { id: 'full', radius: '9999px' },
                    { id: 'custom-tl', radiusTopLeft: '20px', radiusOther: '4px' },
                    // הוספת סגנונות פינה נוספים
                    { id: 'asymmetric', radiusTopLeft: '20px', radiusTopRight: '5px', radiusBottomRight: '20px', radiusBottomLeft: '5px' },
                    { id: 'top-round', radiusTopLeft: '20px', radiusTopRight: '20px', radiusBottomRight: '0', radiusBottomLeft: '0' },
                    { id: 'bottom-round', radiusTopLeft: '0', radiusTopRight: '0', radiusBottomRight: '20px', radiusBottomLeft: '20px' }
                ];
                
                this.layouts = [
                    { id: 'standard', name: 'Standard' },
                    { id: 'centered', name: 'Centered' },
                    { id: 'split', name: 'Split' },
                    { id: 'sidebar', name: 'Sidebar' },
                    { id: 'hero', name: 'Hero' },
                    { id: 'card', name: 'Card' },
                    { id: 'timeline', name: 'Timeline' },
                    { id: 'comparison', name: 'Comparison' },
                    // הוספת פריסות נוספות
                    { id: 'magazine', name: 'Magazine' },
                    { id: 'overlap', name: 'Overlap' },
                    { id: 'fullscreen', name: 'Fullscreen' },
                    { id: 'asymmetric', name: 'Asymmetric' }
                ];
                
                this.transitions = [
                    // Fade מעברים (5)
                    { id: 'fade', name: 'Fade', duration: '0.5s', css: 'opacity' },
                    { id: 'fade-slow', name: 'Fade Slow', duration: '1.5s', css: 'opacity' },
                    { id: 'fade-fast', name: 'Fade Fast', duration: '0.2s', css: 'opacity' },
                    { id: 'crossfade', name: 'Crossfade', duration: '0.8s', css: 'opacity' },
                    { id: 'fade-through-color', name: 'Fade Through Color', duration: '1s', css: 'opacity, background-color' },
                    
                    // Slide מעברים (10)
                    { id: 'slide-left', name: 'Slide Left', duration: '0.6s', css: 'transform: translateX(-100%)' },
                    { id: 'slide-right', name: 'Slide Right', duration: '0.6s', css: 'transform: translateX(100%)' },
                    { id: 'slide-up', name: 'Slide Up', duration: '0.6s', css: 'transform: translateY(-100%)' },
                    { id: 'slide-down', name: 'Slide Down', duration: '0.6s', css: 'transform: translateY(100%)' },
                    { id: 'slide-diagonal-tl', name: 'Slide Diagonal TL', duration: '0.7s', css: 'transform: translate(-100%, -100%)' },
                    { id: 'slide-diagonal-tr', name: 'Slide Diagonal TR', duration: '0.7s', css: 'transform: translate(100%, -100%)' },
                    { id: 'slide-diagonal-bl', name: 'Slide Diagonal BL', duration: '0.7s', css: 'transform: translate(-100%, 100%)' },
                    { id: 'slide-diagonal-br', name: 'Slide Diagonal BR', duration: '0.7s', css: 'transform: translate(100%, 100%)' },
                    { id: 'slide-bounce', name: 'Slide with Bounce', duration: '1s', css: 'transform' },
                    { id: 'slide-elastic', name: 'Slide Elastic', duration: '1.2s', css: 'transform' },
                    
                    // Push מעברים (4)
                    { id: 'push-left', name: 'Push Left', duration: '0.7s', css: 'transform' },
                    { id: 'push-right', name: 'Push Right', duration: '0.7s', css: 'transform' },
                    { id: 'push-up', name: 'Push Up', duration: '0.7s', css: 'transform' },
                    { id: 'push-down', name: 'Push Down', duration: '0.7s', css: 'transform' },
                    
                    // Zoom מעברים (8)
                    { id: 'zoom-in', name: 'Zoom In', duration: '0.6s', css: 'transform: scale(0)' },
                    { id: 'zoom-out', name: 'Zoom Out', duration: '0.6s', css: 'transform: scale(2)' },
                    { id: 'zoom-in-rotate', name: 'Zoom In Rotate', duration: '0.8s', css: 'transform: scale(0) rotate(-180deg)' },
                    { id: 'zoom-out-rotate', name: 'Zoom Out Rotate', duration: '0.8s', css: 'transform: scale(2) rotate(180deg)' },
                    { id: 'zoom-bounce', name: 'Zoom Bounce', duration: '1s', css: 'transform: scale' },
                    { id: 'zoom-fade', name: 'Zoom with Fade', duration: '0.7s', css: 'transform: scale, opacity' },
                    { id: 'zoom-blur', name: 'Zoom with Blur', duration: '0.8s', css: 'transform: scale, filter: blur' },
                    { id: 'zoom-center', name: 'Zoom from Center', duration: '0.6s', css: 'transform: scale' },
                    
                    // Rotate מעברים (6)
                    { id: 'rotate-in', name: 'Rotate In', duration: '0.7s', css: 'transform: rotate(-360deg)' },
                    { id: 'rotate-out', name: 'Rotate Out', duration: '0.7s', css: 'transform: rotate(360deg)' },
                    { id: 'rotate-flip', name: 'Rotate Flip', duration: '0.8s', css: 'transform: rotateY(180deg)' },
                    { id: 'rotate-3d', name: 'Rotate 3D', duration: '1s', css: 'transform: rotate3d(1, 1, 0, 180deg)' },
                    { id: 'rotate-cube', name: 'Rotate Cube', duration: '1s', css: 'transform: rotateY(90deg)' },
                    { id: 'rotate-carousel', name: 'Rotate Carousel', duration: '1.2s', css: 'transform: rotateY' },
                    
                    // Flip מעברים (6)
                    { id: 'flip-horizontal', name: 'Flip Horizontal', duration: '0.8s', css: 'transform: rotateY(180deg)' },
                    { id: 'flip-vertical', name: 'Flip Vertical', duration: '0.8s', css: 'transform: rotateX(180deg)' },
                    { id: 'flip-diagonal', name: 'Flip Diagonal', duration: '0.9s', css: 'transform: rotate3d(1, 1, 0, 180deg)' },
                    { id: 'flip-book', name: 'Flip Book', duration: '1s', css: 'transform: perspective, rotateY' },
                    { id: 'flip-card', name: 'Flip Card', duration: '0.8s', css: 'transform: rotateY(180deg)' },
                    { id: 'flip-cube-left', name: 'Flip Cube Left', duration: '1s', css: 'transform: rotateY(-90deg)' },
                    
                    // Wipe מעברים (4)
                    { id: 'wipe-left', name: 'Wipe Left', duration: '0.7s', css: 'clip-path' },
                    { id: 'wipe-right', name: 'Wipe Right', duration: '0.7s', css: 'clip-path' },
                    { id: 'wipe-up', name: 'Wipe Up', duration: '0.7s', css: 'clip-path' },
                    { id: 'wipe-down', name: 'Wipe Down', duration: '0.7s', css: 'clip-path' },
                    
                    // Special מעברים (7)
                    { id: 'curtain', name: 'Curtain', duration: '1s', css: 'clip-path' },
                    { id: 'door', name: 'Door', duration: '1s', css: 'transform: rotateY' },
                    { id: 'shutter', name: 'Shutter', duration: '0.8s', css: 'clip-path' },
                    { id: 'iris', name: 'Iris', duration: '0.8s', css: 'clip-path: circle' },
                    { id: 'mosaic', name: 'Mosaic', duration: '1s', css: 'opacity, transform' },
                    { id: 'glitch', name: 'Glitch', duration: '0.5s', css: 'transform, opacity' },
                    { id: 'pixelate', name: 'Pixelate', duration: '0.8s', css: 'filter' }
                ];
                
                this.animations = [
                    // Entrance הנפשות - Fade (10)
                    { id: 'fade-in', name: 'Fade In', type: 'entrance', duration: '0.5s' },
                    { id: 'fade-in-up', name: 'Fade In Up', type: 'entrance', duration: '0.6s' },
                    { id: 'fade-in-down', name: 'Fade In Down', type: 'entrance', duration: '0.6s' },
                    { id: 'fade-in-left', name: 'Fade In Left', type: 'entrance', duration: '0.6s' },
                    { id: 'fade-in-right', name: 'Fade In Right', type: 'entrance', duration: '0.6s' },
                    { id: 'fade-in-up-big', name: 'Fade In Up Big', type: 'entrance', duration: '0.8s' },
                    { id: 'fade-in-down-big', name: 'Fade In Down Big', type: 'entrance', duration: '0.8s' },
                    { id: 'fade-in-left-big', name: 'Fade In Left Big', type: 'entrance', duration: '0.8s' },
                    { id: 'fade-in-right-big', name: 'Fade In Right Big', type: 'entrance', duration: '0.8s' },
                    { id: 'fade-in-top-left', name: 'Fade In Top Left', type: 'entrance', duration: '0.7s' },
                    
                    // Entrance הנפשות - Zoom (10)
                    { id: 'zoom-in', name: 'Zoom In', type: 'entrance', duration: '0.5s' },
                    { id: 'zoom-in-up', name: 'Zoom In Up', type: 'entrance', duration: '0.6s' },
                    { id: 'zoom-in-down', name: 'Zoom In Down', type: 'entrance', duration: '0.6s' },
                    { id: 'zoom-in-left', name: 'Zoom In Left', type: 'entrance', duration: '0.6s' },
                    { id: 'zoom-in-right', name: 'Zoom In Right', type: 'entrance', duration: '0.6s' },
                    { id: 'zoom-out', name: 'Zoom Out', type: 'entrance', duration: '0.5s' },
                    { id: 'zoom-out-up', name: 'Zoom Out Up', type: 'entrance', duration: '0.6s' },
                    { id: 'zoom-out-down', name: 'Zoom Out Down', type: 'entrance', duration: '0.6s' },
                    { id: 'zoom-out-left', name: 'Zoom Out Left', type: 'entrance', duration: '0.6s' },
                    { id: 'zoom-out-right', name: 'Zoom Out Right', type: 'entrance', duration: '0.6s' },
                    
                    // Entrance הנפשות - Slide (10)
                    { id: 'slide-in-up', name: 'Slide In Up', type: 'entrance', duration: '0.6s' },
                    { id: 'slide-in-down', name: 'Slide In Down', type: 'entrance', duration: '0.6s' },
                    { id: 'slide-in-left', name: 'Slide In Left', type: 'entrance', duration: '0.6s' },
                    { id: 'slide-in-right', name: 'Slide In Right', type: 'entrance', duration: '0.6s' },
                    { id: 'slide-in-blurred-top', name: 'Slide In Blurred Top', type: 'entrance', duration: '0.8s' },
                    { id: 'slide-in-blurred-bottom', name: 'Slide In Blurred Bottom', type: 'entrance', duration: '0.8s' },
                    { id: 'slide-in-blurred-left', name: 'Slide In Blurred Left', type: 'entrance', duration: '0.8s' },
                    { id: 'slide-in-blurred-right', name: 'Slide In Blurred Right', type: 'entrance', duration: '0.8s' },
                    { id: 'slide-in-elliptic-top', name: 'Slide In Elliptic Top', type: 'entrance', duration: '0.7s' },
                    { id: 'slide-in-elliptic-bottom', name: 'Slide In Elliptic Bottom', type: 'entrance', duration: '0.7s' },
                    
                    // Entrance הנפשות - Rotate (10)
                    { id: 'rotate-in', name: 'Rotate In', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-up-left', name: 'Rotate In Up Left', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-up-right', name: 'Rotate In Up Right', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-down-left', name: 'Rotate In Down Left', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-down-right', name: 'Rotate In Down Right', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-center', name: 'Rotate In Center', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-2-cw', name: 'Rotate In 2 CW', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-2-ccw', name: 'Rotate In 2 CCW', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-diagonal-1', name: 'Rotate In Diagonal 1', type: 'entrance', duration: '0.6s' },
                    { id: 'rotate-in-diagonal-2', name: 'Rotate In Diagonal 2', type: 'entrance', duration: '0.6s' },
                    
                    // Entrance הנפשות - Flip (10)
                    { id: 'flip-in-hor-bottom', name: 'Flip In Horizontal Bottom', type: 'entrance', duration: '0.5s' },
                    { id: 'flip-in-hor-top', name: 'Flip In Horizontal Top', type: 'entrance', duration: '0.5s' },
                    { id: 'flip-in-ver-left', name: 'Flip In Vertical Left', type: 'entrance', duration: '0.5s' },
                    { id: 'flip-in-ver-right', name: 'Flip In Vertical Right', type: 'entrance', duration: '0.5s' },
                    { id: 'flip-in-diag-1-tl', name: 'Flip In Diagonal TL', type: 'entrance', duration: '0.6s' },
                    { id: 'flip-in-diag-1-tr', name: 'Flip In Diagonal TR', type: 'entrance', duration: '0.6s' },
                    { id: 'flip-in-diag-1-bl', name: 'Flip In Diagonal BL', type: 'entrance', duration: '0.6s' },
                    { id: 'flip-in-diag-1-br', name: 'Flip In Diagonal BR', type: 'entrance', duration: '0.6s' },
                    { id: 'flip-in-3d-hor', name: 'Flip In 3D Horizontal', type: 'entrance', duration: '0.7s' },
                    { id: 'flip-in-3d-ver', name: 'Flip In 3D Vertical', type: 'entrance', duration: '0.7s' },
                    
                    // Entrance הנפשות - Bounce (10)
                    { id: 'bounce-in', name: 'Bounce In', type: 'emphasis', duration: '0.8s' },
                    { id: 'bounce-in-up', name: 'Bounce In Up', type: 'emphasis', duration: '0.8s' },
                    { id: 'bounce-in-down', name: 'Bounce In Down', type: 'emphasis', duration: '0.8s' },
                    { id: 'bounce-in-left', name: 'Bounce In Left', type: 'emphasis', duration: '0.8s' },
                    { id: 'bounce-in-right', name: 'Bounce In Right', type: 'emphasis', duration: '0.8s' },
                    { id: 'bounce-in-fwd', name: 'Bounce In Forward', type: 'emphasis', duration: '1s' },
                    { id: 'bounce-in-bck', name: 'Bounce In Backward', type: 'emphasis', duration: '1s' },
                    { id: 'bounce-in-top', name: 'Bounce In Top', type: 'emphasis', duration: '1.1s' },
                    { id: 'bounce-in-bottom', name: 'Bounce In Bottom', type: 'emphasis', duration: '1.1s' },
                    { id: 'bounce-in-rotate', name: 'Bounce In Rotate', type: 'emphasis', duration: '1s' },
                    
                    // Entrance הנפשות - Roll (5)
                    { id: 'roll-in-left', name: 'Roll In Left', type: 'entrance', duration: '0.6s' },
                    { id: 'roll-in-right', name: 'Roll In Right', type: 'entrance', duration: '0.6s' },
                    { id: 'roll-in-top', name: 'Roll In Top', type: 'entrance', duration: '0.6s' },
                    { id: 'roll-in-bottom', name: 'Roll In Bottom', type: 'entrance', duration: '0.6s' },
                    { id: 'roll-in-blurred', name: 'Roll In Blurred', type: 'entrance', duration: '0.65s' },
                    
                    // Entrance הנפשות - Swing (5)
                    { id: 'swing-in-top-fwd', name: 'Swing In Top Forward', type: 'entrance', duration: '0.6s' },
                    { id: 'swing-in-top-bck', name: 'Swing In Top Backward', type: 'entrance', duration: '0.6s' },
                    { id: 'swing-in-bottom-fwd', name: 'Swing In Bottom Forward', type: 'entrance', duration: '0.6s' },
                    { id: 'swing-in-bottom-bck', name: 'Swing In Bottom Backward', type: 'entrance', duration: '0.6s' },
                    { id: 'swing-in-left', name: 'Swing In Left', type: 'entrance', duration: '0.7s' },
                    
                    // Entrance הנפשות - Scale (10)
                    { id: 'scale-in-center', name: 'Scale In Center', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-top', name: 'Scale In Top', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-bottom', name: 'Scale In Bottom', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-left', name: 'Scale In Left', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-right', name: 'Scale In Right', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-tl', name: 'Scale In Top Left', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-tr', name: 'Scale In Top Right', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-bl', name: 'Scale In Bottom Left', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-br', name: 'Scale In Bottom Right', type: 'entrance', duration: '0.5s' },
                    { id: 'scale-in-ver-center', name: 'Scale In Vertical Center', type: 'entrance', duration: '0.4s' },
                    
                    // Entrance הנפשות - Puff (5)
                    { id: 'puff-in-center', name: 'Puff In Center', type: 'entrance', duration: '0.7s' },
                    { id: 'puff-in-top', name: 'Puff In Top', type: 'entrance', duration: '0.7s' },
                    { id: 'puff-in-bottom', name: 'Puff In Bottom', type: 'entrance', duration: '0.7s' },
                    { id: 'puff-in-left', name: 'Puff In Left', type: 'entrance', duration: '0.7s' },
                    { id: 'puff-in-right', name: 'Puff In Right', type: 'entrance', duration: '0.7s' },
                    
                    // Entrance הנפשות - Blur (5)
                    { id: 'blur-in', name: 'Blur In', type: 'entrance', duration: '0.6s' },
                    { id: 'focus-in-expand', name: 'Focus In Expand', type: 'entrance', duration: '0.8s' },
                    { id: 'focus-in-contract', name: 'Focus In Contract', type: 'entrance', duration: '0.7s' },
                    { id: 'focus-in-contract-bck', name: 'Focus In Contract Backward', type: 'entrance', duration: '1s' },
                    { id: 'text-focus-in', name: 'Text Focus In', type: 'entrance', duration: '1s' },
                    
                    // Emphasis הנפשות - Pulse (10)
                    { id: 'pulse', name: 'Pulse', type: 'emphasis', duration: '0.5s' },
                    { id: 'pulse-grow', name: 'Pulse Grow', type: 'emphasis', duration: '0.6s' },
                    { id: 'pulse-shrink', name: 'Pulse Shrink', type: 'emphasis', duration: '0.6s' },
                    { id: 'heartbeat', name: 'Heartbeat', type: 'emphasis', duration: '1.3s' },
                    { id: 'pulsate', name: 'Pulsate', type: 'emphasis', duration: '1.5s' },
                    { id: 'pulsate-fwd', name: 'Pulsate Forward', type: 'emphasis', duration: '0.5s' },
                    { id: 'pulsate-bck', name: 'Pulsate Backward', type: 'emphasis', duration: '0.5s' },
                    { id: 'beat-fade', name: 'Beat Fade', type: 'emphasis', duration: '1s' },
                    { id: 'scale-pulse', name: 'Scale Pulse', type: 'emphasis', duration: '0.8s' },
                    { id: 'glow', name: 'Glow', type: 'emphasis', duration: '0.5s' },
                    
                    // Emphasis הנפשות - Shake (10)
                    { id: 'shake', name: 'Shake', type: 'emphasis', duration: '0.8s' },
                    { id: 'shake-horizontal', name: 'Shake Horizontal', type: 'emphasis', duration: '0.8s' },
                    { id: 'shake-vertical', name: 'Shake Vertical', type: 'emphasis', duration: '0.8s' },
                    { id: 'shake-lr', name: 'Shake Left-Right', type: 'emphasis', duration: '0.6s' },
                    { id: 'shake-top', name: 'Shake Top', type: 'emphasis', duration: '0.8s' },
                    { id: 'shake-bottom', name: 'Shake Bottom', type: 'emphasis', duration: '0.8s' },
                    { id: 'shake-rotate', name: 'Shake Rotate', type: 'emphasis', duration: '0.6s' },
                    { id: 'shake-scale', name: 'Shake Scale', type: 'emphasis', duration: '0.6s' },
                    { id: 'vibrate', name: 'Vibrate', type: 'emphasis', duration: '0.3s' },
                    { id: 'jello', name: 'Jello', type: 'emphasis', duration: '0.9s' },
                    
                    // Emphasis הנפשות - Wobble (10)
                    { id: 'wobble', name: 'Wobble', type: 'emphasis', duration: '1s' },
                    { id: 'wobble-hor-bottom', name: 'Wobble Horizontal Bottom', type: 'emphasis', duration: '0.8s' },
                    { id: 'wobble-hor-top', name: 'Wobble Horizontal Top', type: 'emphasis', duration: '0.8s' },
                    { id: 'wobble-ver-left', name: 'Wobble Vertical Left', type: 'emphasis', duration: '0.8s' },
                    { id: 'wobble-ver-right', name: 'Wobble Vertical Right', type: 'emphasis', duration: '0.8s' },
                    { id: 'wobble-to-bottom-right', name: 'Wobble To Bottom Right', type: 'emphasis', duration: '0.8s' },
                    { id: 'wobble-to-top-right', name: 'Wobble To Top Right', type: 'emphasis', duration: '0.8s' },
                    { id: 'wobble-skew', name: 'Wobble Skew', type: 'emphasis', duration: '1s' },
                    { id: 'wobble-3d', name: 'Wobble 3D', type: 'emphasis', duration: '1.2s' },
                    { id: 'rubber-band', name: 'Rubber Band', type: 'emphasis', duration: '1s' },
                    
                    // Emphasis הנפשות - Blink (5)
                    { id: 'blink', name: 'Blink', type: 'emphasis', duration: '0.9s' },
                    { id: 'blink-1', name: 'Blink 1', type: 'emphasis', duration: '0.5s' },
                    { id: 'blink-2', name: 'Blink 2', type: 'emphasis', duration: '0.9s' },
                    { id: 'flash', name: 'Flash', type: 'emphasis', duration: '0.5s' },
                    { id: 'flicker', name: 'Flicker', type: 'emphasis', duration: '2s' },
                    
                    // Emphasis הנפשות - Special (15)
                    { id: 'bounce', name: 'Bounce', type: 'emphasis', duration: '1s' },
                    { id: 'swing', name: 'Swing', type: 'emphasis', duration: '1s' },
                    { id: 'tada', name: 'Tada', type: 'emphasis', duration: '1s' },
                    { id: 'flip', name: 'Flip', type: 'emphasis', duration: '1s' },
                    { id: 'flip-2-hor-top', name: 'Flip 2 Horizontal Top', type: 'emphasis', duration: '0.6s' },
                    { id: 'flip-2-hor-bottom', name: 'Flip 2 Horizontal Bottom', type: 'emphasis', duration: '0.6s' },
                    { id: 'flip-2-ver-left', name: 'Flip 2 Vertical Left', type: 'emphasis', duration: '0.5s' },
                    { id: 'flip-2-ver-right', name: 'Flip 2 Vertical Right', type: 'emphasis', duration: '0.5s' },
                    { id: 'rotate-90-cw', name: 'Rotate 90° CW', type: 'emphasis', duration: '0.4s' },
                    { id: 'rotate-90-ccw', name: 'Rotate 90° CCW', type: 'emphasis', duration: '0.4s' },
                    { id: 'rotate-180-cw', name: 'Rotate 180° CW', type: 'emphasis', duration: '0.5s' },
                    { id: 'rotate-180-ccw', name: 'Rotate 180° CCW', type: 'emphasis', duration: '0.5s' },
                    { id: 'tilt', name: 'Tilt', type: 'emphasis', duration: '0.6s' },
                    { id: 'seesaw', name: 'Seesaw', type: 'emphasis', duration: '2s' },
                    { id: 'float', name: 'Float', type: 'emphasis', duration: '3s' }
                ];
                
                this.gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                    'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)',
                    'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)',
                    'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                    'linear-gradient(135deg, #fccb90 0%, #d57eeb 100%)',
                    'linear-gradient(135deg, #e8198b 0%, #c7eafd 100%)',
                    'linear-gradient(135deg, #96fbc4 0%, #f9f586 100%)',
                    // הוספת גרדיאנטים נוספים
                    'linear-gradient(135deg, #667eea 0%, #f093fb 50%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #43e97b 50%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 50%, #30cfd0 100%)',
                    'radial-gradient(circle, #667eea 0%, #764ba2 100%)',
                    'radial-gradient(circle, #f093fb 0%, #f5576c 100%)',
                    'conic-gradient(from 0deg, #667eea, #f093fb, #4facfe, #43e97b, #667eea)'
                ];
                
                this.imageStyles = [
                    { id: 'normal', filter: 'none', transform: 'none' },
                    { id: 'grayscale', filter: 'grayscale(100%)' },
                    { id: 'sepia', filter: 'sepia(80%)' },
                    { id: 'blur', filter: 'blur(2px)' },
                    { id: 'brightness', filter: 'brightness(1.2)' },
                    { id: 'contrast', filter: 'contrast(1.3)' },
                    { id: 'saturate', filter: 'saturate(1.5)' },
                    { id: 'hue-rotate', filter: 'hue-rotate(90deg)' },
                    { id: 'invert', filter: 'invert(100%)' }
                ];
                
                this.textDecorations = [
                    { id: 'none', decoration: 'none' },
                    { id: 'underline', decoration: 'underline' },
                    { id: 'overline', decoration: 'overline' },
                    { id: 'line-through', decoration: 'line-through' },
                    { id: 'wavy-underline', decoration: 'underline wavy' }
                ];
                
                this.contentAlignments = [
                    { id: 'left', align: 'flex-start' },
                    { id: 'center', align: 'center' },
                    { id: 'right', align: 'flex-end' },
                    { id: 'justify', align: 'space-between' }
                ];
                
                this.spacingOptions = [
                    { id: 'compact', padding: '10px', gap: '10px' },
                    { id: 'normal', padding: '20px', gap: '15px' },
                    { id: 'relaxed', padding: '30px', gap: '20px' },
                    { id: 'loose', padding: '40px', gap: '30px' }
                ];
            }
            
            getRandomFont() {
                return this.fonts[Math.floor(Math.random() * this.fonts.length)];
            }
            
            getRandomColorScheme() {
                return this.colorSchemes[Math.floor(Math.random() * this.colorSchemes.length)];
            }
            
            getRandomPattern() {
                return this.backgroundPatterns[Math.floor(Math.random() * this.backgroundPatterns.length)];
            }
            
            getRandomTextStyle() {
                return this.textStyles[Math.floor(Math.random() * this.textStyles.length)];
            }
            
            getRandomBorderStyle() {
                return this.borderStyles[Math.floor(Math.random() * this.borderStyles.length)];
            }
            
            getRandomShadowStyle() {
                return this.shadowStyles[Math.floor(Math.random() * this.shadowStyles.length)];
            }
            
            getRandomCornerStyle() {
                return this.cornerStyles[Math.floor(Math.random() * this.cornerStyles.length)];
            }
            
            getRandomLayout() {
                return this.layouts[Math.floor(Math.random() * this.layouts.length)];
            }
            
            getRandomTransition() {
                // Ensure only valid transitions are returned
                const validTransitions = this.transitions.filter(t => t.css && t.css !== 'transform'); // Exclude pure transform for now if causing issues
                return validTransitions[Math.floor(Math.random() * validTransitions.length)];
            }

            getRandomAnimation() {
                return this.animations[Math.floor(Math.random() * this.animations.length)];
            }
            
            getRandomGradient() {
                return this.gradients[Math.floor(Math.random() * this.gradients.length)];
            }

            getRandomImageStyle() {
                return this.imageStyles[Math.floor(Math.random() * this.imageStyles.length)];
            }
            
            getRandomTextDecoration() {
                return this.textDecorations[Math.floor(Math.random() * this.textDecorations.length)];
            }
            
            getRandomContentAlignment() {
                return this.contentAlignments[Math.floor(Math.random() * this.contentAlignments.length)];
            }
            
            getRandomSpacing() {
                return this.spacingOptions[Math.floor(Math.random() * this.spacingOptions.length)];
            }
            
            // פונקציה שמחזירה עיצוב רנדומלי מלא
            getFullRandomDesign() {
                const colorScheme = this.getRandomColorScheme();
                const pattern = this.getRandomPattern();
                const textStyle = this.getRandomTextStyle();
                const border = this.getRandomBorderStyle();
                const shadow = this.getRandomShadowStyle();
                const corner = this.getRandomCornerStyle();
                const layout = this.getRandomLayout();
                const animation = this.getRandomAnimation();
                const gradient = this.getRandomGradient();
                
                return {
                    font: this.getRandomFont(),
                    colorScheme: colorScheme,
                    backgroundColor: colorScheme.colors[0],
                    textColor: colorScheme.colors[4],
                    accentColor: colorScheme.colors[2],
                    pattern: pattern,
                    textStyle: textStyle,
                    border: border,
                    shadow: shadow,
                    corner: corner,
                    layout: layout,
                    animation: animation,
                    gradient: gradient
                };
            }
        }

        // ========================================
        // AI Manager
        // ========================================
        class AIManager {
            constructor() {
                this.apiKey = localStorage.getItem('gemini_api_key') || '';
                this.apiEndpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';
                this.uploadedFiles = [];
                this.refinementHistory = [];
                this.currentPresentationContext = null;
            }

            async callGemini(prompt, systemInstructions = '') {
                if (!this.apiKey) {
                    throw new Error('לא הוזן מפתח API. נא להזין מפתח API בהגדרות.');
                }

                const fullPrompt = systemInstructions ? `${systemInstructions}\n\n${prompt}` : prompt;

                try {
                    const response = await fetch(`${this.apiEndpoint}?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: fullPrompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.9,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 8192,
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('[v0] API Error:', errorData);
                        const errorMessage = errorData.error?.message || 'שגיאה בקריאה ל-API';
                        
                        if (response.status === 429) {
                            throw new Error('חרגת ממכסת השימוש ב-API. אנא בדוק את תוכנית ה-API שלך ב-Google AI Studio: https://aistudio.google.com/app/apikey');
                        }
                        
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error('[v0] Gemini Error:', error);
                    throw error;
                }
            }

            async handleFileUpload(event) {
                const files = Array.from(event.target.files);
                app.ui.showLoading(true, 'מעבד קבצים...');
                
                try {
                    for (const file of files) {
                        const fileData = await this.processFile(file);
                        this.uploadedFiles.push(fileData);
                    }
                    
                    this.updateUploadedFilesList();
                    app.ui.showLoading(false);
                    app.ui.showToast(`הועלו ${files.length} קבצים בהצלחה!`, 'success');
                } catch (error) {
                    app.ui.showLoading(false);
                    app.ui.showToast('שגיאה בהעלאת קבצים: ' + error.message, 'error');
                }
            }
            
            async processFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const result = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };
                        
                        // אם זה תמונה, שמור גם כ-base64
                        if (file.type.startsWith('image/')) {
                            result.isImage = true;
                            result.dataUrl = e.target.result;
                        } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                            result.isText = true;
                            result.textContent = e.target.result;
                        }
                        
                        resolve(result);
                    };
                    
                    reader.onerror = () => reject(new Error('שגיאה בקריאה הקובץ'));
                    
                    if (file.type.startsWith('image/')) {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                });
            }
            
            updateUploadedFilesList() {
                const list = document.getElementById('uploadedFilesList');
                if (!list) return;
                
                list.innerHTML = this.uploadedFiles.map((file, index) => `
                    <div class="flex items-center justify-between bg-gray-100 rounded-lg p-3">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-${file.isImage ? 'image' : 'file-alt'} text-indigo-600"></i>
                            <span class="text-sm font-medium">${file.name}</span>
                            <span class="text-xs text-gray-500">(${(file.size / 1024).toFixed(1)} KB)</span>
                        </div>
                        <button onclick="app.ai.removeUploadedFile(${index})" 
                                class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }
            
            removeUploadedFile(index) {
                this.uploadedFiles.splice(index, 1);
                this.updateUploadedFilesList();
            }

            async generateFromPrompt() {
                const promptInput = document.getElementById('aiPromptInput');
                const prompt = promptInput.value.trim();
                
                if (!prompt) {
                    app.ui.showToast('נא להזין תיאור למצגת', 'error');
                    return;
                }
                
                app.ui.closeAIPromptModal();
                app.ui.showLoading(true, 'יוצר מצגת מדהימה...');
                
                try {
                    let fullPrompt = prompt;
                    
                    if (this.uploadedFiles.length > 0) {
                        fullPrompt += '\n\nקבצים שהועלו:\n';
                        this.uploadedFiles.forEach(file => {
                            if (file.isText) {
                                fullPrompt += `\n--- ${file.name} ---\n${file.textContent}\n`;
                            } else if (file.isImage) {
                                fullPrompt += `\n--- תמונה: ${file.name} (ניתן להשתמש בה במצגת) ---\n`;
                            }
                        });
                    }
                    
                    await this.generateFullPresentation(fullPrompt);
                    
                    // שמירת הקונטקסט לתיקונים עתידיים
                    this.currentPresentationContext = {
                        originalPrompt: prompt,
                        uploadedFiles: [...this.uploadedFiles],
                        createdAt: new Date()
                    };
                    
                    // ניקוי קבצים שהועלו
                    this.uploadedFiles = [];
                    this.updateUploadedFilesList();
                    
                    app.ui.showLoading(false);
                    app.ui.showToast('המצגת נוצרה בהצלחה!', 'success');
                } catch (error) {
                    app.ui.showLoading(false);
                    const errorMsg = error.message.includes('חרגת ממכסת') 
                        ? error.message 
                        : `שגיאה ביצירת המצגת: ${error.message}`;
                    app.ui.showToast(errorMsg, 'error');
                }
            }

            async refinePresentation() {
                const refinementInput = document.getElementById('refinementPromptInput');
                const refinementPrompt = refinementInput.value.trim();
                
                if (!refinementPrompt) {
                    app.ui.showToast('נא להזין בקשת תיקון', 'error');
                    return;
                }
                
                if (app.slides.slides.length === 0) {
                    app.ui.showToast('אין מצגת לתיקון. צור מצגת תחילה.', 'error');
                    return;
                }
                
                app.ui.closeAIRefinementModal();
                app.ui.showLoading(true, 'משפר את המצגת...');
                
                try {
                    // שמירת המצגת הנוכחית
                    const currentSlides = JSON.stringify(app.slides.slides);
                    
                    const systemInstructions = `אתה עוזר AI מומחה בעיצוב מצגות.
המצגת הנוכחית היא:
${currentSlides}

המשתמש מבקש את התיקון הבא: ${refinementPrompt}

אנא צור מצגת מתוקנת בפורמט JSON עם המבנה הבא:
{
  "slides": [
    {
      "title": "כותרת השקף",
      "content": "תוכן השקף (יכול להכיל רשימות עם תווי - או מספרים)",
      "layout": "standard/centered/split",
      "style": {
        "backgroundColor": "#HEX_COLOR",
        "textColor": "#HEX_COLOR",
        "font": "שם פונט עברי",
        "pattern": "dots/grid/diagonal/none"
      },
      "imagePrompt": "תיאור תמונה רלוונטית (אופציונלי)"
    }
  ]
}

חשוב:
1. שמור על השקפים הקיימים אלא אם כן התבקש באופן מפורש לשנות אותם
2. החל את התיקונים המבוקשים
3. השתמש בעיצוב יפה ומקצועי
4. החזר ONLY את אובייקט ה-JSON, ללא טקסט נוסף`;

                    const response = await this.callGemini('', systemInstructions);
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    
                    if (!jsonMatch) {
                        throw new Error('לא התקבלה תגובה תקינה מה-AI');
                    }
                    
                    const presentationData = JSON.parse(jsonMatch[0]);
                    
                    // החלפת השקפים הנוכחיים בשקפים המתוקנים
                    app.slides.slides = [];
                    
                    for (const slideData of presentationData.slides) {
                        const slide = app.slides.createSlide(slideData.layout || 'standard');
                        slide.title = slideData.title || '';
                        slide.content = slideData.content || '';
                        
                        if (slideData.style) {
                            slide.style = { ...slide.style, ...slideData.style };
                        }
                        
                        // יצירת תמונה אם יש
                        if (slideData.imagePrompt) {
                            const imageUrl = await this.generateImage(slideData.imagePrompt);
                            slide.image = imageUrl;
                        }
                        
                        app.slides.slides.push(slide);
                    }
                    
                    app.slides.renderSlides();
                    
                    // שמירה בהיסטוריה
                    this.refinementHistory.push({
                        prompt: refinementPrompt,
                        timestamp: new Date()
                    });
                    this.updateRefinementHistory();
                    
                    // ניקוי השדה
                    refinementInput.value = '';
                    
                    app.ui.showLoading(false);
                    app.ui.showToast('המצגת שופרה בהצלחה!', 'success');
                } catch (error) {
                    app.ui.showLoading(false);
                    app.ui.showToast('שגיאה בשיפור המצגת: ' + error.message, 'error');
                }
            }
            
            updateRefinementHistory() {
                const historyContainer = document.getElementById('refinementHistory');
                if (!historyContainer) return;
                
                if (this.refinementHistory.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">היסטוריית תיקונים תופיע כאן</p>';
                    return;
                }
                
                historyContainer.innerHTML = this.refinementHistory.map((item, index) => `
                    <div class="text-sm mb-2 p-2 bg-white rounded border">
                        <strong>${index + 1}.</strong> ${item.prompt}
                        <span class="text-xs text-gray-500 block mt-1">${item.timestamp.toLocaleTimeString('he-IL')}</span>
                    </div>
                `).join('');
            }

            async generateImage(description) {
                // יצירת גרדיאנט דינמי מותאם אישית על פי התיאור
                const gradients = {
                    'טכנולוגיה': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'עסקים': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'חינוך': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'בריאות': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'טבע': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'אמנות': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    'מדע': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'ספורט': 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'מוסיקה': 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)',
                    'אוכל': 'linear-gradient(135deg, #fdcbf1 0%, #e6dee9 100%)',
                };

                // בחירת גרדיאנט על פי מילות מפתח בתיאור
                let selectedGradient = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                
                for (const [keyword, gradient] of Object.entries(gradients)) {
                    if (description.toLowerCase().includes(keyword.toLowerCase())) {
                        selectedGradient = gradient;
                        break;
                    }
                }

                return selectedGradient;
            }

            async generateImageForSlide(slideContent, index) {
                try {
                    // יצירת גרדיאנט מקומי במקום קריאה ל-API
                    const gradient = await this.generateImage(slideContent.title + ' ' + slideContent.content);
                    return gradient;
                } catch (error) {
                    console.error('[v0] Error generating gradient:', error);
                    return 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            }

            async summarizeText() {
                const textToSummarize = document.getElementById('textToSummarize').value.trim();
                
                if (!textToSummarize) {
                    app.ui.showToast('נא להזין טקסט לסיכום', 'error');
                    return;
                }
                
                app.ui.showLoading(true, 'מסכם טקסט...');
                
                try {
                    const prompt = `סכם את הטקסט הבא בצורה תמציתית לנקודות עיקריות (3-5 נקודות):\n\n${textToSummarize}`;
                    const summary = await this.callGemini(prompt);
                    
                    if (app.slides.currentSlideIndex !== -1) {
                        const slide = app.slides.slides[app.slides.currentSlideIndex];
                        slide.content = summary;
                        app.slides.renderSlides();
                        app.ui.closeSummaryModal();
                        app.ui.showToast('הסיכום נוסף לשקף!', 'success');
                    } else {
                        app.ui.showToast('בחר שקף להוספת הסיכום', 'error');
                    }
                    
                    app.ui.showLoading(false);
                } catch (error) {
                    app.ui.showLoading(false);
                    app.ui.showToast('שגיאה בסיכום הטקסט: ' + error.message, 'error');
                }
            }

            async generateAndAddImage() {
                const imagePrompt = document.getElementById('imagePromptInput').value.trim();
                
                if (!imagePrompt) {
                    app.ui.showToast('נא להזין תיאור לתמונה', 'error');
                    return;
                }
                
                if (app.slides.currentSlideIndex === -1) {
                    app.ui.showToast('בחר שקף להוספת התמונה', 'error');
                    return;
                }
                
                app.ui.showLoading(true, 'יוצר תמונה...');
                
                try {
                    const imageUrl = await this.generateImage(imagePrompt);
                    const slide = app.slides.slides[app.slides.currentSlideIndex];
                    slide.image = imageUrl;
                    app.slides.renderSlides();
                    app.ui.closeImageModal();
                    app.ui.showToast('התמונה נוספה לשקף!', 'success');
                    app.ui.showLoading(false);
                } catch (error) {
                    app.ui.showLoading(false);
                    app.ui.showToast('שגיאה ביצירת התמונה: ' + error.message, 'error');
                }
            }

            async generateFullPresentation(prompt) {
                const systemInstructions = `אתה עוזר AI מומחה בעיצוב מצגות מקצועיות ויפות.
            צור מצגת מדהימה ומעוצבת על פי הבקשה: ${prompt}

            אתה יכול להשתמש באפשרויות הבאות:
            - גופנים: Heebo, Rubik, Alef, Miriam Libre, Assistant, Frank Ruhl Libre, Varela Round, Amatic SC, Secular One, Suez One, Bellefair, Arimo, Noto Sans Hebrew, Open Sans Hebrew, David Libre, Karantina, Noto Serif Hebrew, Tinos, Arimo Hebrew, Cousine
            - צבעים: כל צבע HEX שתרצה
            - תבניות רקע: dots, grid, diagonal, waves, circles, hexagons, triangles, zigzag, stripes, checkerboard, gradientDots, spirals, stars, crosshatch, bricks, honeycomb, arrows, diamonds, scales, confetti, bubbles, mountains, clouds, sun, moon, lightning, heart, flower, leaf, tree, water, fire, snow, rain, wind, none
            - פריסות: standard (כותרת למעלה, תוכן באמצע), centered (כל הטקסט במרכז), split (חצי טקסט חצי תמונה)
            - מעברים בין שקפים: fade, slide, zoom, flip, rotate, cube, swipe, dissolve, push, cover, uncover, wipe, split, box, diamond, wheel, plus, wedge, convex, concave, fracture, crush, peel, reveal, expand, contract, origami, ripple, morph, glitch, pixelate, blur, flash, bounce, elastic, pulse, wave, spiral, explode, implode, shatter, assemble, disassemble

            השתמש בעיצוב יצירתי, צבעוני ומגוון. כל שקף צריך להיות שונה ומעניין.

            החזר מצגת בפורמט JSON הבא (רק JSON, ללא טקסט נוסף):
            {
              "slides": [
                {
                  "title": "כותרת השקף",
                  "content": "תוכן השקף\\n- נקודה 1\\n- נקודה 2\\n- נקודה 3",
                  "layout": "standard",
                  "style": {
                    "backgroundColor": "#667eea",
                    "textColor": "#ffffff",
                    "accentColor": "#f093fb",
                    "font": "Heebo",
                    "pattern": "dots",
                    "titleSize": "48px",
                    "contentSize": "24px"
                  },
                  "transition": "fade",
                  "imagePrompt": "תיאור תמונה (אופציונלי)"
                }
              ]
            }`;

                try {
                    const response = await this.callGemini('', systemInstructions);
                    
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('לא התקבלה תגובה תקינה מה-AI');
                    }
                    
                    const presentationData = JSON.parse(jsonMatch[0]);
                    
                    // ניקוי שקפים קיימים
                    app.slides.slides = [];
                    
                    // יצירת השקפים החדשים
                    for (let i = 0; i < presentationData.slides.length; i++) {
                        const slideData = presentationData.slides[i];
                        const slide = app.slides.createSlide(slideData.layout || 'standard');
                        
                        slide.title = slideData.title || '';
                        slide.content = slideData.content || '';
                        
                        if (slideData.style) {
                            slide.style = {
                                ...slide.style,
                                ...slideData.style
                            };
                        }
                        
                        if (slideData.transition) {
                            slide.transition = slideData.transition;
                        }
                        
                        // יצירת גרדיאנט לתמונה
                        if (slideData.imagePrompt) {
                            slide.image = await this.generateImage(slideData.imagePrompt);
                        }
                        
                        app.slides.slides.push(slide);
                    }
                    
                    app.slides.currentSlideIndex = 0;
                    app.slides.renderSlides();
                    
                    // שמירה אוטומטית בהיסטוריה
                    app.settings.savePresentationToHistory(
                        presentationData.slides[0]?.title || 'מצגת ללא שם',
                        app.slides.slides
                    );
                    
                } catch (error) {
                    console.error('[v0] Error in generateFullPresentation:', error);
                    throw error;
                }
            }
        }

        // ========================================
        // Settings Manager
        // ========================================
        class SettingsManager {
            constructor() {
                this.apiKey = localStorage.getItem('gemini_api_key') || '';
                this.presentations = JSON.parse(localStorage.getItem('presentations_history') || '[]');
            }
            
            saveApiKey() {
                const apiKeyInput = document.getElementById('apiKeyInput');
                const apiKey = apiKeyInput.value.trim();
                
                if (!apiKey) {
                    app.ui.showToast('נא להזין מפתח API', 'error');
                    return;
                }
                
                localStorage.setItem('gemini_api_key', apiKey);
                this.apiKey = apiKey;
                app.ai.apiKey = apiKey;
                
                this.updateApiKeyStatus();
                app.ui.showToast('מפתח API נשמר בהצלחה!', 'success');
            }
            
            updateApiKeyStatus() {
                const statusElement = document.getElementById('apiKeyStatus');
                if (!statusElement) return;
                
                if (this.apiKey) {
                    statusElement.innerHTML = `
                        <i class="fas fa-circle-check text-green-400"></i>
                        <span class="text-sm font-medium">מפתח API מזוהר</span>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        <span class="text-sm font-medium">נדרש מפתח API</span>
                    `;
                }
            }
            
            clearAllData() {
                if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים? פעולה זו אינה ניתנת לביטול!')) {
                    localStorage.clear();
                    app.ui.showToast('כל הנתונים נמחקו. העמוד ייטען מחדש...', 'success');
                    setTimeout(() => location.reload(), 1500);
                }
            }
            
            savePresentationToHistory(title = 'מצגת ללא שם', slides = null) {
                // אם slides הוא null, השתמש במצגת הנוכחית
                const slidesToSave = slides ? slides : app.slides.slides;
                
                if (slidesToSave.length === 0) return; // אל תשמור מצגת ריקה

                this.presentations.unshift({
                    id: Date.now(),
                    title: title,
                    slides: JSON.parse(JSON.stringify(slidesToSave)), // העתקה עמוקה
                    createdAt: new Date().toISOString()
                });
                
                // שמירת עד 20 מצגות אחרונות
                if (this.presentations.length > 20) {
                    this.presentations = this.presentations.slice(0, 20);
                }
                
                localStorage.setItem('presentations_history', JSON.stringify(this.presentations));
            }
            
            loadPresentationFromHistory(id) {
                const presentation = this.presentations.find(p => p.id === id);
                if (!presentation) {
                    app.ui.showToast('המצגת לא נמצאה', 'error');
                    return;
                }
                
                // טעינת השקפים
                app.slides.slides = JSON.parse(JSON.stringify(presentation.slides)); // העתקה עמוקה
                
                // הסתרת מסך התחלה והצגת השקפים
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                app.slides.renderSlides();
                app.ui.closePresentationsHistory();
                app.ui.showToast('המצגת נטענה בהצלחה!', 'success');
            }
            
            deletePresentationFromHistory(id) {
                if (confirm('האם אתה בטוח שברצונך למחוק מצגת זו?')) {
                    this.presentations = this.presentations.filter(p => p.id !== id);
                    localStorage.setItem('presentations_history', JSON.stringify(this.presentations));
                    app.ui.updatePresentationsHistoryList();
                    app.ui.showToast('המצגת נמחקה', 'success');
                }
            }
        }

        // ========================================
        // UI Manager
        // ========================================
        class UIManager {
            constructor() {
                this.currentView = 'slides';
            }

            showLoading(show, text = 'טוען...') {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                
                if (show) {
                    loadingText.textContent = text;
                    overlay.style.display = 'flex';
                } else {
                    overlay.style.display = 'none';
                }
            }

            showToast(message, type = 'success') {
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                }
                
                const toast = document.createElement('div');
                toast.className = `toast ${type} animate-slideIn`;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-weight: 600;
                    animation: slideIn 0.3s ease-out;
                    max-width: 300px;
                    min-width: 200px;
                    font-size: 14px;
                `;
                toast.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} text-xl"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            updateHistoryButtons() {
                const undoButton = document.querySelector('[onclick*="undo()"]');
                const redoButton = document.querySelector('[onclick*="redo()"]');
                
                if (undoButton) {
                    undoButton.disabled = app.history.undoStack.length === 0;
                    undoButton.style.opacity = app.history.undoStack.length === 0 ? '0.5' : '1';
                }
                
                if (redoButton) {
                    redoButton.disabled = app.history.redoStack.length === 0;
                    redoButton.style.opacity = app.history.redoStack.length === 0 ? '0.5' : '1';
                }
            }

            startWithAI() {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                this.showAIPromptModal();
            }
            
            startManual() {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                app.slides.addSlide();
            }
            
            createNewPresentation() {
                // שמירה אוטומטית של המצגת הנוכחית להיסטוריה
                if (app.slides.slides.length > 0) {
                    app.settings.savePresentationToHistory();
                }
                
                // איפוס המצגת
                app.slides.slides = [];
                app.slides.currentSlideIndex = -1;
                app.slides.renderSlides();
                document.getElementById('welcomeScreen').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
            }

            toggleSettings() {
                const modal = document.getElementById('settingsModal');
                modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
                
                if (modal.style.display === 'flex') {
                    const apiKeyInput = document.getElementById('apiKeyInput');
                    apiKeyInput.value = app.settings.apiKey;
                }
            }
            
            showAIPromptModal() {
                document.getElementById('aiPromptModal').style.display = 'flex';
            }
            
            closeAIPromptModal() {
                document.getElementById('aiPromptModal').style.display = 'none';
            }
            
            showAIRefinementModal() {
                if (app.slides.slides.length === 0) {
                    this.showAIPromptModal();
                } else {
                    document.getElementById('aiRefinementModal').style.display = 'flex';
                }
            }
            
            closeAIRefinementModal() {
                document.getElementById('aiRefinementModal').style.display = 'none';
            }
            
            showPresentationsHistory() {
                const modal = document.getElementById('presentationsHistoryModal');
                modal.style.display = 'flex';
                this.updatePresentationsHistoryList();
            }
            
            closePresentationsHistory() {
                document.getElementById('presentationsHistoryModal').style.display = 'none';
            }
            
            updatePresentationsHistoryList() {
                const list = document.getElementById('presentationsHistoryList');
                
                if (app.settings.presentations.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500">אין מצגות שמורות</p>';
                    return;
                }
                
                list.innerHTML = app.settings.presentations.map(presentation => `
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 hover:shadow-lg transition cursor-pointer border-2 border-transparent hover:border-purple-300">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h4 class="font-bold text-xl text-gray-800 mb-2">${presentation.title}</h4>
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-calendar ml-1"></i>
                                    ${new Date(presentation.createdAt).toLocaleDateString('he-IL')}
                                    <i class="fas fa-clock mr-3 ml-1"></i>
                                    ${new Date(presentation.createdAt).toLocaleTimeString('he-IL')}
                                </p>
                                <p class="text-sm text-gray-600 mt-1">
                                    <i class="fas fa-file-powerpoint ml-1"></i>
                                    ${presentation.slides.length} שקפים
                                </p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.settings.loadPresentationFromHistory(${presentation.id})" 
                                    class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition">
                                <i class="fas fa-folder-open ml-1"></i>
                                פתח
                            </button>
                            <button onclick="app.settings.deletePresentationFromHistory(${presentation.id})" 
                                    class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            showTextSummaryModal() {
                document.getElementById('summaryModal').style.display = 'flex';
            }

            closeSummaryModal() {
                document.getElementById('summaryModal').style.display = 'none';
            }
            
            showImageModal() {
                document.getElementById('imageModal').style.display = 'flex';
            }
            
            closeImageModal() {
                document.getElementById('imageModal').style.display = 'none';
            }
            
            showSmartEditor() {
                document.getElementById('smartEditorModal').style.display = 'flex';
            }
            
            closeSmartEditor() {
                document.getElementById('smartEditorModal').style.display = 'none';
            }

            showTemplateGallery() {
                const modal = document.getElementById('templateModal');
                const grid = document.getElementById('templateGrid');
                
                const templates = app.templates.getAllTemplates();
                grid.innerHTML = templates.map(template => `
                    <div class="template-card" 
                         style="background: ${template.preview}; height: 140px; border-radius: 12px; cursor: pointer; padding: 20px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;"
                         onclick="app.ui.applyTemplate('${template.id}')"
                         onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.3)'"
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm px-4 py-2 rounded-lg">
                            <p class="font-bold text-gray-800 text-center">${template.name}</p>
                        </div>
                    </div>
                `).join('');
                
                modal.style.display = 'flex';
            }

            closeTemplateGallery() {
                document.getElementById('templateModal').style.display = 'none';
            }
            
            applyTemplate(templateId) {
                const template = app.templates.getTemplateById(templateId);
                if (!template) return;

                if (app.slides.currentSlideIndex === -1) {
                    this.showToast('בחר שקף להחלת תבנית', 'error');
                    return;
                }

                if (confirm(`האם להחיל את התבנית "${template.name}" על השקף הנוכחי?`)) {
                    app.history.saveState();
                    const slide = app.slides.slides[app.slides.currentSlideIndex];
                    slide.layout = template.style.layout;
                    slide.style = {
                        ...slide.style,
                        backgroundColor: template.style.backgroundColor,
                        textColor: template.style.textColor,
                        accentColor: template.style.accentColor,
                        font: template.style.font,
                        titleSize: template.style.titleSize,
                        pattern: template.style.pattern,
                    };
                    app.slides.renderSlides();
                    this.closeTemplateGallery();
                    this.showToast(`תבנית "${template.name}" הוחלה על השקף!`, 'success');
                }
            }

            applyRandomDesignToAll() {
                if (app.slides.slides.length === 0) {
                    this.showToast('אין שקפים להחלת עיצוב', 'error');
                    return;
                }
                
                if (confirm('האם להחיל עיצוב אקראי מלא על כל השקפים?')) {
                    app.slides.applyRandomDesignToAll();
                    this.closeTemplateGallery();
                }
            }

            applyRandomStyleToAll() {
                if (app.slides.slides.length === 0) {
                    this.showToast('אין שקפים להחלת עיצוב', 'error');
                    return;
                }
                
                if (confirm('האם להחיל סגנונות עיצוב אקראיים על כל השקפים?')) {
                    app.slides.applyRandomStyleToAll();
                    this.closeTemplateGallery();
                }
            }

            updateSaveStatus(success) {
                const status = document.getElementById('autoSaveStatus');
                if (success) {
                    status.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-2"></i>נשמר אוטומטית';
                } else {
                    status.innerHTML = '<i class="fas fa-exclamation-circle text-red-500 mr-2"></i>שגיאה בשמירה';
                }
            }

            render() {
                // Assuming render needs to be called to update the UI after initial setup
                if (app.slides && app.slides.renderSlides) {
                    app.slides.renderSlides();
                }
                if (app.settings && app.settings.updateApiKeyStatus) {
                    app.settings.updateApiKeyStatus();
                }
            }

            showSettingsModal() {
                document.getElementById('settingsModal').style.display = 'flex';
                const apiKeyInput = document.getElementById('apiKeyInput');
                if (apiKeyInput && app.settings.apiKey) {
                    apiKeyInput.value = app.settings.apiKey;
                }
            }
        }

        // ========================================
        // Export Manager
        // ========================================
        class ExportManager {
            constructor() {
                this.pptx = null;
            }

            async exportToPptx() {
                if (!app.slides || !app.slides.slides || app.slides.slides.length === 0) {
                    app.ui.showToast('אין שקפים לייצוא', 'error');
                    return;
                }

                app.ui.showLoading(true, 'מייצא ל-PPTX...');

                try {
                    const pptx = new PptxGenJS();
                    pptx.layout = 'LAYOUT_16x9';
                    pptx.rtlMode = true;

                    for (const slide of app.slides.slides) {
                        const pptxSlide = pptx.addSlide();
                        
                        if (slide.style) {
                            try {
                                // יצירת canvas עם הרקע של השקף
                                const canvas = document.createElement('canvas');
                                canvas.width = 1920;
                                canvas.height = 1080;
                                const ctx = canvas.getContext('2d');
                                
                                // ציור הרקע
                                if (slide.style.backgroundColor) {
                                    ctx.fillStyle = slide.style.backgroundColor;
                                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                                }
                                
                                // הוספת דפוס רקע אם קיים
                                if (slide.style.pattern && slide.style.pattern !== 'none') {
                                    const pattern = app.templates.advancedDesign.backgroundPatterns.find(p => p.id === slide.style.pattern);
                                    if (pattern && pattern.style !== 'none') {
                                        // יצירת canvas זמני לדפוס
                                        const patternCanvas = document.createElement('canvas');
                                        patternCanvas.width = 100;
                                        patternCanvas.height = 100;
                                        const patternCtx = patternCanvas.getContext('2d');
                                        
                                        // ציור הדפוס (פשוט - נקודות כדוגמה)
                                        if (slide.style.pattern === 'dots') {
                                            patternCtx.fillStyle = 'rgba(0,0,0,0.1)';
                                            for (let i = 0; i < 100; i += 20) {
                                                for (let j = 0; j < 100; j += 20) {
                                                    patternCtx.beginPath();
                                                    patternCtx.arc(i, j, 1, 0, Math.PI * 2);
                                                    patternCtx.fill();
                                                }
                                            }
                                        } else if (slide.style.pattern === 'diagonal') {
                                            patternCtx.strokeStyle = 'rgba(0,0,0,0.05)';
                                            patternCtx.lineWidth = 10;
                                            for (let i = -100; i < 200; i += 20) {
                                                patternCtx.beginPath();
                                                patternCtx.moveTo(i, 0);
                                                patternCtx.lineTo(i + 100, 100);
                                                patternCtx.stroke();
                                            }
                                        }
                                        
                                        // שכפול הדפוס על כל הרקע
                                        const pat = ctx.createPattern(patternCanvas, 'repeat');
                                        ctx.fillStyle = pat;
                                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                                    }
                                }
                                
                                // המרה ל-base64 והוספה כרקע ב-PPTX
                                const backgroundImage = canvas.toDataURL('image/png');
                                pptxSlide.background = { data: backgroundImage };
                            } catch (error) {
                                console.error('שגיאה ביצירת רקע:', error);
                                // אם יש בעיה, פשוט שים צבע רקע רגיל
                                if (slide.style.backgroundColor) {
                                    pptxSlide.background = { color: slide.style.backgroundColor.replace('#', '') };
                                }
                            }
                        }
                        
                        // כותרת
                        if (slide.title) {
                            const cleanTitle = this.cleanMarkdown(slide.title);
                            pptxSlide.addText(cleanTitle, {
                                x: 0.5,
                                y: 0.5,
                                w: 9,
                                h: 1,
                                fontSize: 36,
                                bold: true,
                                color: slide.style?.textColor?.replace('#', '') || 'FFFFFF',
                                align: 'right',
                                fontFace: slide.style?.font || 'Arial',
                                rtlMode: true
                            });
                        }
                        
                        // תוכן
                        if (slide.content) {
                            const cleanContent = this.cleanMarkdown(slide.content);
                            const contentLines = cleanContent.split('\n').filter(line => line.trim());
                            
                            pptxSlide.addText(contentLines.map(line => ({
                                text: line,
                                options: { breakLine: true }
                            })), {
                                x: 0.5,
                                y: slide.title ? 1.8 : 0.5,
                                w: slide.image ? 5 : 9,
                                h: 4,
                                fontSize: 20,
                                color: slide.style?.textColor?.replace('#', '') || 'FFFFFF',
                                align: 'right',
                                valign: 'top',
                                fontFace: slide.style?.font || 'Arial',
                                rtlMode: true
                            });
                        }
                        
                        // תמונה
                        if (slide.image) {
                            try {
                                pptxSlide.addImage({
                                    data: slide.image,
                                    x: 6,
                                    y: 1.8,
                                    w: 3.5,
                                    h: 3.5
                                });
                            } catch (error) {
                                console.error('שגיאה בהוספת תמונה ל-PPTX:', error);
                            }
                        }
                    }

                    await pptx.writeFile({ fileName: 'SlideGenius-Presentation.pptx' });
                    app.ui.showLoading(false);
                    app.ui.showToast('המצגת יוצאה בהצלחה!', 'success');
                } catch (error) {
                    console.error('Error exporting to PPTX:', error);
                    app.ui.showLoading(false);
                    app.ui.showToast('שגיאה בייצוא המצגת', 'error');
                }
            }
            
            cleanMarkdown(text) {
                if (!text) return '';
                
                return text
                    // הסרת Bold
                    .replace(/\*\*(.*?)\*\*/g, '$1')
                    .replace(/__(.*?)__/g, '$1')
                    // הסרת Italic
                    .replace(/\*(.*?)\*/g, '$1')
                    .replace(/_(.*?)_/g, '$1')
                    // הסרת Strikethrough
                    .replace(/~~(.*?)~~/g, '$1')
                    // הסרת Code
                    .replace(/`(.*?)`/g, '$1')
                    // הסרת Links
                    .replace(/\[(.*?)\]$$(.*?)$$/g, '$1') // Added link removal
                    // הסרת Headers
                    .replace(/#{1,6}\s/g, '')
                    .trim();
            }
        }

        // ========================================
        // Design Templates
        // ========================================
        class DesignTemplates {
            constructor(advancedDesign) {
                this.advancedDesign = advancedDesign;
                this.templates = [
                    {
                        id: 'modern',
                        name: 'מודרני',
                        preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        style: {
                            backgroundColor: '#667eea',
                            textColor: '#ffffff',
                            accentColor: '#764ba2',
                            font: 'Rubik',
                            titleSize: '42px',
                            pattern: this.advancedDesign.backgroundPatterns[0],
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'elegant',
                        name: 'אלגנטי',
                        preview: 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)',
                        style: {
                            backgroundColor: '#1e3a8a',
                            textColor: '#ffffff',
                            accentColor: '#60a5fa',
                            font: 'Assistant',
                            titleSize: '38px',
                            pattern: this.advancedDesign.backgroundPatterns[1],
                            layout: 'centered'
                        }
                    },
                    {
                        id: 'creative',
                        name: 'יצירתי',
                        preview: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        style: {
                            backgroundColor: '#f093fb',
                            textColor: '#ffffff',
                            accentColor: '#f5576c',
                            font: 'Heebo',
                            titleSize: '44px',
                            pattern: this.advancedDesign.backgroundPatterns[2],
                            layout: 'split'
                        }
                    },
                    {
                        id: 'minimalist',
                        name: 'מינימליסטי',
                        preview: 'linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%)',
                        style: {
                            backgroundColor: '#ffffff',
                            textColor: '#1f2937',
                            accentColor: '#6366f1',
                            font: 'Assistant',
                            titleSize: '36px',
                            pattern: this.advancedDesign.backgroundPatterns[0],
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'vibrant',
                        name: 'תוסס',
                        preview: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                        style: {
                            backgroundColor: '#43e97b',
                            textColor: '#ffffff',
                            accentColor: '#38f9d7',
                            font: 'Secular One',
                            titleSize: '40px',
                            pattern: this.advancedDesign.backgroundPatterns[3],
                            layout: 'hero'
                        }
                    },
                    {
                        id: 'professional',
                        name: 'מקצועי',
                        preview: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                        style: {
                            backgroundColor: '#30cfd0',
                            textColor: '#ffffff',
                            accentColor: '#330867',
                            font: 'Rubik',
                            titleSize: '38px',
                            pattern: this.advancedDesign.backgroundPatterns[4],
                            layout: 'sidebar'
                        }
                    },
                    {
                        id: 'warm',
                        name: 'חם',
                        preview: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        style: {
                            backgroundColor: '#fa709a',
                            textColor: '#ffffff',
                            accentColor: '#fee140',
                            font: 'Alef',
                            titleSize: '42px',
                            pattern: this.advancedDesign.backgroundPatterns[5],
                            layout: 'card'
                        }
                    },
                    {
                        id: 'cool',
                        name: 'קריר',
                        preview: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                        style: {
                            backgroundColor: '#a8edea',
                            textColor: '#1f2937',
                            accentColor: '#fed6e3',
                            font: 'Varela Round',
                            titleSize: '40px',
                            pattern: this.advancedDesign.backgroundPatterns[6],
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'sunset',
                        name: 'שקיעה',
                        preview: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                        style: {
                            backgroundColor: '#ffecd2',
                            textColor: '#7c2d12',
                            accentColor: '#fcb69f',
                            font: 'David Libre',
                            titleSize: '38px',
                            pattern: this.advancedDesign.backgroundPatterns[7],
                            layout: 'centered'
                        }
                    },
                    {
                        id: 'ocean',
                        name: 'אוקיינוס',
                        preview: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        style: {
                            backgroundColor: '#4facfe',
                            textColor: '#ffffff',
                            accentColor: '#00f2fe',
                            font: 'Noto Sans Hebrew',
                            titleSize: '44px',
                            pattern: this.advancedDesign.backgroundPatterns[8],
                            layout: 'split'
                        }
                    }
                ];
            }

            getAllTemplates() {
                return this.templates;
            }

            getTemplateById(id) {
                return this.templates.find(t => t.id === id);
            }

            getPatternById(id) {
                return this.advancedDesign.backgroundPatterns.find(p => p.id === id);
            }

            generateGradientForSlide(seed = Date.now()) {
                const gradients = this.advancedDesign.gradients;
                const index = seed % gradients.length;
                return gradients[index];
            }
        }

        // ========================================
        // Slides Manager
        // ========================================
        class SlidesManager {
            constructor() {
                this.slides = [];
                this.currentSlideIndex = -1;
            }

            createSlide(layout = 'standard') {
                const randomDesign = app.advancedDesign.getFullRandomDesign();
                
                return {
                    id: Date.now() + Math.random(), // Ensure unique ID
                    title: '',
                    content: '',
                    image: null,
                    layout: layout,
                    style: {
                        backgroundColor: randomDesign.backgroundColor,
                        textColor: randomDesign.textColor,
                        accentColor: randomDesign.accentColor,
                        font: randomDesign.font,
                        pattern: randomDesign.pattern.id,
                        titleSize: '42px',
                        contentSize: '20px'
                    },
                    transition: 'fade' // Default transition
                };
            }

            addSlide(slideData = null) {
                app.history.saveState();
                let slide;
                if (slideData) {
                    // Create slide from provided data (e.g., loading from history)
                    slide = {
                        id: Date.now() + Math.random(), // Ensure unique ID
                        title: slideData.title || '',
                        content: slideData.content || '',
                        image: slideData.image || null, // Use image property directly
                        layout: slideData.layout || 'standard',
                        style: {
                            backgroundColor: slideData.style?.backgroundColor || '#ffffff',
                            textColor: slideData.style?.textColor || '#333',
                            accentColor: slideData.style?.accentColor || '#667eea',
                            font: slideData.style?.font || 'Heebo',
                            pattern: slideData.style?.pattern || 'none',
                            titleSize: slideData.style?.titleSize || '42px',
                            contentSize: slideData.style?.contentSize || '20px',
                        },
                        transition: slideData.transition || 'fade'
                    };
                } else {
                    // Create a new blank slide
                    slide = this.createSlide();
                }
                
                this.slides.push(slide);
                this.currentSlideIndex = this.slides.length - 1;
                this.renderSlides();
                app.ui.showToast('שקף חדש נוסף!', 'success');
            }

            deleteSlide(index = this.currentSlideIndex) {
                if (this.slides.length === 0) return;
                
                if (confirm('האם למחוק שקף זה?')) {
                    app.history.saveState();
                    this.slides.splice(index, 1);
                    
                    if (this.currentSlideIndex >= this.slides.length) {
                        this.currentSlideIndex = this.slides.length - 1;
                    }
                    // If it was the last slide and it's deleted, reset to no slide selected
                    if (this.slides.length === 0) {
                        this.currentSlideIndex = -1;
                    }
                    
                    this.renderSlides();
                    app.ui.showToast('השקף נמחק', 'success');
                }
            }

            duplicateSlide() {
                if (this.currentSlideIndex === -1) {
                    app.ui.showToast('בחר שקף לשכפול', 'error');
                    return;
                }
                
                app.history.saveState();
                const originalSlide = this.slides[this.currentSlideIndex];
                const duplicatedSlide = JSON.parse(JSON.stringify(originalSlide));
                duplicatedSlide.id = Date.now() + Math.random();
                
                this.slides.splice(this.currentSlideIndex + 1, 0, duplicatedSlide);
                this.currentSlideIndex++;
                this.renderSlides();
                app.ui.showToast('השקף שוכפל!', 'success');
            }

            selectSlide(index) {
                this.currentSlideIndex = index;
                this.renderSlides();
            }

            refreshView() {
                this.renderSlides();
                app.ui.showToast('התצוגה רוענה', 'success');
            }

            clear() {
                this.slides = [];
                this.currentSlideIndex = -1;
                this.renderSlides();
            }

            applyRandomDesignToAll() {
                app.history.saveState();
                
                this.slides.forEach(slide => {
                    const randomDesign = app.advancedDesign.getFullRandomDesign();
                    slide.style = {
                        backgroundColor: randomDesign.backgroundColor,
                        textColor: randomDesign.textColor,
                        accentColor: randomDesign.accentColor,
                        font: randomDesign.font,
                        pattern: randomDesign.pattern.id,
                        titleSize: '42px',
                        contentSize: '20px'
                    };
                    slide.layout = randomDesign.layout.id;
                });
                
                this.renderSlides();
                app.ui.showToast('עיצוב אקראי הוחל על כל השקפים!', 'success');
            }

            applyRandomStyleToAll() {
                app.history.saveState();
                
                this.slides.forEach(slide => {
                    const colorScheme = app.advancedDesign.getRandomColorScheme();
                    const pattern = app.advancedDesign.getRandomPattern();
                    
                    slide.style = {
                        ...slide.style,
                        backgroundColor: colorScheme.colors[0],
                        textColor: colorScheme.colors[4],
                        accentColor: colorScheme.colors[2],
                        font: app.advancedDesign.getRandomFont(),
                        pattern: pattern.id
                    };
                });
                
                this.renderSlides();
                app.ui.showToast('סגנון אקראי הוחל על כל השקפים!', 'success');
            }

            renderSlides() {
                this.renderThumbnails();
                this.renderCurrentSlide();
                this.renderEditor();
                this.updateSlideCount();
            }

            renderThumbnails() {
                const container = document.getElementById('slideThumbnails');
                if (!container) return;

                if (this.slides.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center text-sm">אין שקפים עדיין</p>';
                    return;
                }

                container.innerHTML = this.slides.map((slide, index) => {
                    const pattern = app.templates.getPatternById(slide.style?.pattern || 'none');
                    const patternStyle = pattern && pattern.id !== 'none' 
                        ? `background-image: ${pattern.style}; background-size: ${pattern.size || 'auto'}; background-position: ${pattern.position || '0 0'};`
                        : '';
                    
                    return `
                        <div class="slide-thumbnail ${index === this.currentSlideIndex ? 'active' : ''}" 
                             onclick="app.slides.selectSlide(${index})"
                             style="background-color: ${slide.style?.backgroundColor || '#6366f1'}; ${patternStyle}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-white bg-opacity-90 px-3 py-1 rounded-full text-sm font-bold text-gray-800">${index + 1}</span>
                                <button onclick="event.stopPropagation(); app.slides.deleteSlide(${index})" 
                                        class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                            <h4 class="font-bold text-sm mb-1" style="color: ${slide.style?.textColor || '#ffffff'}">
                                ${slide.title || 'שקף ללא כותרת'}
                            </h4>
                            <p class="text-xs opacity-80" style="color: ${slide.style?.textColor || '#ffffff'}">
                                ${slide.content ? slide.content.substring(0, 50) + '...' : 'אין תוכן'}
                            </p>
                        </div>
                    `;
                }).join('');
            }

            renderCurrentSlide() {
                const container = document.getElementById('currentSlideDisplay');
                if (!container) return;

                if (this.currentSlideIndex === -1 || this.slides.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-20">
                            <i class="fas fa-file-powerpoint text-6xl mb-4 opacity-50"></i>
                            <p class="text-2xl font-bold">אין שקפים עדיין</p>
                            <p class="text-lg mt-2">צור מצגת חדשה כדי להתחיל</p>
                        </div>
                    `;
                    return;
                }

                const slide = this.slides[this.currentSlideIndex];
                const pattern = app.templates.getPatternById(slide.style?.pattern || 'none');
                const patternStyle = pattern && pattern.id !== 'none'
                    ? `background-image: ${pattern.style}; background-size: ${pattern.size || 'auto'}; background-position: ${pattern.position || '0 0'};`
                    : '';

                const contentHtml = this.formatContent(slide.content);

                container.innerHTML = `
                    <div class="w-full h-full rounded-xl overflow-hidden shadow-2xl" 
                         style="background-color: ${slide.style?.backgroundColor || '#6366f1'}; ${patternStyle} font-family: ${slide.style?.font || 'Rubik'}, sans-serif; min-height: 500px;">
                        <div class="p-12 h-full flex flex-col">
                            ${slide.title ? `
                                <h1 class="font-black mb-8" 
                                    style="color: ${slide.style?.textColor || '#ffffff'}; font-size: ${slide.style?.titleSize || '42px'}; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                                    ${slide.title}
                                </h1>
                            ` : ''}
                            
                            <div class="flex-1 ${slide.image ? 'grid grid-cols-2 gap-8' : ''}">
                                <div class="flex flex-col justify-center">
                                    <div class="text-xl leading-relaxed" 
                                         style="color: ${slide.style?.textColor || '#ffffff'}; font-size: ${slide.style?.contentSize || '20px'};">
                                        ${contentHtml}
                                    </div>
                                </div>
                                
                                ${slide.image ? `
                                    <div class="flex items-center justify-center">
                                        <img src="${slide.image}" 
                                             alt="Slide image" 
                                             class="rounded-2xl shadow-2xl max-w-full max-h-96 object-contain"
                                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'400\\' height=\\'300\\'/%3E%3Ctext fill=\\'%23999\\' x=\\'50%25\\' y=\\'50%25\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-family=\\'Arial\\' font-size=\\'20\\'%3EImage%3C/text%3E%3C/svg%3E'">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            formatContent(content) {
                if (!content) return '';
                
                return content
                    .split('\n')
                    .map(line => {
                        line = line.trim();
                        if (!line) return '';
                        
                        if (line.startsWith('- ') || line.startsWith('• ') || line.startsWith('* ') || line.startsWith('+ ')) { // Added more bullet types
                            return `<div class="flex items-start gap-3 mb-3">
                                <i class="fas fa-check-circle mt-1" style="color: currentColor; opacity: 0.8;"></i>
                                <span>${line.substring(2)}</span>
                            </div>`;
                        }
                        
                        return `<p class="mb-3">${line}</p>`;
                    })
                    .join('');
            }

            renderEditor() {
                const container = document.getElementById('slideEditor');
                if (!container) return;

                if (this.currentSlideIndex === -1 || this.slides.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">בחר שקף לעריכה</p>';
                    return;
                }

                const slide = this.slides[this.currentSlideIndex];

                container.innerHTML = `
                    <div class="space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto p-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">עריכת שקף</h3>
                        
                        <!-- כותרת -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">כותרת</label>
                            <input type="text" 
                                   value="${slide.title || ''}" 
                                   onchange="app.slides.updateSlide('title', this.value)"
                                   class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-purple-400 focus:border-purple-500"
                                   placeholder="הזן כותרת...">
                        </div>
                        
                        <!-- תוכן -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">תוכן</label>
                            <textarea onchange="app.slides.updateSlide('content', this.value)"
                                      class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-purple-400 focus:border-purple-500 min-h-32"
                                      placeholder="הזן תוכן...">${slide.content || ''}</textarea>
                        </div>
                        
                        <!-- פריסה -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">פריסה</label>
                            <select onchange="app.slides.updateSlide('layout', this.value)"
                                    class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-purple-400">
                                <option value="standard" ${slide.layout === 'standard' ? 'selected' : ''}>רגיל (כותרת + תוכן)</option>
                                <option value="centered" ${slide.layout === 'centered' ? 'selected' : ''}>מרוכז</option>
                                <option value="split" ${slide.layout === 'split' ? 'selected' : ''}>מפוצל (טקסט + תמונה)</option>
                            </select>
                        </div>
                        
                        <!-- צבעים -->
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">רקע</label>
                                <input type="color" 
                                       value="${slide.style?.backgroundColor || '#6366f1'}" 
                                       onchange="app.slides.updateSlideStyle('backgroundColor', this.value)"
                                       class="w-full h-10 rounded-lg cursor-pointer">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">טקסט</label>
                                <input type="color" 
                                       value="${slide.style?.textColor || '#ffffff'}" 
                                       onchange="app.slides.updateSlideStyle('textColor', this.value)"
                                       class="w-full h-10 rounded-lg cursor-pointer">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">הדגשה</label>
                                <input type="color" 
                                       value="${slide.style?.accentColor || '#f093fb'}" 
                                       onchange="app.slides.updateSlideStyle('accentColor', this.value)"
                                       class="w-full h-10 rounded-lg cursor-pointer">
                            </div>
                        </div>
                        
                        <!-- גופן -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">גופן</label>
                            <select onchange="app.slides.updateSlideStyle('font', this.value)"
                                    class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-purple-400">
                                ${app.advancedDesign.fonts.map(font => `
                                    <option value="${font}" ${slide.style?.font === font ? 'selected' : ''}>${font}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- תבנית רקע -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">תבנית רקע</label>
                            <select onchange="app.slides.updateSlideStyle('pattern', this.value)"
                                    class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-purple-400 max-h-40 overflow-y-auto">
                                ${app.advancedDesign.backgroundPatterns.map(pattern => `
                                    <option value="${pattern.id}" ${slide.style?.pattern === pattern.id ? 'selected' : ''}>${pattern.id}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- מעבר -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">מעבר לשקף הבא</label>
                            <select onchange="app.slides.updateSlide('transition', this.value)"
                                    class="w-full border-2 border-gray-300 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-purple-400 max-h-40 overflow-y-auto">
                                ${app.advancedDesign.transitions.map(trans => `
                                    <option value="${trans.id}" ${slide.transition === trans.id ? 'selected' : ''}>${trans.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <!-- גדלי טקסט -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">גודל כותרת</label>
                                <input type="range" min="24" max="72" value="${parseInt(slide.style?.titleSize) || 42}" 
                                       oninput="this.nextElementSibling.textContent = this.value + 'px';"
                                       onchange="app.slides.updateSlideStyle('titleSize', this.value + 'px')"
                                       class="w-full">
                                <span class="text-xs text-gray-500">${parseInt(slide.style?.titleSize) || 42}px</span>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">גודל תוכן</label>
                                <input type="range" min="12" max="36" value="${parseInt(slide.style?.contentSize) || 20}" 
                                       oninput="this.nextElementSibling.textContent = this.value + 'px';"
                                       onchange="app.slides.updateSlideStyle('contentSize', this.value + 'px')"
                                       class="w-full">
                                <span class="text-xs text-gray-500">${parseInt(slide.style?.contentSize) || 20}px</span>
                            </div>
                        </div>
                        
                        <!-- כפתורי פעולה -->
                        <div class="grid grid-cols-2 gap-2 pt-4">
                            <button onclick="app.slides.duplicateSlide()" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm">
                                <i class="fas fa-copy ml-1"></i> שכפל שקף
                            </button>
                            <button onclick="app.slides.deleteSlide()" 
                                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition text-sm">
                                <i class="fas fa-trash ml-1"></i> מחק שקף
                            </button>
                        </div>
                    </div>
                `;
            }

            updateSlide(field, value) {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                this.slides[this.currentSlideIndex][field] = value;
                this.renderSlides();
            }

            updateSlideStyle(property, value) {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                if (!this.slides[this.currentSlideIndex].style) {
                    this.slides[this.currentSlideIndex].style = {};
                }
                this.slides[this.currentSlideIndex].style[property] = value;
                this.renderSlides();
            }

            updateSlideCount() {
                const countElement = document.getElementById('slideCount');
                if (countElement) {
                    countElement.textContent = this.slides.length;
                }
            }
        }

        // ========================================
        // History Manager
        // ========================================
        class HistoryManager {
            constructor() {
                this.undoStack = [];
                this.redoStack = [];
                this.maxStackSize = 50;
            }

            saveState() {
                // Avoid saving identical states consecutively
                if (this.undoStack.length > 0) {
                    const lastState = this.undoStack[this.undoStack.length - 1];
                    const currentState = JSON.stringify(app.slides.slides);
                    if (lastState === currentState) {
                        return;
                    }
                }
                
                const state = JSON.stringify(app.slides.slides);
                this.undoStack.push(state);
                
                if (this.undoStack.length > this.maxStackSize) {
                    this.undoStack.shift();
                }
                
                this.redoStack = []; // Clear redo stack on new action
                app.ui.updateHistoryButtons();
            }

            undo() {
                if (this.undoStack.length === 0) {
                    app.ui.showToast('אין פעולות לביטול', 'error');
                    return;
                }
                
                const currentState = JSON.stringify(app.slides.slides);
                this.redoStack.push(currentState);
                
                const previousState = this.undoStack.pop();
                app.slides.slides = JSON.parse(previousState);
                app.slides.renderSlides();
                
                app.ui.updateHistoryButtons();
                app.ui.showToast('הפעולה בוטלה', 'success');
            }

            redo() {
                if (this.redoStack.length === 0) {
                    app.ui.showToast('אין פעולות לשחזור', 'error');
                    return;
                }
                
                const currentState = JSON.stringify(app.slides.slides);
                this.undoStack.push(currentState);
                
                const nextState = this.redoStack.pop();
                app.slides.slides = JSON.parse(nextState);
                app.slides.renderSlides();
                
                app.ui.updateHistoryButtons();
                app.ui.showToast('הפעולה שוחזרה', 'success');
            }
        }
        
        // Notification Manager
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationContainer');
            }

            show(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
                notification.innerHTML = `
                    <span style="font-size: 20px; font-weight: bold;">${icon}</span>
                    <span style="flex: 1;">${message}</span>
                `;
                
                this.container.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // ========================================
        // Initialize App
        // ========================================
        class PresentationApp {
            constructor() {
                this.slides = new SlidesManager();
                this.ui = new UIManager();
                this.ai = new AIManager();
                this.export = new ExportManager();
                this.history = new HistoryManager();
                this.settings = new SettingsManager();
                this.advancedDesign = new AdvancedDesignSystem();
                this.templates = new DesignTemplates(this.advancedDesign);
                this.notifications = new NotificationManager();
            }
        }

        // Initialize app
        window.app = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new PresentationApp();
            
            // בדיקה אם קיים API key
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                app.ui.showSettingsModal();
            } else {
                // עדכון ה-API key ב-AIManager
                app.ai.apiKey = apiKey;
                // עדכון סטטוס ה-API key בממשק המשתמש
                app.settings.updateApiKeyStatus();
            }

            // קריאה ראשונית לעדכון הממשק, במידה ויש היסטוריה או אלמנטים אחרים לטעון
            app.ui.render();
        });

        // קיצורי מקלדת
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z / Cmd+Z - Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                app.history.undo();
            }
            
            // Ctrl+Shift+Z / Cmd+Shift+Z - Redo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                app.history.redo();
            }
            
            // Ctrl+S / Cmd+S - Save Version
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                app.history.saveState();
            }
            
            // Ctrl+E / Cmd+E - Export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                app.export.exportToPptx();
            }
        });

    </script>
</body>
</html>
