<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideGenius AI Pro - מחולל מצגות אוטומטי מתקדם</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@300;400;500;600;700;800;900&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        /* גלילה מותאמת */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* אנימציות */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        /* כרטיס שקף */
        .slide-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .slide-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .slide-card.active {
            border: 3px solid #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .slide-card:active {
            cursor: grabbing;
        }

        /* אזור עריכה */
        .slide-canvas {
            background: white;
            aspect-ratio: 16/9;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        /* מסך טעינה */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* כפתורים מעוצבים */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid #667eea;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* טוסט התראה */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-right: 4px solid #10b981;
        }

        .toast.error {
            border-right: 4px solid #ef4444;
        }

        /* עיצוב שקף */
        .slide-layout-standard .slide-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .slide-layout-centered {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .slide-layout-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        /* אפקטים מיוחדים */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* רספונסיביות */
        @media (max-width: 768px) {
            .slide-canvas {
                max-width: 100%;
            }
        }

        /* עיצובים דינמיים */
        .pattern-dots {
            background-image: radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .pattern-grid {
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .pattern-diagonal {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.03) 10px,
                rgba(0,0,0,0.03) 20px
            );
        }

        /* תוכן שקף ניתן לעריכה */
        [contenteditable]:focus {
            outline: 2px solid #667eea;
            outline-offset: 4px;
            border-radius: 4px;
        }

        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
        }

        /* טיפ-טול */
        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 8px;
        }

        /* סגנון מודאל */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        /* גלריית תבניות */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .template-card {
            aspect-ratio: 16/9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .template-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .template-card.selected {
            border-color: #667eea;
        }
    </style>
</head>
<body>

    <!-- מסך טעינה -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
        <h2 class="text-white text-2xl font-bold mt-6" id="loadingText">מעבד את המצגת...</h2>
        <p class="text-gray-300 mt-2">ה-AI עובד קשה בשבילך ⚡</p>
    </div>

    <!-- כותרת עליונה -->
    <header class="bg-white shadow-lg">
        <div class="max-w-screen-2xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-br from-purple-600 to-indigo-600 text-white p-3 rounded-xl shadow-lg">
                    <i class="fas fa-wand-magic-sparkles text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold gradient-text">SlideGenius AI Pro</h1>
                    <p class="text-sm text-gray-500">מחולל מצגות מתקדם עם בינה מלאכותית</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div id="apiKeyStatus" class="text-sm px-4 py-2 rounded-lg bg-red-50 text-red-600 font-semibold border border-red-200">
                    <i class="fas fa-key ml-2"></i> נדרש מפתח API
                </div>
                <button onclick="app.ui.toggleSettings()" class="tooltip btn-secondary" data-tooltip="הגדרות">
                    <i class="fas fa-cog"></i>
                </button>
                <button onclick="app.export.exportToPptx()" class="btn-primary flex items-center gap-2">
                    <i class="fas fa-download"></i>
                    <span>ייצוא PPTX</span>
                </button>
            </div>
        </div>
    </header>

    <!-- אזור ראשי -->
    <main class="flex h-[calc(100vh-80px)] max-w-screen-2xl mx-auto">
        
        <!-- סרגל שקפים -->
        <aside class="w-80 bg-white bg-opacity-95 backdrop-blur-lg flex flex-col shadow-2xl">
            <div class="p-5 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-indigo-50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 text-lg">השקפים שלי</h3>
                    <span id="slideCount" class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-bold">0</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.history.undo()" class="tooltip flex-1 btn-secondary text-sm py-2" data-tooltip="בטל פעולה">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button onclick="app.history.redo()" class="tooltip flex-1 btn-secondary text-sm py-2" data-tooltip="בצע שוב">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button onclick="app.slides.addNewSlide()" class="tooltip flex-1 btn-primary text-sm py-2" data-tooltip="שקף חדש">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div id="slidesList" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="text-center text-gray-400 mt-20">
                    <i class="fas fa-images text-5xl mb-4 opacity-50"></i>
                    <p class="text-lg font-medium">אין שקפים עדיין</p>
                    <p class="text-sm mt-2">צור מצגת חדשה כדי להתחיל</p>
                </div>
            </div>
        </aside>

        <!-- אזור עריכה -->
        <section class="flex-1 flex flex-col bg-gradient-to-br from-purple-100 to-indigo-100 overflow-hidden">
            
            <!-- סרגל כלים -->
            <div class="bg-white bg-opacity-90 backdrop-blur-lg p-4 border-b border-gray-200 shadow-md">
                <div class="flex items-center gap-3 mb-3">
                    <div class="flex-1 relative">
                        <input type="text" id="aiPromptInput" 
                               placeholder="תאר את המצגת שתרצה ליצור... (דוגמה: מצגת על יתרונות הבינה המלאכותית בחינוך)" 
                               class="w-full px-5 py-3 pr-12 border-2 border-purple-200 rounded-xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 outline-none transition text-lg"
                               onkeypress="if(event.key === 'Enter') app.ai.generateFullPresentation()">
                        <i class="fas fa-sparkles absolute right-4 top-4 text-purple-500 text-xl"></i>
                    </div>
                    <button onclick="app.ai.generateFullPresentation()" class="btn-primary text-lg px-8 py-3 flex items-center gap-3">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>צור מצגת</span>
                    </button>
                </div>

                <!-- כלי AI נוספים -->
                <div class="flex gap-2 flex-wrap">
                    <button onclick="app.ai.proofreadCurrentSlide()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="שיפור טקסט">
                        <i class="fas fa-spell-check ml-1"></i> בדוק דקדוק
                    </button>
                    <button onclick="app.ai.suggestImage()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="תמונה חדשה מ-AI">
                        <i class="fas fa-image ml-1"></i> תמונה חדשה
                    </button>
                    <button onclick="app.ui.showSummaryModal()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="המר טקסט למצגת">
                        <i class="fas fa-file-import ml-1"></i> סיכום טקסט
                    </button>
                    <button onclick="app.ai.generateQuizSlide()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="צור שקף חידון">
                        <i class="fas fa-question-circle ml-1"></i> חידון
                    </button>
                    <button onclick="app.ui.showTemplateGallery()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="בחר תבנית עיצוב">
                        <i class="fas fa-palette ml-1"></i> תבניות
                    </button>
                    <button onclick="app.slides.duplicateCurrentSlide()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="שכפל שקף נוכחי">
                        <i class="fas fa-copy ml-1"></i> שכפל
                    </button>
                </div>
            </div>

            <!-- קנבס השקף -->
            <div class="flex-1 overflow-auto p-8 flex justify-center items-center">
                <div id="slideCanvas" class="slide-canvas w-full max-w-5xl">
                    <div class="w-full h-full flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <i class="fas fa-presentation text-6xl mb-6 opacity-30"></i>
                            <p class="text-2xl font-semibold">בחר שקף או צור חדש</p>
                            <p class="text-lg mt-2">התחל ליצור מצגות מדהימות עם AI</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- פאנל עיצוב תחתון -->
            <div class="bg-white bg-opacity-90 backdrop-blur-lg border-t border-gray-200 p-4">
                <div class="flex justify-between items-center">
                    <div class="flex gap-4 items-center">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">עיצוב:</label>
                            <select id="layoutSelector" onchange="app.slides.changeCurrentLayout(this.value)" 
                                    class="border-2 border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="standard">סטנדרטי</option>
                                <option value="centered">ממורכז</option>
                                <option value="split">מפוצל</option>
                                <option value="minimal">מינימלי</option>
                                <option value="creative">קריאייטיבי</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">צבע רקע:</label>
                            <input type="color" id="bgColorPicker" 
                                   onchange="app.slides.updateSlideStyle('backgroundColor', this.value)"
                                   class="w-10 h-10 rounded cursor-pointer border-2 border-gray-300">
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">צבע טקסט:</label>
                            <input type="color" id="textColorPicker" 
                                   onchange="app.slides.updateSlideStyle('textColor', this.value)"
                                   class="w-10 h-10 rounded cursor-pointer border-2 border-gray-300">
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">תבנית רקע:</label>
                            <select id="patternSelector" onchange="app.slides.updateSlideStyle('pattern', this.value)"
                                    class="border-2 border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">אין</option>
                                <option value="dots">נקודות</option>
                                <option value="grid">רשת</option>
                                <option value="diagonal">אלכסוני</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <span id="autoSaveStatus" class="text-green-600 font-medium">
                            <i class="fas fa-check-circle ml-1"></i> נשמר אוטומטית
                        </span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- מודאל הגדרות -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-cog"></i> הגדרות מערכת
                </h3>
                <button onclick="app.ui.toggleSettings()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-key ml-2 text-purple-600"></i>
                        Gemini API Key
                    </label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" 
                               class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-purple-300 focus:border-purple-500 text-lg" 
                               placeholder="הדבק את המפתח שלך כאן...">
                        <button onclick="app.settings.saveApiKey()" 
                                class="absolute left-2 top-2 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
                            שמור
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-info-circle ml-1"></i>
                        המפתח נשמר מקומית בדפדפן שלך בלבד - אין העברה לשרת
                    </p>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                       class="text-sm text-purple-600 hover:text-purple-800 font-medium mt-2 inline-block">
                        <i class="fas fa-external-link-alt ml-1"></i>
                        קבל מפתח API בחינם מ-Google
                    </a>
                </div>

                <div class="border-t-2 pt-6">
                    <h4 class="font-bold text-lg text-gray-800 mb-3">
                        <i class="fas fa-history ml-2 text-indigo-600"></i>
                        ניהול גרסאות
                    </h4>
                    <div id="versionList" class="max-h-40 overflow-y-auto space-y-2 border-2 rounded-xl p-4 bg-gray-50">
                        <p class="text-gray-500 text-center">אין גרסאות שמורות</p>
                    </div>
                    <button onclick="app.history.saveVersion()" 
                            class="mt-3 w-full bg-indigo-50 text-indigo-700 border-2 border-indigo-200 px-4 py-3 rounded-xl hover:bg-indigo-100 transition font-semibold">
                        <i class="fas fa-save ml-2"></i>
                        שמור גרסה נוכחית
                    </button>
                </div>

                <div class="border-t-2 pt-6">
                    <button onclick="app.settings.clearAllData()" 
                            class="w-full bg-red-50 text-red-600 border-2 border-red-200 px-4 py-3 rounded-xl hover:bg-red-100 transition font-semibold">
                        <i class="fas fa-trash-alt ml-2"></i>
                        מחק את כל הנתונים ואפס את המערכת
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודאל סיכום טקסט -->
    <div id="summaryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-file-import"></i> סיכום טקסט למצגת
                </h3>
                <button onclick="app.ui.closeSummaryModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8">
                <textarea id="textToSummarize" 
                          class="w-full h-64 border-2 border-gray-300 rounded-xl p-4 outline-none focus:ring-4 focus:ring-green-300 focus:border-green-500 text-lg" 
                          placeholder="הדבק כאן טקסט ארוך (מאמר, דו״ח, פרק מספר) והמערכת תמיר אותו למצגת מסודרת..."></textarea>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="app.ui.closeSummaryModal()" 
                            class="btn-secondary px-6 py-3">
                        ביטול
                    </button>
                    <button onclick="app.ai.processSummary()" 
                            class="bg-gradient-to-r from-green-600 to-teal-600 text-white px-8 py-3 rounded-xl hover:opacity-90 transition font-semibold shadow-lg">
                        <i class="fas fa-magic ml-2"></i>
                        צור שקפים מהטקסט
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודאל גלריית תבניות -->
    <div id="templateModal" class="modal" style="display: none;">
        <div class="modal-content max-w-4xl">
            <div class="bg-gradient-to-r from-pink-600 to-purple-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-palette"></i> בחר תבנית עיצוב
                </h3>
                <button onclick="app.ui.closeTemplateGallery()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8">
                <div id="templateGrid" class="template-grid">
                    <!-- תבניות יווצרו דינמית -->
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ========================================
         * SlideGenius AI Pro - Application Core
         * מערכת מתקדמת ליצירת מצגות עם בינה מלאכותית
         * ========================================
         */

        // ========================================
        // Utility Classes & Helpers
        // ========================================

        class Utils {
            static generateId() {
                return '_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            }

            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            static getContrastColor(hexcolor) {
                if (!hexcolor || hexcolor === 'transparent') return '#000000';
                hexcolor = hexcolor.replace("#", "");
                if (hexcolor.length === 3) {
                    hexcolor = hexcolor[0] + hexcolor[0] + hexcolor[1] + hexcolor[1] + hexcolor[2] + hexcolor[2];
                }
                const r = parseInt(hexcolor.substr(0, 2), 16);
                const g = parseInt(hexcolor.substr(2, 2), 16);
                const b = parseInt(hexcolor.substr(4, 2), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#000000' : '#ffffff';
            }

            static randomColor() {
                const colors = [
                    '#667eea', '#764ba2', '#f093fb', '#4facfe',
                    '#43e97b', '#38f9d7', '#fa709a', '#fee140',
                    '#30cfd0', '#330867', '#a8edea', '#fed6e3',
                    '#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            static generateGradient() {
                const color1 = Utils.randomColor();
                const color2 = Utils.randomColor();
                const angle = Math.floor(Math.random() * 360);
                return `linear-gradient(${angle}deg, ${color1}, ${color2})`;
            }

            static escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ========================================
        // Design Templates System
        // ========================================

        class DesignTemplates {
            constructor() {
                this.templates = [
                    {
                        id: 'modern_clean',
                        name: 'מודרני נקי',
                        preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        style: {
                            backgroundColor: '#ffffff',
                            textColor: '#1f2937',
                            accentColor: '#667eea',
                            font: 'Heebo',
                            titleSize: '3rem',
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'dark_elegant',
                        name: 'כהה אלגנטי',
                        preview: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
                        style: {
                            backgroundColor: '#1a1a2e',
                            textColor: '#f0f0f0',
                            accentColor: '#e94560',
                            font: 'Assistant',
                            titleSize: '2.8rem',
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'colorful_vibrant',
                        name: 'צבעוני ותוסס',
                        preview: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        style: {
                            backgroundColor: '#fff7ed',
                            textColor: '#7c2d12',
                            accentColor: '#f97316',
                            font: 'Rubik',
                            titleSize: '3.2rem',
                            layout: 'centered',
                            pattern: 'dots'
                        }
                    },
                    {
                        id: 'minimal_pro',
                        name: 'מינימליסטי מקצועי',
                        preview: 'linear-gradient(135deg, #fafafa 0%, #e5e5e5 100%)',
                        style: {
                            backgroundColor: '#fafafa',
                            textColor: '#0a0a0a',
                            accentColor: '#000000',
                            font: 'Heebo',
                            titleSize: '2.5rem',
                            layout: 'minimal'
                        }
                    },
                    {
                        id: 'ocean_breeze',
                        name: 'נשימת האוקיינוס',
                        preview: 'linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%)',
                        style: {
                            backgroundColor: '#e0f2fe',
                            textColor: '#0c4a6e',
                            accentColor: '#0284c7',
                            font: 'Assistant',
                            titleSize: '3rem',
                            layout: 'split',
                            pattern: 'grid'
                        }
                    },
                    {
                        id: 'sunset_glow',
                        name: 'זוהר השקיעה',
                        preview: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #feada6 100%)',
                        style: {
                            backgroundColor: '#fff1f2',
                            textColor: '#881337',
                            accentColor: '#e11d48',
                            font: 'Rubik',
                            titleSize: '3.5rem',
                            layout: 'centered'
                        }
                    },
                    {
                        id: 'forest_green',
                        name: 'ירוק יער',
                        preview: 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)',
                        style: {
                            backgroundColor: '#f0fdf4',
                            textColor: '#14532d',
                            accentColor: '#16a34a',
                            font: 'Heebo',
                            titleSize: '2.8rem',
                            layout: 'standard',
                            pattern: 'diagonal'
                        }
                    },
                    {
                        id: 'corporate_blue',
                        name: 'כחול עסקי',
                        preview: 'linear-gradient(135deg, #2e3192 0%, #1bffff 100%)',
                        style: {
                            backgroundColor: '#f8fafc',
                            textColor: '#0f172a',
                            accentColor: '#1e40af',
                            font: 'Assistant',
                            titleSize: '2.6rem',
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'creative_purple',
                        name: 'סגול קריאייטיבי',
                        preview: 'linear-gradient(135deg, #7028e4 0%, #e5b2ca 100%)',
                        style: {
                            backgroundColor: '#faf5ff',
                            textColor: '#581c87',
                            accentColor: '#9333ea',
                            font: 'Rubik',
                            titleSize: '3.4rem',
                            layout: 'creative',
                            pattern: 'dots'
                        }
                    },
                    {
                        id: 'warm_autumn',
                        name: 'סתיו חם',
                        preview: 'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                        style: {
                            backgroundColor: '#fffbeb',
                            textColor: '#78350f',
                            accentColor: '#d97706',
                            font: 'Heebo',
                            titleSize: '3rem',
                            layout: 'split'
                        }
                    }
                ];
            }

            getAllTemplates() {
                return this.templates;
            }

            getTemplateById(id) {
                return this.templates.find(t => t.id === id);
            }

            getRandomTemplate() {
                return this.templates[Math.floor(Math.random() * this.templates.length)];
            }
        }

        // ========================================
        // Slide Manager - ניהול שקפים
        // ========================================

        class SlideManager {
            constructor() {
                this.slides = [];
                this.currentSlideIndex = -1;
                this.sortable = null;
            }

            addNewSlide(type = 'content') {
                app.history.saveState();
                
                const template = app.templates.getRandomTemplate();
                
                const newSlide = {
                    id: Utils.generateId(),
                    title: 'כותרת שקף חדש',
                    content: ['נקודה ראשונה', 'נקודה שניה', 'נקודה שלישית'],
                    image: '',
                    notes: '',
                    layout: template.style.layout,
                    style: { ...template.style }
                };

                this.slides.push(newSlide);
                this.currentSlideIndex = this.slides.length - 1;
                this.refreshAll();
                app.ui.showToast('שקף חדש נוצר בהצלחה!', 'success');
            }

            loadSlides(slidesData, index = 0) {
                this.slides = slidesData;
                this.currentSlideIndex = slidesData.length > 0 ? index : -1;
                this.refreshAll();
            }

            refreshAll() {
                this.renderSlideList();
                this.renderCurrentSlide();
                this.updateSlideCount();
                this.saveToLocalStorage();
            }

            renderSlideList() {
                const container = document.getElementById('slidesList');
                if (this.slides.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 mt-20">
                            <i class="fas fa-images text-5xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium">אין שקפים עדיין</p>
                            <p class="text-sm mt-2">צור מצגת חדשה כדי להתחיל</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.slides.map((slide, index) => `
                    <div class="slide-card p-4 ${index === this.currentSlideIndex ? 'active' : ''}" 
                         data-slide-id="${slide.id}"
                         onclick="app.slides.selectSlide(${index})">
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded">
                                ${index + 1}
                            </span>
                            <button onclick="event.stopPropagation(); app.slides.deleteSlide(${index})" 
                                    class="text-red-400 hover:text-red-600 transition">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                        <div class="aspect-video bg-gradient-to-br from-gray-100 to-gray-200 rounded mb-2 overflow-hidden flex items-center justify-center text-xs text-gray-600 font-medium"
                             style="background: ${slide.style?.backgroundColor || '#fff'}; color: ${slide.style?.textColor || '#000'};">
                            ${slide.title.substring(0, 30)}${slide.title.length > 30 ? '...' : ''}
                        </div>
                        <p class="text-xs text-gray-600 font-medium truncate">${slide.title}</p>
                    </div>
                `).join('');

                this.initSortable();
            }

            initSortable() {
                const container = document.getElementById('slidesList');
                if (this.sortable) {
                    this.sortable.destroy();
                }
                
                this.sortable = Sortable.create(container, {
                    animation: 200,
                    ghostClass: 'opacity-50',
                    onEnd: (evt) => {
                        app.history.saveState();
                        const item = this.slides.splice(evt.oldIndex, 1)[0];
                        this.slides.splice(evt.newIndex, 0, item);
                        this.currentSlideIndex = evt.newIndex;
                        this.refreshAll();
                    }
                });
            }

            selectSlide(index) {
                if (index >= 0 && index < this.slides.length) {
                    this.currentSlideIndex = index;
                    this.refreshAll();
                }
            }

            deleteSlide(index) {
                if (confirm('האם אתה בטוח שברצונך למחוק את השקף?')) {
                    app.history.saveState();
                    this.slides.splice(index, 1);
                    if (this.currentSlideIndex >= this.slides.length) {
                        this.currentSlideIndex = this.slides.length - 1;
                    }
                    this.refreshAll();
                    app.ui.showToast('השקף נמחק', 'success');
                }
            }

            duplicateCurrentSlide() {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                const currentSlide = this.slides[this.currentSlideIndex];
                const duplicated = JSON.parse(JSON.stringify(currentSlide));
                duplicated.id = Utils.generateId();
                duplicated.title = duplicated.title + ' (עותק)';
                
                this.slides.splice(this.currentSlideIndex + 1, 0, duplicated);
                this.currentSlideIndex++;
                this.refreshAll();
                app.ui.showToast('השקף שוכפל בהצלחה!', 'success');
            }

            updateSlideContent(field, value) {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                const slide = this.slides[this.currentSlideIndex];
                slide[field] = value;
                this.refreshAll();
            }

            updateSlideStyle(property, value) {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                const slide = this.slides[this.currentSlideIndex];
                if (!slide.style) slide.style = {};
                slide.style[property] = value;
                this.renderCurrentSlide();
                this.saveToLocalStorage();
            }

            changeCurrentLayout(layoutType) {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                const slide = this.slides[this.currentSlideIndex];
                slide.layout = layoutType;
                this.renderCurrentSlide();
            }

            renderCurrentSlide() {
                const canvas = document.getElementById('slideCanvas');
                
                if (this.currentSlideIndex === -1 || this.slides.length === 0) {
                    canvas.innerHTML = `
                        <div class="w-full h-full flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-presentation text-6xl mb-6 opacity-30"></i>
                                <p class="text-2xl font-semibold">בחר שקף או צור חדש</p>
                                <p class="text-lg mt-2">התחל ליצור מצגות מדהימות עם AI</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const slide = this.slides[this.currentSlideIndex];
                const style = slide.style || {};
                
                const bgColor = style.backgroundColor || '#ffffff';
                const textColor = style.textColor || '#1f2937';
                const accentColor = style.accentColor || '#667eea';
                const font = style.font || 'Heebo';
                const titleSize = style.titleSize || '2.5rem';
                const pattern = style.pattern || '';
                
                let patternClass = '';
                if (pattern === 'dots') patternClass = 'pattern-dots';
                else if (pattern === 'grid') patternClass = 'pattern-grid';
                else if (pattern === 'diagonal') patternClass = 'pattern-diagonal';

                const layoutClass = `slide-layout-${slide.layout || 'standard'}`;

                let slideHtml = '';

                switch (slide.layout) {
                    case 'centered':
                        slideHtml = `
                            <div class="w-full h-full flex flex-col items-center justify-center text-center p-12 ${patternClass}"
                                 style="background: ${bgColor}; color: ${textColor}; font-family: ${font};">
                                <h1 contenteditable="true" 
                                    onblur="app.slides.updateSlideContent('title', this.textContent)"
                                    class="font-bold mb-6"
                                    style="color: ${accentColor}; font-size: ${titleSize};">
                                    ${slide.title}
                                </h1>
                                <div class="space-y-3 text-xl max-w-2xl">
                                    ${slide.content.map((item, i) => `
                                        <p contenteditable="true" 
                                           onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                           class="leading-relaxed">
                                            ${item}
                                        </p>
                                    `).join('')}
                                </div>
                                ${slide.image ? `
                                    <img src="${slide.image}" 
                                         onerror="this.src='https://image.pollinations.ai/prompt/placeholder?width=800&height=600&nologo=true'" 
                                         class="mt-8 rounded-2xl shadow-2xl max-w-md w-full h-64 object-cover">
                                ` : ''}
                            </div>
                        `;
                        break;

                    case 'split':
                        slideHtml = `
                            <div class="w-full h-full grid grid-cols-2 gap-8 p-12 ${patternClass}"
                                 style="background: ${bgColor}; color: ${textColor}; font-family: ${font};">
                                <div class="flex flex-col justify-center">
                                    <h1 contenteditable="true" 
                                        onblur="app.slides.updateSlideContent('title', this.textContent)"
                                        class="font-bold mb-6"
                                        style="color: ${accentColor}; font-size: ${titleSize};">
                                        ${slide.title}
                                    </h1>
                                    <ul class="space-y-3 text-lg">
                                        ${slide.content.map((item, i) => `
                                            <li class="flex items-start gap-3">
                                                <i class="fas fa-check-circle mt-1" style="color: ${accentColor};"></i>
                                                <span contenteditable="true" 
                                                      onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                      class="flex-1">
                                                    ${item}
                                                </span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <div class="flex items-center justify-center">
                                    ${slide.image ? `
                                        <img src="${slide.image}" 
                                             onerror="this.src='https://image.pollinations.ai/prompt/placeholder?width=800&height=600&nologo=true'" 
                                             class="rounded-2xl shadow-2xl w-full h-full object-cover">
                                    ` : `
                                        <div class="w-full h-full rounded-2xl bg-gray-200 flex items-center justify-center text-gray-400">
                                            <i class="fas fa-image text-6xl"></i>
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;
                        break;

                    case 'minimal':
                        slideHtml = `
                            <div class="w-full h-full flex flex-col p-16 ${patternClass}"
                                 style="background: ${bgColor}; color: ${textColor}; font-family: ${font};">
                                <h1 contenteditable="true" 
                                    onblur="app.slides.updateSlideContent('title', this.textContent)"
                                    class="font-light mb-12 border-b-4 pb-4"
                                    style="color: ${accentColor}; font-size: ${titleSize}; border-color: ${accentColor};">
                                    ${slide.title}
                                </h1>
                                <div class="flex-1 flex items-center">
                                    <ul class="space-y-4 text-xl">
                                        ${slide.content.map((item, i) => `
                                            <li contenteditable="true" 
                                                onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                class="leading-relaxed">
                                                — ${item}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                        break;

                    case 'creative':
                        slideHtml = `
                            <div class="w-full h-full relative overflow-hidden p-12 ${patternClass}"
                                 style="background: ${bgColor}; color: ${textColor}; font-family: ${font};">
                                ${slide.image ? `
                                    <img src="${slide.image}" 
                                         onerror="this.src='https://image.pollinations.ai/prompt/placeholder?width=800&height=600&nologo=true'" 
                                         class="absolute inset-0 w-full h-full object-cover opacity-20">
                                ` : ''}
                                <div class="relative z-10 h-full flex flex-col justify-between">
                                    <h1 contenteditable="true" 
                                        onblur="app.slides.updateSlideContent('title', this.textContent)"
                                        class="font-black text-right"
                                        style="color: ${accentColor}; font-size: ${titleSize}; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                                        ${slide.title}
                                    </h1>
                                    <div class="bg-white bg-opacity-90 backdrop-blur-md p-8 rounded-3xl shadow-2xl">
                                        <ul class="space-y-3 text-lg">
                                            ${slide.content.map((item, i) => `
                                                <li class="flex items-start gap-3">
                                                    <span class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-white"
                                                          style="background: ${accentColor};">
                                                        ${i + 1}
                                                    </span>
                                                    <span contenteditable="true" 
                                                          onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                          class="flex-1 pt-1">
                                                        ${item}
                                                    </span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;

                    default: // standard
                        slideHtml = `
                            <div class="w-full h-full flex flex-col p-12 ${patternClass}"
                                 style="background: ${bgColor}; color: ${textColor}; font-family: ${font};">
                                <h1 contenteditable="true" 
                                    onblur="app.slides.updateSlideContent('title', this.textContent)"
                                    class="font-bold mb-8"
                                    style="color: ${accentColor}; font-size: ${titleSize};">
                                    ${slide.title}
                                </h1>
                                <div class="flex-1 grid ${slide.image ? 'grid-cols-2' : 'grid-cols-1'} gap-8">
                                    <div>
                                        <ul class="space-y-4 text-xl">
                                            ${slide.content.map((item, i) => `
                                                <li class="flex items-start gap-3">
                                                    <span class="text-2xl" style="color: ${accentColor};">•</span>
                                                    <span contenteditable="true" 
                                                          onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                          class="flex-1 leading-relaxed">
                                                        ${item}
                                                    </span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    ${slide.image ? `
                                        <div class="flex items-center justify-center">
                                            <img src="${slide.image}" 
                                                 onerror="this.src='https://image.pollinations.ai/prompt/placeholder?width=800&height=600&nologo=true'" 
                                                 class="rounded-2xl shadow-2xl w-full h-full object-cover max-h-96">
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                }

                canvas.innerHTML = slideHtml;
            }

            updateContentItem(index, newText) {
                if (this.currentSlideIndex === -1) return;
                app.history.saveState();
                this.slides[this.currentSlideIndex].content[index] = newText;
                this.saveToLocalStorage();
            }

            updateSlideCount() {
                document.getElementById('slideCount').textContent = this.slides.length;
            }

            saveToLocalStorage() {
                const debouncedSave = Utils.debounce(() => {
                    try {
                        localStorage.setItem('slidegenius_slides', JSON.stringify(this.slides));
                        localStorage.setItem('slidegenius_current_index', this.currentSlideIndex);
                        app.ui.updateSaveStatus(true);
                    } catch (e) {
                        console.error('Save error:', e);
                        app.ui.updateSaveStatus(false);
                    }
                }, 500);
                debouncedSave();
            }

            loadFromLocalStorage() {
                try {
                    const savedSlides = localStorage.getItem('slidegenius_slides');
                    const savedIndex = localStorage.getItem('slidegenius_current_index');
                    
                    if (savedSlides) {
                        this.slides = JSON.parse(savedSlides);
                        this.currentSlideIndex = savedIndex ? parseInt(savedIndex) : 0;
                        this.refreshAll();
                    }
                } catch (e) {
                    console.error('Load error:', e);
                }
            }
        }

        // ========================================
        // AI Manager - ניהול בינה מלאכותית
        // ========================================

        class AIManager {
            constructor() {
                this.apiEndpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';
                this.apiKey = null;
            }

            getApiKey() {
                if (!this.apiKey) {
                    this.apiKey = localStorage.getItem('gemini_api_key');
                }
                return this.apiKey;
            }

            async callGemini(promptText, systemInstruction = "") {
                const apiKey = this.getApiKey();
                if (!apiKey) {
                    app.ui.showToast('נא להזין מפתח API בהגדרות', 'error');
                    app.ui.toggleSettings();
                    throw new Error('No API Key');
                }

                app.ui.showLoading(true, 'ה-AI עובד על הבקשה שלך...');

                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: promptText }]
                        }],
                        generationConfig: {
                            temperature: 0.8,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                            responseMimeType: "application/json"
                        }
                    };

                    if (systemInstruction) {
                        payload.systemInstruction = { parts: [{ text: systemInstruction }] };
                    }

                    const response = await fetch(`${this.apiEndpoint}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || 'API Error');
                    }

                    const data = await response.json();
                    const textResponse = data.candidates[0].content.parts[0].text;
                    
                    // ניקוי התגובה מסימנים מיותרים
                    let cleanedText = textResponse.trim();
                    if (cleanedText.startsWith('\`\`\`json')) {
                        cleanedText = cleanedText.substring(7);
                    }
                    if (cleanedText.startsWith('\`\`\`')) {
                        cleanedText = cleanedText.substring(3);
                    }
                    if (cleanedText.endsWith('\`\`\`')) {
                        cleanedText = cleanedText.substring(0, cleanedText.length - 3);
                    }
                    
                    return JSON.parse(cleanedText.trim());

                } catch (error) {
                    console.error('Gemini Error:', error);
                    app.ui.showToast('שגיאה בתקשורת עם AI: ' + error.message, 'error');
                    return null;
                } finally {
                    app.ui.showLoading(false);
                }
            }

            async generateFullPresentation() {
                const topic = document.getElementById('aiPromptInput').value.trim();
                if (!topic) {
                    app.ui.showToast('נא להזין נושא למצגת', 'error');
                    return;
                }

                const systemPrompt = `
אתה מומחה מקצועי ליצירת מצגות PowerPoint מרהיבות.
המשתמש ביקש מצגת על הנושא: "${topic}"

עליך להחזיר מערך JSON של שקפים, כאשר כל שקף הוא אובייקט במבנה הבא:
{
    "title": "כותרת השקף בעברית",
    "content": ["נקודה 1", "נקודה 2", "נקודה 3"],
    "imageKeyword": "מילת מפתח באנגלית לתמונה (1-3 מילים)",
    "notes": "הערות למרצה והסברים נוספים"
}

דרישות חשובות:
1. צור בין 6-10 שקפים איכותיים (תלוי במורכבות הנושא)
2. כל שקף צריך להיות ממוקד ועם 3-5 נקודות עיקריות
3. התוכן בעברית ברמה גבוהה, מקצועי ומעניין
4. ה-imageKeyword באנגלית בלבד - תיאור ויזואלי של תמונה רלוונטית
5. השקף הראשון יהיה שקף פתיחה עם כותרת ראשית
6. השקף האחרון יהיה שקף סיכום
7. השקפים באמצע יפרטו את הנושא באופן לוגי ומסודר

החזר רק את מערך ה-JSON, בלי הסברים נוספים.
`;

                const result = await this.callGemini(`צור מצגת מקצועית על הנושא: ${topic}`, systemPrompt);
                
                if (result && Array.isArray(result)) {
                    app.history.saveState();
                    
                    const processedSlides = result.map(s => {
                        const template = app.templates.getRandomTemplate();
                        return {
                            id: Utils.generateId(),
                            title: s.title || 'כותרת',
                            content: Array.isArray(s.content) ? s.content : ['תוכן'],
                            image: s.imageKeyword ? 
                                `https://image.pollinations.ai/prompt/${encodeURIComponent(s.imageKeyword)}?width=1200&height=800&nologo=true&enhance=true&model=flux&seed=${Date.now()}` : 
                                '',
                            notes: s.notes || '',
                            layout: template.style.layout,
                            style: { ...template.style }
                        };
                    });
                    
                    app.slides.loadSlides(processedSlides);
                    app.ui.showToast(`המצגת נוצרה בהצלחה! ${processedSlides.length} שקפים`, 'success');
                    document.getElementById('aiPromptInput').value = '';
                }
            }

            async suggestImage() {
                if (app.slides.currentSlideIndex === -1) {
                    app.ui.showToast('בחר שקף תחילה', 'error');
                    return;
                }
                
                const slide = app.slides.slides[app.slides.currentSlideIndex];
                
                const prompt = `
עבור שקף מצגת עם:
כותרת: "${slide.title}"
תוכן: "${slide.content.join(', ')}"

תן לי מילת מפתח באנגלית (1-3 מילים) לחיפוש תמונה מתאימה.
התמונה צריכה להמחיש את הנושא בצורה ויזואלית מרשימה ומקצועית.

החזר JSON בפורמט:
{ "keyword": "your keyword here" }
`;

                const result = await this.callGemini(prompt);
                if (result && result.keyword) {
                    const newImageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(result.keyword)}?width=1200&height=800&nologo=true&enhance=true&model=flux&seed=${Date.now()}`;
                    app.slides.updateSlideContent('image', newImageUrl);
                    app.ui.showToast('תמונה חדשה נוצרה!', 'success');
                }
            }

            async proofreadCurrentSlide() {
                if (app.slides.currentSlideIndex === -1) {
                    app.ui.showToast('בחר שקף תחילה', 'error');
                    return;
                }
                
                const slide = app.slides.slides[app.slides.currentSlideIndex];
                
                const prompt = `
תקן שגיאות כתיב, דקדוק ושפר את הניסוח של השקף הבא.
שמור על אותו מבנה ומספר נקודות, רק שפר את האיכות.

כותרת: ${slide.title}
תוכן: ${JSON.stringify(slide.content, null, 2)}

החזר JSON:
{
    "title": "כותרת משופרת",
    "content": ["נקודה משופרת 1", "נקודה משופרת 2", ...]
}
`;

                const result = await this.callGemini(prompt);
                if (result && result.title && result.content) {
                    app.history.saveState();
                    slide.title = result.title;
                    slide.content = result.content;
                    app.slides.refreshAll();
                    app.ui.showToast('הטקסט שופר בהצלחה!', 'success');
                }
            }

            async generateQuizSlide() {
                if (app.slides.slides.length === 0) {
                    app.ui.showToast('צור מצגת תחילה', 'error');
                    return;
                }

                const slidesContent = app.slides.slides
                    .map(s => `${s.title}: ${s.content.join(", ")}`)
                    .join("\n\n");
                
                const prompt = `
בהתבסס על תוכן המצגת הבא, צור שקף חידון אמריקאי מאתגר.

תוכן המצגת:
${slidesContent}

החזר JSON:
{
    "title": "חידון: [נושא]",
    "content": [
        "שאלה: [שאלה מעניינת ומאתגרת]",
        "א. [תשובה 1]",
        "ב. [תשובה 2]",
        "ג. [תשובה 3]",
        "ד. [תשובה 4]"
    ],
    "notes": "התשובה הנכונה: [אות]. הסבר: ..."
}
`;

                const result = await this.callGemini(prompt);
                if (result) {
                    app.history.saveState();
                    
                    const template = app.templates.getTemplateById('colorful_vibrant') || app.templates.getRandomTemplate();
                    
                    app.slides.slides.push({
                        id: Utils.generateId(),
                        title: result.title,
                        content: result.content,
                        image: `https://image.pollinations.ai/prompt/quiz question mark trivia game?width=1200&height=800&nologo=true&enhance=true&seed=${Date.now()}`,
                        notes: result.notes,
                        layout: 'centered',
                        style: { ...template.style }
                    });
                    
                    app.slides.currentSlideIndex = app.slides.slides.length - 1;
                    app.slides.refreshAll();
                    app.ui.showToast('שקף חידון נוצר!', 'success');
                }
            }

            async processSummary() {
                const text = document.getElementById('textToSummarize').value.trim();
                if (!text) {
                    app.ui.showToast('נא להזין טקסט לסיכום', 'error');
                    return;
                }
                
                app.ui.closeSummaryModal();

                const prompt = `
סכם את הטקסט הבא ל-4 עד 7 שקפי מצגת.
כל שקף צריך להתמקד בנקודה מרכזית אחת עם פירוט.

הטקסט:
${text.substring(0, 15000)}

החזר מערך JSON של שקפים:
[
    {
        "title": "כותרת השקף",
        "content": ["נקודה 1", "נקודה 2", "נקודה 3"],
        "imageKeyword": "מילת מפתח באנגלית לתמונה"
    }
]
`;

                const result = await this.callGemini(prompt);
                if (result && Array.isArray(result)) {
                    app.history.saveState();
                    
                    const newSlides = result.map(s => {
                        const template = app.templates.getRandomTemplate();
                        return {
                            id: Utils.generateId(),
                            title: s.title,
                            content: s.content,
                            image: s.imageKeyword ? 
                                `https://image.pollinations.ai/prompt/${encodeURIComponent(s.imageKeyword)}?width=1200&height=800&nologo=true&enhance=true&seed=${Date.now()}` : 
                                '',
                            notes: 'נוצר מסיכום אוטומטי',
                            layout: template.style.layout,
                            style: { ...template.style }
                        };
                    });
                    
                    // שאל את המשתמש אם להוסיף או להחליף
                    if (app.slides.slides.length > 0) {
                        if (confirm('האם להחליף את המצגת הקיימת או להוסיף את השקפים החדשים?')) {
                            app.slides.loadSlides([...app.slides.slides, ...newSlides]);
                        } else {
                            app.slides.loadSlides(newSlides);
                        }
                    } else {
                        app.slides.loadSlides(newSlides);
                    }
                    
                    app.ui.showToast(`${newSlides.length} שקפים נוצרו מהטקסט!`, 'success');
                    document.getElementById('textToSummarize').value = '';
                }
            }
        }

        // ========================================
        // Export Manager - ייצוא PPTX
        // ========================================

        class ExportManager {
            async exportToPptx() {
                if (app.slides.slides.length === 0) {
                    app.ui.showToast('אין שקפים לייצוא', 'error');
                    return;
                }

                app.ui.showLoading(true, 'מייצא את המצגת...');

                try {
                    const pptx = new PptxGenJS();
                    pptx.layout = 'LAYOUT_16x9';
                    pptx.rtlMode = true;

                    pptx.author = 'SlideGenius AI Pro';
                    pptx.title = app.slides.slides[0]?.title || 'Presentation';
                    pptx.subject = 'Created with SlideGenius AI';

                    for (const slideData of app.slides.slides) {
                        const slide = pptx.addSlide();
                        const style = slideData.style || {};
                        
                        const bgColor = (style.backgroundColor || '#ffffff').replace('#', '');
                        const textColor = (style.textColor || '#000000').replace('#', '');
                        const accentColor = (style.accentColor || '#667eea').replace('#', '');

                        slide.background = { color: bgColor };

                        // כותרת
                        slide.addText(slideData.title, {
                            x: 0.5,
                            y: 0.5,
                            w: '90%',
                            h: 1.2,
                            fontSize: 36,
                            bold: true,
                            color: accentColor,
                            align: 'right',
                            fontFace: 'Arial',
                            rtlMode: true
                        });

                        // תוכן
                        const contentText = slideData.content.map(item => ({
                            text: item,
                            options: { breakLine: true }
                        }));

                        slide.addText(contentText, {
                            x: 0.5,
                            y: 2,
                            w: slideData.image ? '45%' : '90%',
                            h: 4,
                            fontSize: 20,
                            color: textColor,
                            align: 'right',
                            fontFace: 'Arial',
                            bullet: { code: '2022' },
                            rtlMode: true,
                            valign: 'top'
                        });

                        // תמונה
                        if (slideData.image) {
                            try {
                                slide.addImage({
                                    path: slideData.image,
                                    x: '52%',
                                    y: 2,
                                    w: '45%',
                                    h: 4.5,
                                    sizing: { type: 'contain', w: '45%', h: 4.5 }
                                });
                            } catch (imgError) {
                                console.warn('Image load failed for slide, skipping:', imgError);
                                // אם התמונה נכשלת, פשוט ממשיכים בלי תמונה
                            }
                        }

                        // הערות
                        if (slideData.notes) {
                            slide.addNotes(slideData.notes);
                        }
                    }

                    const fileName = `SlideGenius_${new Date().toISOString().slice(0, 10)}_${Date.now()}.pptx`;
                    
                    await pptx.writeFile({ fileName: fileName });
                    
                    app.ui.showToast('המצגת יוצאה בהצלחה! 🎉', 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    app.ui.showToast('שגיאה בייצוא המצגת: ' + error.message, 'error');
                } finally {
                    app.ui.showLoading(false);
                }
            }
        }

        // ========================================
        // History Manager - ניהול היסטוריה
        // ========================================

        class HistoryManager {
            constructor() {
                this.undoStack = [];
                this.redoStack = [];
                this.maxHistory = 30;
                this.versions = [];
            }

            saveState() {
                const state = JSON.stringify({
                    slides: app.slides.slides,
                    currentIndex: app.slides.currentSlideIndex
                });
                
                if (this.undoStack.length > 0 && this.undoStack[this.undoStack.length - 1] === state) {
                    return;
                }
                
                this.undoStack.push(state);
                if (this.undoStack.length > this.maxHistory) {
                    this.undoStack.shift();
                }
                
                this.redoStack = [];
            }

            undo() {
                if (this.undoStack.length === 0) {
                    app.ui.showToast('אין מה לבטל', 'error');
                    return;
                }
                
                const currentState = JSON.stringify({
                    slides: app.slides.slides,
                    currentIndex: app.slides.currentSlideIndex
                });
                this.redoStack.push(currentState);
                
                const prevState = JSON.parse(this.undoStack.pop());
                app.slides.loadSlides(prevState.slides, prevState.currentIndex);
                app.ui.showToast('בוטל', 'success');
            }

            redo() {
                if (this.redoStack.length === 0) {
                    app.ui.showToast('אין מה לבצע שוב', 'error');
                    return;
                }
                
                const currentState = JSON.stringify({
                    slides: app.slides.slides,
                    currentIndex: app.slides.currentSlideIndex
                });
                this.undoStack.push(currentState);
                
                const nextState = JSON.parse(this.redoStack.pop());
                app.slides.loadSlides(nextState.slides, nextState.currentIndex);
                app.ui.showToast('בוצע שוב', 'success');
            }

            saveVersion() {
                const versionName = prompt('שם הגרסה:', `גרסה ${this.versions.length + 1}`);
                if (!versionName) return;
                
                this.versions.push({
                    id: Utils.generateId(),
                    name: versionName,
                    timestamp: new Date().toISOString(),
                    data: JSON.stringify(app.slides.slides)
                });
                
                localStorage.setItem('slidegenius_versions', JSON.stringify(this.versions));
                this.renderVersionList();
                app.ui.showToast('גרסה נשמרה בהצלחה!', 'success');
            }

            loadVersion(versionId) {
                const version = this.versions.find(v => v.id === versionId);
                if (!version) return;
                
                if (confirm(`האם לטעון את הגרסה "${version.name}"?`)) {
                    app.history.saveState();
                    const slides = JSON.parse(version.data);
                    app.slides.loadSlides(slides);
                    app.ui.showToast(`גרסה "${version.name}" נטענה`, 'success');
                }
            }

            deleteVersion(versionId) {
                if (confirm('האם למחוק את הגרסה?')) {
                    this.versions = this.versions.filter(v => v.id !== versionId);
                    localStorage.setItem('slidegenius_versions', JSON.stringify(this.versions));
                    this.renderVersionList();
                    app.ui.showToast('גרסה נמחקה', 'success');
                }
            }

            renderVersionList() {
                const container = document.getElementById('versionList');
                if (this.versions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">אין גרסאות שמורות</p>';
                    return;
                }
                
                container.innerHTML = this.versions.map(v => {
                    const date = new Date(v.timestamp);
                    return `
                        <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200">
                            <div>
                                <p class="font-semibold text-gray-800">${v.name}</p>
                                <p class="text-xs text-gray-500">${date.toLocaleString('he-IL')}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="app.history.loadVersion('${v.id}')" 
                                        class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="app.history.deleteVersion('${v.id}')" 
                                        class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            loadVersionsFromStorage() {
                try {
                    const saved = localStorage.getItem('slidegenius_versions');
                    if (saved) {
                        this.versions = JSON.parse(saved);
                        this.renderVersionList();
                    }
                } catch (e) {
                    console.error('Error loading versions:', e);
                }
            }
        }

        // ========================================
        // UI Manager - ניהול ממשק משתמש
        // ========================================

        class UIManager {
            showLoading(show, text = 'טוען...') {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                
                if (show) {
                    loadingText.textContent = text;
                    overlay.style.display = 'flex';
                } else {
                    overlay.style.display = 'none';
                }
            }

            showToast(message, type = 'success') {
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                }
                
                const toast = document.createElement('div');
                toast.className = `toast ${type} animate-slideIn`;
                toast.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-${type === 'success' ? 'check-circle text-green-600' : 'exclamation-circle text-red-600'} text-xl"></i>
                        <span class="font-medium text-gray-800">${message}</span>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            toggleSettings() {
                const modal = document.getElementById('settingsModal');
                modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
            }

            showSummaryModal() {
                document.getElementById('summaryModal').style.display = 'flex';
            }

            closeSummaryModal() {
                document.getElementById('summaryModal').style.display = 'none';
            }

            showTemplateGallery() {
                const modal = document.getElementById('templateModal');
                const grid = document.getElementById('templateGrid');
                
                const templates = app.templates.getAllTemplates();
                grid.innerHTML = templates.map(template => `
                    <div class="template-card" 
                         style="background: ${template.preview};"
                         onclick="app.ui.applyTemplateToAll('${template.id}')">
                        <div class="h-full flex items-center justify-center">
                            <div class="bg-white bg-opacity-90 backdrop-blur-sm px-4 py-2 rounded-lg">
                                <p class="font-bold text-gray-800 text-center">${template.name}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                modal.style.display = 'flex';
            }

            closeTemplateGallery() {
                document.getElementById('templateModal').style.display = 'none';
            }

            applyTemplateToAll(templateId) {
                const template = app.templates.getTemplateById(templateId);
                if (!template) return;
                
                if (app.slides.slides.length === 0) {
                    this.showToast('אין שקפים להחיל עליהם תבנית', 'error');
                    return;
                }
                
                if (confirm(`האם להחיל את התבנית "${template.name}" על כל השקפים?`)) {
                    app.history.saveState();
                    
                    app.slides.slides.forEach(slide => {
                        slide.style = { ...template.style };
                        slide.layout = template.style.layout;
                    });
                    
                    app.slides.refreshAll();
                    this.closeTemplateGallery();
                    this.showToast(`תבנית "${template.name}" הוחלה על כל השקפים!`, 'success');
                }
            }

            updateSaveStatus(success) {
                const status = document.getElementById('autoSaveStatus');
                if (success) {
                    status.innerHTML = '<i class="fas fa-check-circle ml-1"></i> נשמר אוטומטית';
                    status.className = 'text-green-600 font-medium';
                } else {
                    status.innerHTML = '<i class="fas fa-exclamation-triangle ml-1"></i> שגיאה בשמירה';
                    status.className = 'text-red-600 font-medium';
                }
            }

            updateApiKeyStatus() {
                const status = document.getElementById('apiKeyStatus');
                const hasKey = !!app.ai.getApiKey();
                
                if (hasKey) {
                    status.innerHTML = '<i class="fas fa-check-circle ml-2"></i> מפתח API מוגדר';
                    status.className = 'text-sm px-4 py-2 rounded-lg bg-green-50 text-green-600 font-semibold border border-green-200';
                } else {
                    status.innerHTML = '<i class="fas fa-key ml-2"></i> נדרש מפתח API';
                    status.className = 'text-sm px-4 py-2 rounded-lg bg-red-50 text-red-600 font-semibold border border-red-200';
                }
            }

            updateHistoryButtons() {
                // ניתן להוסיף כאן עדכון ויזואלי לכפתורי Undo/Redo
            }
        }

        // ========================================
        // Settings Manager - ניהול הגדרות
        // ========================================

        class SettingsManager {
            saveApiKey() {
                const input = document.getElementById('apiKeyInput');
                const key = input.value.trim();
                
                if (!key) {
                    app.ui.showToast('נא להזין מפתח API', 'error');
                    return;
                }
                
                localStorage.setItem('gemini_api_key', key);
                app.ai.apiKey = key;
                app.ui.updateApiKeyStatus();
                app.ui.showToast('מפתח API נשמר בהצלחה!', 'success');
                input.type = 'password';
            }

            clearAllData() {
                if (confirm('האם אתה בטוח? כל המצגות והנתונים יימחקו!')) {
                    if (confirm('אישור אחרון - פעולה זו בלתי הפיכה!')) {
                        localStorage.clear();
                        app.slides.slides = [];
                        app.slides.currentSlideIndex = -1;
                        app.slides.refreshAll();
                        app.history.undoStack = [];
                        app.history.redoStack = [];
                        app.history.versions = [];
                        app.ui.showToast('כל הנתונים נמחקו', 'success');
                        setTimeout(() => location.reload(), 1500);
                    }
                }
            }
        }

        // ========================================
        // Main Application Object
        // ========================================

        const app = {
            slides: new SlideManager(),
            ai: new AIManager(),
            export: new ExportManager(),
            history: new HistoryManager(),
            ui: new UIManager(),
            settings: new SettingsManager(),
            templates: new DesignTemplates()
        };

        // ========================================
        // Initialization
        // ========================================

        window.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 SlideGenius AI Pro - Initializing...');
            
            // טעינת נתונים מהזיכרון
            app.slides.loadFromLocalStorage();
            app.history.loadVersionsFromStorage();
            app.ui.updateApiKeyStatus();
            
            // בדיקה אם יש שקפים, אם לא - הצג הודעת ברוכים הבאים
            if (app.slides.slides.length === 0) {
                setTimeout(() => {
                    app.ui.showToast('ברוכים הבאים ל-SlideGenius AI Pro! 🎉', 'success');
                }, 500);
            }
            
            console.log('✅ System ready!');
        });

        // שמירה אוטומטית לפני סגירת הדף
        window.addEventListener('beforeunload', (e) => {
            if (app.slides.slides.length > 0) {
                app.slides.saveToLocalStorage();
            }
        });

        // קיצורי מקלדת
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z / Cmd+Z - Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                app.history.undo();
            }
            
            // Ctrl+Shift+Z / Cmd+Shift+Z - Redo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                app.history.redo();
            }
            
            // Ctrl+S / Cmd+S - Save Version
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                app.history.saveVersion();
            }
            
            // Ctrl+E / Cmd+E - Export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                app.export.exportToPptx();
            }
        });

        console.log('🎨 SlideGenius AI Pro - Loaded Successfully! Total lines: 1900+');
    </script>
</body>
</html>
