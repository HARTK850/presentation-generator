<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideGenius AI Pro - מחולל מצגות אוטומטי מתקדם</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@300;400;500;600;700;800;900&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        /* גלילה מותאמת */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* אנימציות */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        /* כרטיס שקף */
        .slide-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .slide-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .slide-card.active {
            border: 3px solid #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .slide-card:active {
            cursor: grabbing;
        }

        /* אזור עריכה */
        .slide-canvas {
            background: white;
            aspect-ratio: 16/9;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        /* מסך טעינה */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* כפתורים מעוצבים */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid #667eea;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* טוסט התראה */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-right: 4px solid #10b981;
        }

        .toast.error {
            border-right: 4px solid #ef4444;
        }
        .toast.info {
            border-right: 4px solid #3b82f6;
        }


        /* עיצוב שקף */
        .slide-layout-standard .slide-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .slide-layout-centered {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .slide-layout-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        /* אפקטים מיוחדים */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* רספונסיביות */
        @media (max-width: 768px) {
            .slide-canvas {
                max-width: 100%;
            }
        }

        /* עיצובים דינמיים */
        .pattern-dots {
            background-image: radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .pattern-grid {
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .pattern-diagonal {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.03) 10px,
                rgba(0,0,0,0.03) 20px
            );
        }

        /* תוכן שקף ניתן לעריכה */
        [contenteditable]:focus {
            outline: 2px solid #667eea;
            outline-offset: 4px;
            border-radius: 4px;
        }

        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
        }

        /* טיפ-טול */
        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 8px;
        }

        /* סגנון מודאל */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        /* גלריית תבניות */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .template-card {
            aspect-ratio: 16/9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .template-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .template-card.selected {
            border-color: #667eea;
        }
    </style>
</head>
<body>

    <!-- מסך טעינה -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
        <h2 class="text-white text-2xl font-bold mt-6" id="loadingText">מעבד את המצגת...</h2>
        <p class="text-gray-300 mt-2">ה-AI עובד קשה בשבילך ⚡</p>
    </div>

    <!-- כותרת עליונה -->
    <header class="bg-white shadow-lg">
        <div class="max-w-screen-2xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-br from-purple-600 to-indigo-600 text-white p-3 rounded-xl shadow-lg">
                    <i class="fas fa-wand-magic-sparkles text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold gradient-text">SlideGenius AI Pro</h1>
                    <p class="text-sm text-gray-500">מחולל מצגות מתקדם עם בינה מלאכותית</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div id="apiKeyStatus" class="text-sm px-4 py-2 rounded-lg bg-red-50 text-red-600 font-semibold border border-red-200">
                    <i class="fas fa-key ml-2"></i> נדרש מפתח API
                </div>
                <button onclick="app.ui.toggleSettings()" class="tooltip btn-secondary" data-tooltip="הגדרות">
                    <i class="fas fa-cog"></i>
                </button>
                <button onclick="app.export.exportToPptx()" class="btn-primary flex items-center gap-2">
                    <i class="fas fa-download"></i>
                    <span>ייצוא PPTX</span>
                </button>
            </div>
        </div>
    </header>

    <!-- אזור ראשי -->
    <main class="flex h-[calc(100vh-80px)] max-w-screen-2xl mx-auto">
        
        <!-- סרגל שקפים -->
        <aside class="w-80 bg-white bg-opacity-95 backdrop-blur-lg flex flex-col shadow-2xl">
            <div class="p-5 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-indigo-50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 text-lg">השקפים שלי</h3>
                    <span id="slideCount" class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-bold">0</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.history.undo()" class="tooltip flex-1 btn-secondary text-sm py-2" data-tooltip="בטל פעולה">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button onclick="app.history.redo()" class="tooltip flex-1 btn-secondary text-sm py-2" data-tooltip="בצע שוב">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button onclick="app.slides.addNewSlide()" class="tooltip flex-1 btn-primary text-sm py-2" data-tooltip="שקף חדש">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div id="slidesList" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="text-center text-gray-400 mt-20">
                    <i class="fas fa-images text-5xl mb-4 opacity-50"></i>
                    <p class="text-lg font-medium">אין שקפים עדיין</p>
                    <p class="text-sm mt-2">צור מצגת חדשה כדי להתחיל</p>
                </div>
            </div>
        </aside>

        <!-- אזור עריכה -->
        <section class="flex-1 flex flex-col bg-gradient-to-br from-purple-100 to-indigo-100 overflow-hidden">
            
            <!-- סרגל כלים -->
            <div class="bg-white bg-opacity-90 backdrop-blur-lg p-4 border-b border-gray-200 shadow-md">
                <div class="flex items-center gap-3 mb-3">
                    <div class="flex-1 relative">
                        <input type="text" id="aiPromptInput" 
                               placeholder="תאר את המצגת שתרצה ליצור... (דוגמה: מצגת על יתרונות הבינה המלאכותית בחינוך)" 
                               class="w-full px-5 py-3 pr-12 border-2 border-purple-200 rounded-xl focus:ring-4 focus:ring-purple-300 focus:border-purple-500 outline-none transition text-lg"
                               onkeypress="if(event.key === 'Enter') app.ai.generateFullPresentation()">
                        <i class="fas fa-sparkles absolute right-4 top-4 text-purple-500 text-xl"></i>
                    </div>
                    <button onclick="app.ai.generateFullPresentation()" class="btn-primary text-lg px-8 py-3 flex items-center gap-3">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>צור מצגת</span>
                    </button>
                </div>

                <!-- כלי AI נוספים -->
                <div class="flex gap-2 flex-wrap">
                    <button onclick="app.ai.proofreadCurrentSlide()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="שיפור טקסט">
                        <i class="fas fa-spell-check ml-1"></i> בדוק דקדוק
                    </button>
                    <button onclick="app.ai.suggestImage()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="רקע חדש מ-AI">
                        <i class="fas fa-image ml-1"></i> רקע חדש
                    </button>
                    <button onclick="app.ui.showSummaryModal()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="המר טקסט למצגת">
                        <i class="fas fa-file-import ml-1"></i> סיכום טקסט
                    </button>
                    <button onclick="app.ai.generateQuizSlide()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="צור שקף חידון">
                        <i class="fas fa-question-circle ml-1"></i> חידון
                    </button>
                    <button onclick="app.ui.showTemplateGallery()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="בחר תבנית עיצוב">
                        <i class="fas fa-palette ml-1"></i> תבניות
                    </button>
                    <button onclick="app.slides.duplicateCurrentSlide()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="שכפל שקף נוכחי">
                        <i class="fas fa-copy ml-1"></i> שכפל
                    </button>
                    <button onclick="app.slides.applyRandomDesign()" class="tooltip btn-secondary text-sm px-4 py-2" data-tooltip="עצב שקף אקראי">
                        <i class="fas fa-magic ml-1"></i> עיצוב אקראי
                    </button>
                </div>
            </div>

            <!-- קנבס השקף -->
            <div class="flex-1 overflow-auto p-8 flex justify-center items-center">
                <div id="slideCanvas" class="slide-canvas w-full max-w-5xl">
                    <div class="w-full h-full flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <i class="fas fa-presentation text-6xl mb-6 opacity-30"></i>
                            <p class="text-2xl font-semibold">בחר שקף או צור חדש</p>
                            <p class="text-lg mt-2">התחל ליצור מצגות מדהימות עם AI</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- פאנל עיצוב תחתון -->
            <div class="bg-white bg-opacity-90 backdrop-blur-lg border-t border-gray-200 p-4">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div class="flex gap-4 items-center flex-wrap">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">פריסה:</label>
                            <select id="layoutSelector" onchange="app.slides.changeCurrentLayout(this.value)" 
                                    class="border-2 border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="standard">סטנדרטי</option>
                                <option value="centered">ממורכז</option>
                                <option value="split">מפוצל</option>
                                <option value="minimal">מינימלי</option>
                                <option value="creative">קריאייטיבי</option>
                                <option value="sidebar">סרגל צד</option>
                                <option value="grid">רשת</option>
                                <option value="asymmetric">אסימטרי</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">צבע רקע:</label>
                            <input type="color" id="bgColorPicker" 
                                   onchange="app.slides.updateSlideStyle('backgroundColor', this.value)"
                                   class="w-10 h-10 rounded cursor-pointer border-2 border-gray-300 p-0.5">
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">צבע טקסט:</label>
                            <input type="color" id="textColorPicker" 
                                   onchange="app.slides.updateSlideStyle('textColor', this.value)"
                                   class="w-10 h-10 rounded cursor-pointer border-2 border-gray-300 p-0.5">
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">צבע הדגשה:</label>
                            <input type="color" id="accentColorPicker" 
                                   onchange="app.slides.updateSlideStyle('accentColor', this.value)"
                                   class="w-10 h-10 rounded cursor-pointer border-2 border-gray-300 p-0.5">
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">תבנית רקע:</label>
                            <select id="patternSelector" onchange="app.slides.updateSlideStyle('pattern', this.value ? JSON.parse(this.value) : null)"
                                    class="border-2 border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">ללא</option>
                                <option value='{"id": "dots", "name": "נקודות", "pattern": "radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px)", "size": "20px 20px"}'>נקודות</option>
                                <option value='{"id": "grid", "name": "רשת", "pattern": "linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px)", "size": "50px 50px"}'>רשת</option>
                                <option value='{"id": "diagonal", "name": "אלכסון", "pattern": "repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px)", "size": "auto"}'>אלכסון</option>
                                <option value='{"id": "zigzag", "name": "זיגזג", "pattern": "linear-gradient(135deg, rgba(0,0,0,0.05) 25%, transparent 25%)", "size": "20px 20px"}'>זיגזג</option>
                                <option value='{"id": "wave", "name": "גלים", "pattern": "repeating-radial-gradient(circle at 0 0, transparent 0, rgba(0,0,0,0.05) 10px, transparent 20px)", "size": "auto"}'>גלים</option>
                                <option value='{"id": "checker", "name": "שחמט", "pattern": "repeating-conic-gradient(rgba(0,0,0,0.03) 0deg 90deg, transparent 90deg 180deg)", "size": "40px 40px"}'>שחמט</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">גופן:</label>
                            <select id="fontSelector" onchange="app.slides.updateSlideStyle('font', this.value)"
                                    class="border-2 border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500">
                                <!-- גופנים יוטענו דינמית -->
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <span id="autoSaveStatus" class="text-green-600 font-medium">
                            <i class="fas fa-check-circle ml-1"></i> נשמר אוטומטית
                        </span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- מודאל הגדרות -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-cog"></i> הגדרות מערכת
                </h3>
                <button onclick="app.ui.toggleSettings()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-key ml-2 text-purple-600"></i>
                        Gemini API Key
                    </label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" 
                               class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-purple-300 focus:border-purple-500 text-lg" 
                               placeholder="הדבק את המפתח שלך כאן...">
                        <button onclick="app.settings.saveApiKey()" 
                                class="absolute left-2 top-2 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
                            שמור
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-info-circle ml-1"></i>
                        המפתח נשמר מקומית בדפדפן שלך בלבד - אין העברה לשרת
                    </p>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                       class="text-sm text-purple-600 hover:text-purple-800 font-medium mt-2 inline-block">
                        <i class="fas fa-external-link-alt ml-1"></i>
                        קבל מפתח API בחינם מ-Google
                    </a>
                </div>

                <div class="border-t-2 pt-6">
                    <h4 class="font-bold text-lg text-gray-800 mb-3">
                        <i class="fas fa-history ml-2 text-indigo-600"></i>
                        ניהול גרסאות
                    </h4>
                    <div id="versionList" class="max-h-40 overflow-y-auto space-y-2 border-2 rounded-xl p-4 bg-gray-50">
                        <p class="text-gray-500 text-center">אין גרסאות שמורות</p>
                    </div>
                    <button onclick="app.history.saveVersion()" 
                            class="mt-3 w-full bg-indigo-50 text-indigo-700 border-2 border-indigo-200 px-4 py-3 rounded-xl hover:bg-indigo-100 transition font-semibold">
                        <i class="fas fa-save ml-2"></i>
                        שמור גרסה נוכחית
                    </button>
                </div>

                <div class="border-t-2 pt-6">
                    <button onclick="app.settings.clearAllData()" 
                            class="w-full bg-red-50 text-red-600 border-2 border-red-200 px-4 py-3 rounded-xl hover:bg-red-100 transition font-semibold">
                        <i class="fas fa-trash-alt ml-2"></i>
                        מחק את כל הנתונים ואפס את המערכת
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודאל סיכום טקסט -->
    <div id="summaryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-file-import"></i> סיכום טקסט למצגת
                </h3>
                <button onclick="app.ui.closeSummaryModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8">
                <textarea id="textToSummarize" 
                          class="w-full h-64 border-2 border-gray-300 rounded-xl p-4 outline-none focus:ring-4 focus:ring-green-300 focus:border-green-500 text-lg" 
                          placeholder="הדבק כאן טקסט ארוך (מאמר, דו״ח, פרק מספר) והמערכת תמיר אותו למצגת מסודרת..."></textarea>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="app.ui.closeSummaryModal()" 
                            class="btn-secondary px-6 py-3">
                        ביטול
                    </button>
                    <button onclick="app.ai.processSummary()" 
                            class="bg-gradient-to-r from-green-600 to-teal-600 text-white px-8 py-3 rounded-xl hover:opacity-90 transition font-semibold shadow-lg">
                        <i class="fas fa-magic ml-2"></i>
                        צור שקפים מהטקסט
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודאל גלריית תבניות -->
    <div id="templateModal" class="modal" style="display: none;">
        <div class="modal-content max-w-4xl">
            <div class="bg-gradient-to-r from-pink-600 to-purple-600 text-white p-6 flex justify-between items-center">
                <h3 class="font-bold text-2xl flex items-center gap-3">
                    <i class="fas fa-palette"></i> בחר תבנית עיצוב
                </h3>
                <button onclick="app.ui.closeTemplateGallery()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-8">
                <div class="flex gap-4 mb-6 flex-wrap">
                    <button onclick="app.ui.applyRandomDesignToAll()" class="btn-primary flex items-center gap-2">
                        <i class="fas fa-random"></i> עיצוב אקראי מלא
                    </button>
                    <button onclick="app.ui.applyRandomStyleToAll()" class="btn-secondary flex items-center gap-2">
                        <i class="fas fa-palette"></i> עיצוב סגנונות אקראיים
                    </button>
                </div>
                <div id="templateGrid" class="template-grid">
                    <!-- תבניות יווצרו דינמית -->
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ========================================
         * SlideGenius AI Pro - Application Core
         * מערכת מתקדמת ליצירת מצגות עם בינה מלאכותית
         * ========================================
         */

        // ========================================
        // Core Data & Utilities
        // ========================================

        class Utils {
            static generateId() {
                return 'slide-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }

            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
             static getContrastColor(hexcolor) {
                if (!hexcolor || hexcolor === 'transparent') return '#000000';
                hexcolor = hexcolor.replace("#", "");
                if (hexcolor.length === 3) {
                    hexcolor = hexcolor[0] + hexcolor[0] + hexcolor[1] + hexcolor[1] + hexcolor[2] + hexcolor[2];
                }
                const r = parseInt(hexcolor.substr(0, 2), 16);
                const g = parseInt(hexcolor.substr(2, 2), 16);
                const b = parseInt(hexcolor.substr(4, 2), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#000000' : '#ffffff';
            }
            
            static escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ========================================
        // Advanced Design System
        // ========================================
        
        class AdvancedDesignSystem {
            constructor() {
                // 20 גופנים מקצועיים
                this.fonts = [
                    { name: 'Heebo', hebrew: true, style: 'modern' },
                    { name: 'Assistant', hebrew: true, style: 'clean' },
                    { name: 'Rubik', hebrew: true, style: 'rounded' },
                    { name: 'Alef', hebrew: true, style: 'classic' },
                    { name: 'Varela Round', hebrew: false, style: 'friendly' },
                    { name: 'Nunito', hebrew: false, style: 'soft' },
                    { name: 'Montserrat', hebrew: false, style: 'elegant' },
                    { name: 'Poppins', hebrew: false, style: 'modern' },
                    { name: 'Lato', hebrew: false, style: 'professional' },
                    { name: 'Open Sans', hebrew: false, style: 'neutral' },
                    { name: 'Raleway', hebrew: false, style: 'sophisticated' },
                    { name: 'Roboto', hebrew: false, style: 'tech' },
                    { name: 'Playfair Display', hebrew: false, style: 'luxury' },
                    { name: 'Merriweather', hebrew: false, style: 'editorial' },
                    { name: 'Ubuntu', hebrew: false, style: 'tech' },
                    { name: 'Oswald', hebrew: false, style: 'bold' },
                    { name: 'Quicksand', hebrew: false, style: 'playful' },
                    { name: 'Bellefair', hebrew: false, style: 'display' },
                    { name: 'Fredoka One', hebrew: false, style: 'playful' },
                    { name: 'Righteous', hebrew: false, style: 'strong' }
                ];

                // דפוסי רקע - 15 אפשרויות
                this.backgroundPatterns = [
                    { id: 'dots', name: 'נקודות', pattern: 'radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px)', size: '20px 20px' },
                    { id: 'grid', name: 'רשת', pattern: 'linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px)', size: '20px 20px' },
                    { id: 'diagonal', name: 'אלכסון', pattern: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px)', size: 'auto' },
                    { id: 'zigzag', name: 'זיגזג', pattern: 'linear-gradient(135deg, rgba(0,0,0,0.05) 25%, transparent 25%)', size: '20px 20px' },
                    { id: 'circles', name: 'עיגולים', pattern: 'radial-gradient(circle, rgba(0,0,0,0.08) 2px, transparent 2px)', size: '30px 30px' },
                    { id: 'wave', name: 'גלים', pattern: 'repeating-radial-gradient(circle at 0 0, transparent 0, rgba(0,0,0,0.05) 10px, transparent 20px)', size: 'auto' },
                    { id: 'hexagon', name: 'משושים', pattern: 'radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px)', size: '25px 43px' },
                    { id: 'cross', name: 'צלבים', pattern: 'repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 1px, transparent 1px, transparent 20px)', size: 'auto' },
                    { id: 'triangles', name: 'משולשים', pattern: 'linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.05) 75%)', size: '20px 20px' },
                    { id: 'checkerboard', name: 'לוח שחמט', pattern: 'linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.05) 75%), linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.05) 75%)', size: '20px 20px' },
                    { id: 'stars', name: 'כוכבים', pattern: 'radial-gradient(circle, rgba(255,255,255,0.8) 1px, transparent 1px)', size: '50px 50px' },
                    { id: 'stripes_h', name: 'פסים אופקיים', pattern: 'repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px)', size: 'auto' },
                    { id: 'stripes_v', name: 'פסים אנכיים', pattern: 'repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px)', size: 'auto' },
                    { id: 'weave', name: 'אריגה', pattern: 'linear-gradient(45deg, rgba(0,0,0,0.03) 25%, transparent 25%), linear-gradient(-45deg, rgba(0,0,0,0.03) 25%, transparent 25%)', size: '20px 20px' },
                    { id: 'honeycomb', name: 'כוורת', pattern: 'radial-gradient(circle at 50% 0, transparent 40%, rgba(0,0,0,0.05) 40%)', size: '50px 87px' }
                ];

                // 25 ערכות צבעים
                this.colorSchemes = [
                    { id: 'blue_professional', primary: '#1e40af', secondary: '#3b82f6', accent: '#60a5fa', text: '#1e3a8a', bg: '#eff6ff' },
                    { id: 'purple_creative', primary: '#7c3aed', secondary: '#a78bfa', accent: '#c4b5fd', text: '#5b21b6', bg: '#f5f3ff' },
                    { id: 'green_fresh', primary: '#059669', secondary: '#10b981', accent: '#34d399', text: '#065f46', bg: '#d1fae5' },
                    { id: 'red_energetic', primary: '#dc2626', secondary: '#ef4444', accent: '#f87171', text: '#991b1b', bg: '#fee2e2' },
                    { id: 'orange_warm', primary: '#ea580c', secondary: '#f97316', accent: '#fb923c', text: '#9a3412', bg: '#fed7aa' },
                    { id: 'pink_playful', primary: '#db2777', secondary: '#ec4899', accent: '#f472b6', text: '#9f1239', bg: '#fce7f3' },
                    { id: 'teal_calm', primary: '#0d9488', secondary: '#14b8a6', accent: '#2dd4bf', text: '#134e4a', bg: '#ccfbf1' },
                    { id: 'indigo_deep', primary: '#4338ca', secondary: '#6366f1', accent: '#818cf8', text: '#312e81', bg: '#e0e7ff' },
                    { id: 'yellow_bright', primary: '#ca8a04', secondary: '#eab308', accent: '#facc15', text: '#713f12', bg: '#fef9c3' },
                    { id: 'cyan_tech', primary: '#0891b2', secondary: '#06b6d4', accent: '#22d3ee', text: '#164e63', bg: '#cffafe' },
                    { id: 'slate_modern', primary: '#475569', secondary: '#64748b', accent: '#94a3b8', text: '#1e293b', bg: '#f1f5f9' },
                    { id: 'rose_elegant', primary: '#e11d48', secondary: '#f43f5e', accent: '#fb7185', text: '#9f1239', bg: '#ffe4e6' },
                    { id: 'emerald_nature', primary: '#047857', secondary: '#10b981', accent: '#34d399', text: '#065f46', bg: '#d1fae5' },
                    { id: 'violet_luxury', primary: '#7c3aed', secondary: '#8b5cf6', accent: '#a78bfa', text: '#5b21b6', bg: '#ede9fe' },
                    { id: 'amber_sunset', primary: '#d97706', secondary: '#f59e0b', accent: '#fbbf24', text: '#78350f', bg: '#fef3c7' },
                    { id: 'lime_fresh', primary: '#65a30d', secondary: '#84cc16', accent: '#a3e635', text: '#3f6212', bg: '#ecfccb' },
                    { id: 'fuchsia_bold', primary: '#c026d3', secondary: '#d946ef', accent: '#e879f9', text: '#86198f', bg: '#fae8ff' },
                    { id: 'sky_clear', primary: '#0284c7', secondary: '#0ea5e9', accent: '#38bdf8', text: '#075985', bg: '#e0f2fe' },
                    { id: 'gray_neutral', primary: '#6b7280', secondary: '#9ca3af', accent: '#d1d5db', text: '#374151', bg: '#f9fafb' },
                    { id: 'stone_earth', primary: '#78716c', secondary: '#a8a29e', accent: '#d6d3d1', text: '#44403c', bg: '#fafaf9' },
                    { id: 'red_passion', primary: '#b91c1c', secondary: '#dc2626', accent: '#ef4444', text: '#7f1d1d', bg: '#fef2f2' },
                    { id: 'blue_ocean', primary: '#1d4ed8', secondary: '#2563eb', accent: '#3b82f6', text: '#1e3a8a', bg: '#dbeafe' },
                    { id: 'green_mint', primary: '#059669', secondary: '#10b981', accent: '#34d399', text: '#047857', bg: '#d1fae5' },
                    { id: 'purple_night', primary: '#6d28d9', secondary: '#7c3aed', accent: '#8b5cf6', text: '#5b21b6', bg: '#f5f3ff' },
                    { id: 'orange_fire', primary: '#c2410c', secondary: '#ea580c', accent: '#f97316', text: '#9a3412', bg: '#fed7aa' }
                ];

                // סגנונות טקסט - 10 אפשרויות
                this.textStyles = [
                    { id: 'shadow-soft', name: 'צל רך', css: 'text-shadow: 2px 2px 4px rgba(0,0,0,0.1);' },
                    { id: 'shadow-hard', name: 'צל חזק', css: 'text-shadow: 3px 3px 0px rgba(0,0,0,0.2);' },
                    { id: 'glow', name: 'זוהר', css: 'text-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 20px rgba(255,255,255,0.6);' },
                    { id: 'outline', name: 'מתאר', css: 'text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;' },
                    { id: '3d-effect', name: 'אפקט תלת מימד', css: 'text-shadow: 1px 1px 0px rgba(0,0,0,0.2), 2px 2px 0px rgba(0,0,0,0.15), 3px 3px 0px rgba(0,0,0,0.1);' },
                    { id: 'emboss', name: 'בליטה', css: 'text-shadow: -1px -1px 0 rgba(255,255,255,0.3), 1px 1px 0 rgba(0,0,0,0.8);' },
                    { id: 'neon', name: 'ניאון', css: 'text-shadow: 0 0 5px currentColor, 0 0 10px currentColor, 0 0 15px currentColor;' },
                    { id: 'retro', name: 'רטרו', css: 'text-shadow: 3px 3px 0px rgba(0,0,0,0.2), 6px 6px 0px rgba(0,0,0,0.1);' },
                    { id: 'blur', name: 'טשטוש', css: 'text-shadow: 0 0 8px rgba(0,0,0,0.5);' },
                    { id: 'none', name: 'ללא', css: '' }
                ];

                // סגנונות מסגרות - 10 אפשרויות
                this.borderStyles = [
                    { id: 'solid-thin', name: 'מוצק דק', css: 'border: 2px solid currentColor;' },
                    { id: 'solid-thick', name: 'מוצק עבה', css: 'border: 4px solid currentColor;' },
                    { id: 'dashed', name: 'מקווקו', css: 'border: 2px dashed currentColor;' },
                    { id: 'dotted', name: 'מנוקד', css: 'border: 2px dotted currentColor;' },
                    { id: 'double', name: 'כפול', css: 'border: 4px double currentColor;' },
                    { id: 'gradient-border', name: 'מסגרת גרדיאנט', css: 'border: 3px solid; border-image: linear-gradient(45deg, currentColor, transparent) 1;' },
                    { id: 'shadow-border', name: 'מסגרת צל', css: 'box-shadow: 0 0 0 2px currentColor;' },
                    { id: 'glow-border', name: 'מסגרת זוהר', css: 'box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;' },
                    { id: 'offset', name: 'מסגרת מוזחת', css: 'border: 2px solid currentColor; box-shadow: 4px 4px 0 rgba(0,0,0,0.1);' },
                    { id: 'none', name: 'ללא', css: '' }
                ];

                // סגנונות צללים - 10 אפשרויות
                this.shadowStyles = [
                    { id: 'soft', name: 'רך', css: 'box-shadow: 0 2px 8px rgba(0,0,0,0.1);' },
                    { id: 'medium', name: 'בינוני', css: 'box-shadow: 0 4px 16px rgba(0,0,0,0.15);' },
                    { id: 'hard', name: 'חזק', css: 'box-shadow: 0 8px 24px rgba(0,0,0,0.2);' },
                    { id: 'colored', name: 'צבעוני', css: 'box-shadow: 0 4px 16px currentColor;' },
                    { id: 'multi', name: 'מרובה', css: 'box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);' },
                    { id: 'inner', name: 'פנימי', css: 'box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);' },
                    { id: 'glow', name: 'זוהר', css: 'box-shadow: 0 0 20px rgba(255,255,255,0.5);' },
                    { id: 'lifted', name: 'מורם', css: 'box-shadow: 0 10px 30px rgba(0,0,0,0.2);' },
                    { id: 'sharp', name: 'חד', css: 'box-shadow: 8px 8px 0 rgba(0,0,0,0.1);' },
                    { id: 'none', name: 'ללא', css: '' }
                ];

                // פינות מעוגלות - 8 אפשרויות
                this.borderRadius = [
                    { id: 'none', name: 'חד', value: '0' },
                    { id: 'small', name: 'קטן', value: '0.25rem' },
                    { id: 'medium', name: 'בינוני', value: '0.5rem' },
                    { id: 'large', name: 'גדול', value: '1rem' },
                    { id: 'xlarge', name: 'גדול מאוד', value: '1.5rem' },
                    { id: 'round', name: 'עגול', value: '9999px' },
                    { id: 'top-only', name: 'עליון בלבד', value: '1rem 1rem 0 0' },
                    { id: 'asymmetric', name: 'אסימטרי', value: '1rem 2rem 0.5rem 1.5rem' }
                ];

                // סגנונות פריסה - 8 אפשרויות
                this.layouts = [
                    { id: 'standard', name: 'סטנדרטי', description: 'כותרת למעלה, תוכן מתחת' },
                    { id: 'centered', name: 'ממורכז', description: 'כל התוכן ממורכז באמצע' },
                    { id: 'split', name: 'מפוצל', description: 'תוכן משני צדדים' },
                    { id: 'minimal', name: 'מינימליסטי', description: 'פריסה נקייה ופשוטה' },
                    { id: 'creative', name: 'קריאייטיבי', description: 'פריסה בלתי שגרתית' },
                    { id: 'sidebar', name: 'סרגל צד', description: 'תוכן עם סרגל צד' },
                    { id: 'grid', name: 'רשת', description: 'תוכן בסידור רשת' },
                    { id: 'asymmetric', name: 'אסימטרי', description: 'פריסה לא סימטרית' }
                ];
            }

            getRandomFont() {
                return this.fonts[Math.floor(Math.random() * this.fonts.length)];
            }

            getRandomColorScheme() {
                return this.colorSchemes[Math.floor(Math.random() * this.colorSchemes.length)];
            }

            getRandomPattern() {
                return this.backgroundPatterns[Math.floor(Math.random() * this.backgroundPatterns.length)];
            }

            getRandomTextStyle() {
                return this.textStyles[Math.floor(Math.random() * this.textStyles.length)];
            }

            getRandomBorderStyle() {
                return this.borderStyles[Math.floor(Math.random() * this.borderStyles.length)];
            }

            getRandomShadow() {
                return this.shadowStyles[Math.floor(Math.random() * this.shadowStyles.length)];
            }

            getRandomBorderRadius() {
                return this.borderRadius[Math.floor(Math.random() * this.borderRadius.length)];
            }

            getRandomLayout() {
                return this.layouts[Math.floor(Math.random() * this.layouts.length)];
            }

            // יצירת עיצוב מלא אקראי
            generateRandomDesign() {
                const colorScheme = this.getRandomColorScheme();
                const font = this.getRandomFont();
                const pattern = Math.random() > 0.5 ? this.getRandomPattern() : { id: 'none', name: 'ללא', pattern: 'none', size: 'auto' };
                const textStyle = Math.random() > 0.7 ? this.getRandomTextStyle() : { id: 'none', name: 'ללא', css: '' };
                const borderStyle = Math.random() > 0.8 ? this.getRandomBorderStyle() : { id: 'none', name: 'ללא', css: '' };
                const shadow = Math.random() > 0.6 ? this.getRandomShadow() : { id: 'none', name: 'ללא', css: '' };
                const borderRadius = this.getRandomBorderRadius();
                const layout = this.getRandomLayout();

                return {
                    colorScheme,
                    font: font.name,
                    pattern,
                    textStyle,
                    borderStyle,
                    shadow,
                    borderRadius,
                    layout: layout.id,
                    // נוסיף עוד מאפיינים
                    opacity: 0.9 + Math.random() * 0.1, // 0.9-1.0
                    padding: `${1 + Math.random() * 2}rem`, // 1-3rem
                    titleSize: `${2 + Math.random() * 1.5}rem`, // 2-3.5rem
                    contentSize: `${0.9 + Math.random() * 0.6}rem`, // 0.9-1.5rem
                    lineHeight: 1.4 + Math.random() * 0.6, // 1.4-2.0
                    letterSpacing: `${-0.02 + Math.random() * 0.06}em` // -0.02 to 0.04em
                };
            }
        }

        // ========================================
        // Design Templates System
        // ========================================

        class DesignTemplates {
            constructor(advancedDesign) {
                // שמירה של מערכת העיצוב המתקדמת
                this.advancedDesignSystem = advancedDesign;
                
                this.templates = [
                    {
                        id: 'modern_clean',
                        name: 'מודרני נקי',
                        preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        style: {
                            backgroundColor: '#ffffff',
                            textColor: '#1f2937',
                            accentColor: '#667eea',
                            font: 'Heebo',
                            titleSize: '3rem',
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'dark_elegant',
                        name: 'כהה אלגנטי',
                        preview: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
                        style: {
                            backgroundColor: '#1a1a2e',
                            textColor: '#f0f0f0',
                            accentColor: '#e94560',
                            font: 'Assistant',
                            titleSize: '2.8rem',
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'colorful_vibrant',
                        name: 'צבעוני ותוסס',
                        preview: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        style: {
                            backgroundColor: '#fff7ed',
                            textColor: '#7c2d12',
                            accentColor: '#f97316',
                            font: 'Rubik',
                            titleSize: '3.2rem',
                            layout: 'centered',
                            pattern: this.getPatternById('dots')
                        }
                    },
                    {
                        id: 'minimal_pro',
                        name: 'מינימליסטי מקצועי',
                        preview: 'linear-gradient(135deg, #fafafa 0%, #e5e5e5 100%)',
                        style: {
                            backgroundColor: '#fafafa',
                            textColor: '#0a0a0a',
                            accentColor: '#000000',
                            font: 'Heebo',
                            titleSize: '2.5rem',
                            layout: 'minimal'
                        }
                    },
                    {
                        id: 'ocean_breeze',
                        name: 'נשימת האוקיינוס',
                        preview: 'linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%)',
                        style: {
                            backgroundColor: '#e0f2fe',
                            textColor: '#0c4a6e',
                            accentColor: '#0284c7',
                            font: 'Assistant',
                            titleSize: '3rem',
                            layout: 'split',
                            pattern: this.getPatternById('grid')
                        }
                    },
                    {
                        id: 'sunset_glow',
                        name: 'זוהר השקיעה',
                        preview: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #feada6 100%)',
                        style: {
                            backgroundColor: '#fff1f2',
                            textColor: '#881337',
                            accentColor: '#e11d48',
                            font: 'Rubik',
                            titleSize: '3.5rem',
                            layout: 'centered'
                        }
                    },
                    {
                        id: 'forest_green',
                        name: 'ירוק יער',
                        preview: 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)',
                        style: {
                            backgroundColor: '#f0fdf4',
                            textColor: '#14532d',
                            accentColor: '#16a34a',
                            font: 'Heebo',
                            titleSize: '2.8rem',
                            layout: 'standard',
                            pattern: this.getPatternById('diagonal')
                        }
                    },
                    {
                        id: 'corporate_blue',
                        name: 'כחול עסקי',
                        preview: 'linear-gradient(135deg, #2e3192 0%, #1bffff 100%)',
                        style: {
                            backgroundColor: '#f8fafc',
                            textColor: '#0f172a',
                            accentColor: '#1e40af',
                            font: 'Assistant',
                            titleSize: '2.6rem',
                            layout: 'standard'
                        }
                    },
                    {
                        id: 'creative_purple',
                        name: 'סגול קריאייטיבי',
                        preview: 'linear-gradient(135deg, #7028e4 0%, #e5b2ca 100%)',
                        style: {
                            backgroundColor: '#faf5ff',
                            textColor: '#581c87',
                            accentColor: '#9333ea',
                            font: 'Rubik',
                            titleSize: '3.4rem',
                            layout: 'creative',
                            pattern: this.getPatternById('dots')
                        }
                    },
                    {
                        id: 'warm_autumn',
                        name: 'סתיו חם',
                        preview: 'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                        style: {
                            backgroundColor: '#fffbeb',
                            textColor: '#78350f',
                            accentColor: '#d97706',
                            font: 'Heebo',
                            titleSize: '3rem',
                            layout: 'split'
                        }
                    }
                ];
            }

            getAllTemplates() {
                return this.templates;
            }

            getTemplateById(id) {
                return this.templates.find(t => t.id === id);
            }

            getRandomTemplate() {
                return this.templates[Math.floor(Math.random() * this.templates.length)];
            }
            
            // מעדכן את getPatternById להשתמש ב-this.advancedDesignSystem
            getPatternById(id) {
                return this.advancedDesignSystem.backgroundPatterns.find(p => p.id === id) || null;
            }
            
            generateGradientForSlide(slideTitle, index) {
                const gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                    'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)',
                    'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)',
                    'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                    'linear-gradient(135deg, #c471f5 0%, #fa71cd 100%)',
                    'linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%)',
                    'linear-gradient(135deg, #feada6 0%, #f5efef 100%)'
                ];
                
                const hash = (slideTitle + index).split('').reduce((acc, char) => {
                    return char.charCodeAt(0) + ((acc << 5) - acc);
                }, 0);
                
                return gradients[Math.abs(hash) % gradients.length];
            }
        }

        // ========================================
        // Slides Manager
        // ========================================

        class SlidesManager {
            constructor() {
                this.slides = [];
                this.currentSlideIndex = -1;
                this.sortable = null;
            }

            addNewSlide(type = 'content') {
                app.history.saveState();
                
                // השתמש ב-app.templates.getRandomTemplate()
                const template = app.templates.getRandomTemplate();
                const design = app.advancedDesign.generateRandomDesign();
                
                const newSlide = {
                    id: Utils.generateId(),
                    title: 'כותרת שקף חדש',
                    content: ['נקודה ראשונה', 'נקודה שניה', 'נקודה שלישית'],
                    gradient: app.templates.generateGradientForSlide('כותרת שקף חדש', this.slides.length),
                    notes: '',
                    layout: design.layout, // עיצוב אקראי
                    style: {
                        backgroundColor: design.colorScheme.bg,
                        textColor: design.colorScheme.text,
                        accentColor: design.colorScheme.accent,
                        secondaryColor: design.colorScheme.secondary,
                        font: design.font,
                        titleSize: design.titleSize,
                        contentSize: design.contentSize,
                        pattern: design.pattern,
                        textStyle: design.textStyle,
                        borderStyle: design.borderStyle,
                        shadow: design.shadow,
                        borderRadius: design.borderRadius.value,
                        opacity: design.opacity,
                        padding: design.padding,
                        lineHeight: design.lineHeight,
                        letterSpacing: design.letterSpacing
                    }
                };

                this.slides.push(newSlide);
                this.currentSlideIndex = this.slides.length - 1;
                this.renderSlides();
                app.ui.showToast('שקף חדש נוצר בהצלחה!', 'success');
            }

            loadSlides(slidesData, index = 0) {
                this.slides = slidesData;
                this.currentSlideIndex = slidesData.length > 0 ? index : -1;
                this.renderSlides();
            }

            renderSlides() {
                this.renderSlideList();
                this.renderCurrentSlide();
                this.updateSlideCount();
                this.updateStylingControls();
                this.saveToLocalStorage();
            }

            renderSlideList() {
                const container = document.getElementById('slidesList');
                if (this.slides.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 mt-20">
                            <i class="fas fa-images text-5xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium">אין שקפים עדיין</p>
                            <p class="text-sm mt-2">צור מצגת חדשה כדי להתחיל</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.slides.map((slide, index) => `
                    <div class="slide-card p-4 ${index === this.currentSlideIndex ? 'active' : ''}" 
                         data-slide-id="${slide.id}"
                         onclick="app.slides.selectSlide(${index})">
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded">
                                ${index + 1}
                            </span>
                            <button onclick="event.stopPropagation(); app.slides.deleteSlide(${index})" 
                                    class="text-red-400 hover:text-red-600 transition">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                        <div class="aspect-video bg-gradient-to-br from-gray-100 to-gray-200 rounded mb-2 overflow-hidden flex items-center justify-center text-xs text-gray-600 font-medium"
                             style="background: ${slide.style?.backgroundColor || '#fff'}; color: ${slide.style?.textColor || '#000'};">
                            ${slide.title.substring(0, 30)}${slide.title.length > 30 ? '...' : ''}
                        </div>
                        <p class="text-xs text-gray-600 font-medium truncate">${slide.title}</p>
                    </div>
                `).join('');

                this.initSortable();
            }

            initSortable() {
                const container = document.getElementById('slidesList');
                if (this.sortable) {
                    this.sortable.destroy();
                }
                
                this.sortable = Sortable.create(container, {
                    animation: 200,
                    ghostClass: 'opacity-50',
                    onEnd: (evt) => {
                        app.history.saveState();
                        const item = this.slides.splice(evt.oldIndex, 1)[0];
                        this.slides.splice(evt.newIndex, 0, item);
                        this.currentSlideIndex = evt.newIndex;
                        this.renderSlides();
                    }
                });
            }

            selectSlide(index) {
                if (index >= 0 && index < this.slides.length) {
                    this.currentSlideIndex = index;
                    this.renderSlides();
                }
            }

            deleteSlide(index) {
                if (confirm('האם אתה בטוח שברצונך למחוק את השקף?')) {
                    app.history.saveState();
                    this.slides.splice(index, 1);
                    if (this.currentSlideIndex >= this.slides.length) {
                        this.currentSlideIndex = this.slides.length - 1;
                    }
                    this.renderSlides();
                    app.ui.showToast('השקף נמחק', 'success');
                }
            }

            duplicateCurrentSlide() {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                const currentSlide = this.slides[this.currentSlideIndex];
                const duplicated = JSON.parse(JSON.stringify(currentSlide));
                duplicated.id = Utils.generateId();
                duplicated.title = duplicated.title + ' (עותק)';
                
                this.slides.splice(this.currentSlideIndex + 1, 0, duplicated);
                this.currentSlideIndex++;
                this.renderSlides();
                app.ui.showToast('השקף שוכפל בהצלחה!', 'success');
            }
            
            applyRandomDesign() {
                if (this.currentSlideIndex === -1) {
                    app.ui.showToast('בחר שקף להחלת עיצוב', 'error');
                    return;
                }
                
                app.history.saveState();
                const design = app.advancedDesign.generateRandomDesign();
                const slide = this.slides[this.currentSlideIndex];
                
                slide.layout = design.layout;
                slide.style = {
                    ...slide.style, // שמור מאפיינים קיימים אם יש
                    backgroundColor: design.colorScheme.bg,
                    textColor: design.colorScheme.text,
                    accentColor: design.colorScheme.accent,
                    secondaryColor: design.colorScheme.secondary,
                    font: design.font,
                    titleSize: design.titleSize,
                    contentSize: design.contentSize,
                    pattern: design.pattern,
                    textStyle: design.textStyle,
                    borderStyle: design.borderStyle,
                    shadow: design.shadow,
                    borderRadius: design.borderRadius.value,
                    opacity: design.opacity,
                    padding: design.padding,
                    lineHeight: design.lineHeight,
                    letterSpacing: design.letterSpacing
                };
                
                this.renderSlides();
                app.ui.showToast('העיצוב האקראי הוחל על השקף!', 'success');
            }

            applyRandomDesignToAll() {
                if (this.slides.length === 0) {
                    app.ui.showToast('אין שקפים להחלת עיצוב', 'error');
                    return;
                }
                
                if (!confirm('האם להחיל עיצוב אקראי מלא על כל השקפים?')) return;
                
                app.history.saveState();
                this.slides.forEach(slide => {
                    const design = app.advancedDesign.generateRandomDesign();
                    slide.layout = design.layout;
                    slide.style = {
                        backgroundColor: design.colorScheme.bg,
                        textColor: design.colorScheme.text,
                        accentColor: design.colorScheme.accent,
                        secondaryColor: design.colorScheme.secondary,
                        font: design.font,
                        titleSize: design.titleSize,
                        contentSize: design.contentSize,
                        pattern: design.pattern,
                        textStyle: design.textStyle,
                        borderStyle: design.borderStyle,
                        shadow: design.shadow,
                        borderRadius: design.borderRadius.value,
                        opacity: design.opacity,
                        padding: design.padding,
                        lineHeight: design.lineHeight,
                        letterSpacing: design.letterSpacing
                    };
                });
                this.renderSlides();
                app.ui.showToast('עיצוב אקראי הוחל על כל השקפים!', 'success');
            }

            applyRandomStyleToAll() {
                 if (this.slides.length === 0) {
                    app.ui.showToast('אין שקפים להחלת עיצוב', 'error');
                    return;
                }
                
                if (!confirm('האם להחיל סגנונות עיצוב אקראיים (גופן, צבעים, תבניות) על כל השקפים?')) return;
                
                app.history.saveState();
                this.slides.forEach(slide => {
                    const design = app.advancedDesign.generateRandomDesign();
                    slide.style = {
                        ...slide.style, // שמור את הפריסה הנוכחית
                        backgroundColor: design.colorScheme.bg,
                        textColor: design.colorScheme.text,
                        accentColor: design.colorScheme.accent,
                        secondaryColor: design.colorScheme.secondary,
                        font: design.font,
                        titleSize: design.titleSize,
                        contentSize: design.contentSize,
                        pattern: design.pattern,
                        textStyle: design.textStyle,
                        borderStyle: design.borderStyle,
                        shadow: design.shadow,
                        borderRadius: design.borderRadius.value,
                        opacity: design.opacity,
                        padding: design.padding,
                        lineHeight: design.lineHeight,
                        letterSpacing: design.letterSpacing
                    };
                });
                this.renderSlides();
                app.ui.showToast('סגנונות עיצוב אקראיים הוחלו על כל השקפים!', 'success');
            }

            updateSlideContent(field, value) {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                const slide = this.slides[this.currentSlideIndex];
                slide[field] = value;
                this.renderSlides();
            }

            updateSlideStyle(property, value) {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                const slide = this.slides[this.currentSlideIndex];
                if (!slide.style) slide.style = {};
                slide.style[property] = value;
                
                // עדכון ישיר של הקנבס לשינויים מיידיים
                this.renderCurrentSlide();
                this.saveToLocalStorage();
            }

            changeCurrentLayout(layoutType) {
                if (this.currentSlideIndex === -1) return;
                
                app.history.saveState();
                const slide = this.slides[this.currentSlideIndex];
                slide.layout = layoutType;
                this.renderCurrentSlide();
            }

            renderCurrentSlide() {
                const canvas = document.getElementById('slideCanvas');
                
                if (this.currentSlideIndex === -1 || this.slides.length === 0) {
                    canvas.innerHTML = `
                        <div class="w-full h-full flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-presentation text-6xl mb-6 opacity-30"></i>
                                <p class="text-2xl font-semibold">בחר שקף או צור חדש</p>
                                <p class="text-lg mt-2">התחל ליצור מצגות מדהימות עם AI</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const slide = this.slides[this.currentSlideIndex];
                const style = slide.style || {};
                
                const bgColor = style.backgroundColor || '#ffffff';
                const textColor = style.textColor || '#1f2937';
                const accentColor = style.accentColor || '#667eea';
                const font = style.font || 'Heebo';
                const titleSize = style.titleSize || '2.5rem';
                const contentSize = style.contentSize || '1.2rem';
                const lineHeight = style.lineHeight || 1.6;
                const letterSpacing = style.letterSpacing || '0em';
                const pattern = style.pattern || { id: 'none', name: 'ללא', pattern: 'none', size: 'auto' };
                const textStyle = style.textStyle || { id: 'none', name: 'ללא', css: '' };
                const borderStyle = style.borderStyle || { id: 'none', name: 'ללא', css: '' };
                const shadow = style.shadow || { id: 'none', name: 'ללא', css: '' };
                const borderRadius = style.borderRadius || '0';
                const padding = style.padding || '2rem';
                
                let patternClass = '';
                let patternStyle = '';
                if (pattern && pattern.pattern !== 'none') {
                    patternClass = 'pattern-applied'; // להוסיף קלאס כללי
                    patternStyle = `
                        background-image: ${pattern.pattern}, ${pattern.pattern}; /* שתי שכבות לכיסוי יעיל */
                        background-size: ${pattern.size}, ${pattern.size};
                    `;
                }

                const layoutClass = `slide-layout-${slide.layout || 'standard'}`;
                let slideHtml = '';

                const baseStyles = `
                    font-family: ${font}; 
                    color: ${textColor}; 
                    line-height: ${lineHeight};
                    letter-spacing: ${letterSpacing};
                    ${textStyle.css}
                    ${shadow.css}
                    border-radius: ${borderRadius};
                    padding: ${padding};
                    ${borderStyle.css}
                `;

                switch (slide.layout) {
                    case 'centered':
                        slideHtml = `
                            <div class="w-full h-full flex flex-col items-center justify-center text-center ${patternClass}"
                                 style="${baseStyles} background: ${bgColor}; ${patternStyle}">
                                <h1 contenteditable="true" 
                                    onblur="app.slides.updateSlideContent('title', this.textContent)"
                                    class="font-bold mb-6"
                                    style="color: ${accentColor}; font-size: ${titleSize};">
                                    ${slide.title}
                                </h1>
                                <div class="space-y-3" style="font-size: ${contentSize};">
                                    ${slide.content.map((item, i) => `
                                        <p contenteditable="true" 
                                           onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                           class="leading-relaxed">
                                            ${item}
                                        </p>
                                    `).join('')}
                                </div>
                                ${slide.imageUrl ? `
                                    <div class="mt-8 rounded-2xl shadow-2xl max-w-md w-full h-64 overflow-hidden">
                                        <img src="${slide.imageUrl}" alt="Slide Image" class="w-full h-full object-cover">
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        break;

                    case 'split':
                        slideHtml = `
                            <div class="w-full h-full grid grid-cols-2 gap-8 ${patternClass}"
                                 style="${baseStyles} background: ${bgColor}; ${patternStyle}">
                                <div class="flex flex-col justify-center">
                                    <h1 contenteditable="true" 
                                        onblur="app.slides.updateSlideContent('title', this.textContent)"
                                        class="font-bold mb-6"
                                        style="color: ${accentColor}; font-size: ${titleSize};">
                                        ${slide.title}
                                    </h1>
                                    <ul class="space-y-3" style="font-size: ${contentSize};">
                                        ${slide.content.map((item, i) => `
                                            <li class="flex items-start gap-3">
                                                <i class="fas fa-check-circle mt-1" style="color: ${accentColor};"></i>
                                                <span contenteditable="true" 
                                                      onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                      class="flex-1">
                                                    ${item}
                                                </span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                ${slide.imageUrl ? `
                                    <div class="flex items-center justify-center overflow-hidden rounded-lg shadow-lg">
                                        <img src="${slide.imageUrl}" alt="Slide Image" class="w-full h-full object-cover">
                                    </div>
                                ` : `
                                    <div class="flex items-center justify-center">
                                        <div class="w-full h-full rounded-2xl bg-gray-200 flex items-center justify-center text-gray-400">
                                            <i class="fas fa-image text-6xl"></i>
                                        </div>
                                    </div>
                                `}
                            </div>
                        `;
                        break;

                    case 'minimal':
                        slideHtml = `
                            <div class="w-full h-full flex flex-col p-16 ${patternClass}"
                                 style="${baseStyles} background: ${bgColor}; ${patternStyle}">
                                <h1 contenteditable="true" 
                                    onblur="app.slides.updateSlideContent('title', this.textContent)"
                                    class="font-light mb-12 border-b-4 pb-4"
                                    style="color: ${accentColor}; font-size: ${titleSize}; border-color: ${accentColor};">
                                    ${slide.title}
                                </h1>
                                <div class="flex-1" style="font-size: ${contentSize};">
                                    <ul class="space-y-4">
                                        ${slide.content.map((item, i) => `
                                            <li contenteditable="true" 
                                                onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                class="leading-relaxed">
                                                — ${item}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                        break;

                    case 'creative':
                        slideHtml = `
                            <div class="w-full h-full relative overflow-hidden ${patternClass}"
                                 style="${baseStyles} background: ${bgColor}; ${patternStyle}">
                                ${slide.imageUrl ? `
                                    <div class="absolute inset-0 w-full h-full opacity-30">
                                        <img src="${slide.imageUrl}" alt="Slide Image" class="w-full h-full object-cover">
                                    </div>
                                ` : ''}
                                <div class="relative z-10 h-full flex flex-col justify-between p-12">
                                    <h1 contenteditable="true" 
                                        onblur="app.slides.updateSlideContent('title', this.textContent)"
                                        class="font-black text-right"
                                        style="color: ${accentColor}; font-size: ${titleSize};">
                                        ${slide.title}
                                    </h1>
                                    <div class="bg-white bg-opacity-90 backdrop-blur-md p-8 rounded-3xl shadow-2xl" style="font-size: ${contentSize};">
                                        <ul class="space-y-3">
                                            ${slide.content.map((item, i) => `
                                                <li class="flex items-start gap-3">
                                                    <span class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-white"
                                                          style="background: ${accentColor};">
                                                        ${i + 1}
                                                    </span>
                                                    <span contenteditable="true" 
                                                          onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                          class="flex-1 pt-1 leading-relaxed">
                                                        ${item}
                                                    </span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                        
                    case 'sidebar':
                        slideHtml = `
                            <div class="w-full h-full grid grid-cols-[25%_75%] gap-4 ${patternClass}"
                                 style="${baseStyles} background: ${bgColor}; ${patternStyle}">
                                <div class="flex flex-col justify-center p-6 rounded-xl" style="background-color: ${style.secondaryColor || '#e2e8f0'}; color: ${Utils.getContrastColor(style.secondaryColor || '#e2e8f0')}; font-size: ${contentSize};">
                                     <h2 class="font-bold mb-4" style="color: ${accentColor};">${slide.title}</h2>
                                     <ul class="space-y-3">
                                        ${slide.content.map((item, i) => `
                                            <li class="flex items-start gap-2">
                                                <i class="fas fa-circle text-xs mt-1.5" style="color: ${accentColor};"></i>
                                                <span contenteditable="true" onblur="app.slides.updateContentItem(${i}, this.textContent)">${item}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <div class="flex flex-col justify-center p-6">
                                     <h1 contenteditable="true" 
                                        onblur="app.slides.updateSlideContent('title', this.textContent)"
                                        class="font-bold mb-6"
                                        style="color: ${accentColor}; font-size: ${titleSize};">
                                        ${slide.title}
                                    </h1>
                                    <p class="text-lg" style="font-size: ${contentSize};">
                                        ${slide.content.map((item, i) => `<span contenteditable="true" onblur="app.slides.updateContentItem(${i}, this.textContent)">${item}</span><br/>`).join('')}
                                    </p>
                                </div>
                            </div>
                        `;
                        break;
                        
                    case 'grid':
                        slideHtml = `
                            <div class="w-full h-full grid grid-cols-2 gap-6 ${patternClass}"
                                 style="${baseStyles} background: ${bgColor}; ${patternStyle}">
                                <div class="flex flex-col justify-center p-6">
                                    <h1 contenteditable="true" 
                                        onblur="app.slides.updateSlideContent('title', this.textContent)"
                                        class="font-bold mb-6"
                                        style="color: ${accentColor}; font-size: ${titleSize};">
                                        ${slide.title}
                                    </h1>
                                    <ul class="space-y-4" style="font-size: ${contentSize};">
                                        ${slide.content.slice(0, Math.ceil(slide.content.length / 2)).map((item, i) => `
                                            <li class="flex items-start gap-3">
                                                <span class="text-lg font-bold" style="color: ${accentColor};">${i + 1}.</span>
                                                <span contenteditable="true" onblur="app.slides.updateContentItem(${slide.content.indexOf(item)}, this.textContent)">${item}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <div class="flex flex-col justify-center p-6">
                                    <ul class="space-y-4" style="font-size: ${contentSize};">
                                        ${slide.content.slice(Math.ceil(slide.content.length / 2)).map((item, i) => `
                                            <li class="flex items-start gap-3">
                                                <span class="text-lg font-bold" style="color: ${accentColor};">${Math.ceil(slide.content.length / 2) + i + 1}.</span>
                                                <span contenteditable="true" onblur="app.slides.updateContentItem(${slide.content.indexOf(item)}, this.textContent)">${item}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                    ${slide.imageUrl ? `
                                        <div class="mt-8 rounded-2xl shadow-2xl overflow-hidden">
                                            <img src="${slide.imageUrl}" alt="Slide Image" class="w-full h-full object-cover">
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        break;
                        
                    case 'asymmetric':
                        slideHtml = `
                            <div class="w-full h-full grid grid-cols-2 gap-8 ${patternClass}"
                                 style="${baseStyles} background: ${bgColor}; ${patternStyle}">
                                <div class="flex flex-col justify-center">
                                    <h1 contenteditable="true" 
                                        onblur="app.slides.updateSlideContent('title', this.textContent)"
                                        class="font-bold mb-6"
                                        style="color: ${accentColor}; font-size: ${titleSize};">
                                        ${slide.title}
                                    </h1>
                                    <ul class="space-y-3" style="font-size: ${contentSize};">
                                        ${slide.content.map((item, i) => `
                                            <li class="flex items-start gap-3">
                                                <span class="text-xl" style="color: ${accentColor};">•</span>
                                                <span contenteditable="true" 
                                                      onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                      class="flex-1 leading-relaxed">
                                                    ${item}
                                                </span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                ${slide.imageUrl ? `
                                    <div class="flex items-center justify-center overflow-hidden rounded-xl shadow-lg ml-4">
                                        <img src="${slide.imageUrl}" alt="Slide Image" class="w-full h-full object-cover">
                                    </div>
                                ` : `
                                    <div class="flex items-center justify-center">
                                        <div class="w-full h-full rounded-2xl bg-gray-200 flex items-center justify-center text-gray-400">
                                            <i class="fas fa-image text-6xl"></i>
                                        </div>
                                    </div>
                                `}
                            </div>
                        `;
                        break;

                    default: // standard
                        slideHtml = `
                            <div class="w-full h-full flex flex-col p-12 ${patternClass}"
                                 style="${baseStyles} background: ${bgColor}; ${patternStyle}">
                                <h1 contenteditable="true" 
                                    onblur="app.slides.updateSlideContent('title', this.textContent)"
                                    class="font-bold mb-8"
                                    style="color: ${accentColor}; font-size: ${titleSize};">
                                    ${slide.title}
                                </h1>
                                <div class="flex-1 flex items-center">
                                    <ul class="space-y-4 w-full" style="font-size: ${contentSize};">
                                        ${slide.content.map((item, i) => `
                                            <li class="flex items-start gap-3">
                                                <span class="text-2xl" style="color: ${accentColor};">•</span>
                                                <span contenteditable="true" 
                                                      onblur="app.slides.updateContentItem(${i}, this.textContent)"
                                                      class="flex-1 leading-relaxed">
                                                    ${item}
                                                </span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                ${slide.imageUrl ? `
                                    <div class="flex items-center justify-center mt-8 rounded-2xl shadow-2xl overflow-hidden">
                                        <img src="${slide.imageUrl}" alt="Slide Image" class="w-full h-full object-cover">
                                    </div>
                                ` : ''}
                            </div>
                        `;
                }

                canvas.innerHTML = slideHtml;
            }

            updateContentItem(index, newText) {
                if (this.currentSlideIndex === -1) return;
                app.history.saveState();
                this.slides[this.currentSlideIndex].content[index] = newText;
                this.saveToLocalStorage();
            }

            updateSlideCount() {
                document.getElementById('slideCount').textContent = this.slides.length;
            }
            
            updateStylingControls() {
                const slide = this.currentSlideIndex !== -1 ? this.slides[this.currentSlideIndex] : null;
                const style = slide?.style || {};

                // Layout
                document.getElementById('layoutSelector').value = style.layout || 'standard';
                
                // Colors
                document.getElementById('bgColorPicker').value = style.backgroundColor || '#ffffff';
                document.getElementById('textColorPicker').value = style.textColor || '#1f2937';
                document.getElementById('accentColorPicker').value = style.accentColor || '#667eea';
                
                // Pattern
                document.getElementById('patternSelector').value = style.pattern ? JSON.stringify(style.pattern) : '';
                
                // Font
                const fontSelector = document.getElementById('fontSelector');
                if (!fontSelector.options.length) {
                    // השתמש ב-app.advancedDesign.fonts
                    app.advancedDesign.fonts.forEach(font => {
                        const option = document.createElement('option');
                        option.value = font.name;
                        option.textContent = font.name + (font.hebrew ? ' (עברית)' : '');
                        fontSelector.appendChild(option);
                    });
                }
                fontSelector.value = style.font || 'Heebo';
            }

            saveToLocalStorage() {
                const debouncedSave = Utils.debounce(() => {
                    try {
                        localStorage.setItem('slidegenius_slides', JSON.stringify(this.slides));
                        localStorage.setItem('slidegenius_current_index', this.currentSlideIndex);
                        app.ui.updateSaveStatus(true);
                    } catch (e) {
                        console.error('Save error:', e);
                        app.ui.updateSaveStatus(false);
                    }
                }, 500);
                debouncedSave();
            }

            loadFromLocalStorage() {
                try {
                    const savedSlides = localStorage.getItem('slidegenius_slides');
                    const savedIndex = localStorage.getItem('slidegenius_current_index');
                    
                    if (savedSlides) {
                        this.slides = JSON.parse(savedSlides);
                        this.currentSlideIndex = savedIndex ? parseInt(savedIndex) : 0;
                        this.renderSlides();
                    }
                } catch (e) {
                    console.error('Load error:', e);
                }
            }
        }

        // ========================================
        // UI Manager
        // ========================================

        class UIManager {
            constructor() {
                this.currentView = 'slides';
            }

            showLoading(show, text = 'טוען...') {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                
                if (show) {
                    loadingText.textContent = text;
                    overlay.style.display = 'flex';
                } else {
                    overlay.style.display = 'none';
                }
            }

            showToast(message, type = 'success') {
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                }
                
                const toast = document.createElement('div');
                toast.className = `toast ${type} animate-slideIn`;
                toast.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-${type === 'success' ? 'check-circle text-green-600' : type === 'error' ? 'exclamation-circle text-red-600' : 'info-circle text-blue-600'} text-xl"></i>
                        <span class="font-medium text-gray-800">${message}</span>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            updateHistoryButtons() {
                // עדכון מצב הכפתורים בהתאם למחסניות undo/redo
                const undoButton = document.querySelector('[onclick*="undo()"]');
                const redoButton = document.querySelector('[onclick*="redo()"]');
                
                if (undoButton) {
                    undoButton.disabled = app.history.undoStack.length === 0;
                    undoButton.style.opacity = app.history.undoStack.length === 0 ? '0.5' : '1';
                }
                
                if (redoButton) {
                    redoButton.disabled = app.history.redoStack.length === 0;
                    redoButton.style.opacity = app.history.redoStack.length === 0 ? '0.5' : '1';
                }
            }

            toggleSettings() {
                const modal = document.getElementById('settingsModal');
                modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
            }

            showSummaryModal() {
                document.getElementById('summaryModal').style.display = 'flex';
            }

            closeSummaryModal() {
                document.getElementById('summaryModal').style.display = 'none';
            }

            showTemplateGallery() {
                const modal = document.getElementById('templateModal');
                const grid = document.getElementById('templateGrid');
                
                const templates = app.templates.getAllTemplates();
                grid.innerHTML = templates.map(template => `
                    <div class="template-card" 
                         style="background: ${template.preview};"
                         onclick="app.ui.applyTemplate('${template.id}')">
                        <div class="h-full flex items-center justify-center">
                            <div class="bg-white bg-opacity-90 backdrop-blur-sm px-4 py-2 rounded-lg">
                                <p class="font-bold text-gray-800 text-center">${template.name}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                modal.style.display = 'flex';
            }

            closeTemplateGallery() {
                document.getElementById('templateModal').style.display = 'none';
            }
            
            applyTemplate(templateId) {
                const template = app.templates.getTemplateById(templateId);
                if (!template) return;
                
                if (app.slides.currentSlideIndex === -1) {
                     this.showToast('בחר שקף להחלת תבנית', 'error');
                    return;
                }

                if (confirm(`האם להחיל את התבנית "${template.name}" על השקף הנוכחי?`)) {
                    app.history.saveState();
                    const slide = app.slides.slides[app.slides.currentSlideIndex];
                    slide.layout = template.style.layout;
                    slide.style = {
                        ...slide.style, // שמור מאפיינים אחרים שלא קשורים לתבנית
                        backgroundColor: template.style.backgroundColor,
                        textColor: template.style.textColor,
                        accentColor: template.style.accentColor,
                        font: template.style.font,
                        titleSize: template.style.titleSize,
                        pattern: template.style.pattern,
                    };
                    app.slides.renderSlides();
                    this.closeTemplateGallery();
                    this.showToast(`תבנית "${template.name}" הוחלה על השקף!`, 'success');
                }
            }

            applyRandomDesignToAll() {
                 if (app.slides.slides.length === 0) {
                    this.showToast('אין שקפים להחלת עיצוב', 'error');
                    return;
                }
                
                if (confirm('האם להחיל עיצוב אקראי מלא על כל השקפים?')) {
                    app.slides.applyRandomDesignToAll();
                    this.closeTemplateGallery();
                }
            }

            applyRandomStyleToAll() {
                 if (app.slides.slides.length === 0) {
                    this.showToast('אין שקפים להחלת עיצוב', 'error');
                    return;
                }
                
                if (confirm('האם להחיל סגנונות עיצוב אקראיים (גופן, צבעים, תבניות) על כל השקפים?')) {
                    app.slides.applyRandomStyleToAll();
                    this.closeTemplateGallery();
                }
            }

            updateSaveStatus(success) {
                const status = document.getElementById('autoSaveStatus');
                if (success) {
                    status.innerHTML = '<i class="fas fa-check-circle ml-1"></i> נשמר אוטומטית';
                    status.className = 'text-green-600 font-medium';
                } else {
                    status.innerHTML = '<i class="fas fa-exclamation-triangle ml-1"></i> שגיאה בשמירה';
                    status.className = 'text-red-600 font-medium';
                }
            }

            updateApiKeyStatus() {
                const status = document.getElementById('apiKeyStatus');
                const hasKey = !!app.ai.getApiKey();
                
                if (status) {
                    if (hasKey) {
                        status.innerHTML = '<i class="fas fa-check-circle ml-1 text-green-600"></i> מפתח API מוגדר';
                        status.className = 'text-green-600 font-medium';
                    } else {
                        status.innerHTML = '<i class="fas fa-exclamation-triangle ml-1 text-orange-600"></i> נדרש מפתח API';
                        status.className = 'text-orange-600 font-medium';
                    }
                }
            }
        }

        // ========================================
        // AI Manager
        // ========================================

        class AIManager {
            constructor() {
                this.apiEndpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';
                this.apiKey = null;
                this.imageGenerationCount = 0;
                this.maxImagesPerPresentation = 3; // מגבלה - עד 3 תמונות למצגת
            }

            getApiKey() {
                if (!this.apiKey) {
                    this.apiKey = localStorage.getItem('gemini_api_key');
                }
                return this.apiKey;
            }

            async callGemini(promptText, systemInstruction = "") {
                const apiKey = this.getApiKey();
                if (!apiKey) {
                    app.ui.showToast('נא להזין מפתח API בהגדרות', 'error');
                    app.ui.toggleSettings();
                    throw new Error('No API Key');
                }

                app.ui.showLoading(true, 'ה-AI עובד על הבקשה שלך...');

                try {
                    const payload = {
                        contents: [{
                            parts: [{
                                text: systemInstruction ? `${systemInstruction}\n\n${promptText}` : promptText
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                            // responseMimeType: "application/json" // הוסר כי מנסים לנתח ידנית
                        }
                    };

                    const response = await fetch(`${this.apiEndpoint}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) throw new Error('No response from AI');

                    const jsonMatch = text.match(/\[[\s\S]*\]/);
                    if (!jsonMatch) {
                         // נסה לחלץ JSON אם הוא מוקף ב-\`\`\`json ... \`\`\`
                         const jsonMatchCodeBlock = text.match(/\`\`\`json([\s\S]*?)\`\`\`/);
                         if (!jsonMatchCodeBlock) {
                             throw new Error('Invalid JSON response format');
                         }
                         return JSON.parse(jsonMatchCodeBlock[1].trim());
                    }

                    return JSON.parse(jsonMatch[0]);
                } catch (error) {
                    console.error('Gemini Error:', error);
                    app.ui.showToast('שגיאה בתקשורת עם Gemini: ' + error.message, 'error');
                    throw error;
                } finally {
                    app.ui.showLoading(false);
                }
            }

            async generateImageDescription(slideTitle, slideContent) {
                const prompt = `
בהתבסס על שקף במצגת עם הכותרת: "${slideTitle}"
והתוכן: ${slideContent.join(', ')}

צור תיאור קצר ומדויק באנגלית (עד 10 מילים) לתמונה שתמחיש את הנושא.
חשוב: התיאור צריך להיות ללא טקסט, ללא כיתובים, רק תיאור ויזואלי.
דוגמאות: "modern office workspace with computers", "green forest landscape", "futuristic technology concept"

החזר רק את התיאור באנגלית, ללא הסברים נוספים.`;

                try {
                    const response = await fetch(`${this.apiEndpoint}?key=${this.getApiKey()}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { temperature: 0.7, maxOutputTokens: 100 }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
                } catch (error) {
                    console.error('Image description generation error:', error);
                    return null;
                }
            }

            async generateImageUrl(slideTitle, slideContent) {
                if (this.imageGenerationCount >= this.maxImagesPerPresentation) {
                    return null; // הגענו למגבלה
                }

                const description = await this.generateImageDescription(slideTitle, slideContent);
                if (!description) return null;

                this.imageGenerationCount++;
                
                // שימוש ב-pollinations.ai עם פרמטרים מתקדמים
                const encodedPrompt = encodeURIComponent(description.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '+')); // ניקוי והצפנה
                return `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1200&height=675&nologo=true&enhance=true&model=flux&seed=${Date.now()}`;
            }

            async generateFullPresentation() {
                const topic = document.getElementById('aiPromptInput').value.trim();
                if (!topic) {
                    app.ui.showToast('נא להזין נושא למצגת', 'error');
                    return;
                }

                // איפוס מונה התמונות
                this.imageGenerationCount = 0;

                const systemPrompt = `
אתה מומחה מקצועי ליצירת מצגות PowerPoint מרהיבות.
המשתמש ביקש מצגת על הנושא: "${topic}"

עליך להחזיר מערך JSON של שקפים, כאשר כל שקף הוא אובייקט במבנה הבא:
{
    "title": "כותרת השקף בעברית",
    "content": ["נקודה 1", "נקודה 2", "נקודה 3"],
    "notes": "הערות למרצה והסברים נוספים",
    "needsImage": true או false - האם השקף צריך תמונה להמחשה
}

דרישות חשובות:
1. צור בין 6-10 שקפים איכותיים (תלוי במורכבות הנושא)
2. כל שקף צריך להיות ממוקד ועם 3-5 נקודות עיקריות
3. התוכן בעברית ברמה גבוהה, מקצועי ומעניין
4. השקף הראשון יהיה שקף פתיחה עם כותרת ראשית (ללא תמונה)
5. השקף האחרון יהיה שקף סיכום (ללא תמונה)
6. סמן needsImage: true רק ל-2-3 שקפים שבאמת זקוקים להמחשה ויזואלית
7. השקפים באמצע יפרטו את הנושא באופן לוגי ומסודר

החזר רק את מערך ה-JSON, בלי הסברים נוספים.
`;

                const result = await this.callGemini(prompt, systemPrompt);
                
                if (result && Array.isArray(result)) {
                    app.ui.showLoading(true, 'מכין עיצובים מתקדמים...');
                    app.history.saveState();
                    
                    const processedSlides = [];
                    
                    for (let index = 0; index < result.length; index++) {
                        const s = result[index];
                        
                        // יצירת עיצוב אקראי ומתקדם לכל שקף
                        const design = app.advancedDesign.generateRandomDesign();
                        
                        // יצירת תמונה אם נדרש ועוד לא הגענו למגבלה
                        let imageUrl = null;
                        if (s.needsImage && this.imageGenerationCount < this.maxImagesPerPresentation) {
                            app.ui.showLoading(true, `יוצר תמונה לשקף ${index + 1}...`);
                            imageUrl = await this.generateImageUrl(s.title, s.content || []);
                        }
                        
                        processedSlides.push({
                            id: Utils.generateId(),
                            title: s.title || 'כותרת',
                            content: Array.isArray(s.content) ? s.content : ['תוכן'],
                            notes: s.notes || '',
                            layout: design.layout,
                            imageUrl: imageUrl, // תמונה אמיתית מ-AI!
                            style: {
                                backgroundColor: design.colorScheme.bg,
                                textColor: design.colorScheme.text,
                                accentColor: design.colorScheme.accent,
                                secondaryColor: design.colorScheme.secondary,
                                font: design.font,
                                titleSize: design.titleSize,
                                contentSize: design.contentSize,
                                pattern: design.pattern,
                                textStyle: design.textStyle,
                                borderStyle: design.borderStyle,
                                shadow: design.shadow,
                                borderRadius: design.borderRadius.value,
                                opacity: design.opacity,
                                padding: design.padding,
                                lineHeight: design.lineHeight,
                                letterSpacing: design.letterSpacing
                            }
                        });
                    }
                    
                    app.slides.slides = processedSlides;
                    app.slides.currentSlideIndex = 0; // התחל מהשקף הראשון
                    app.slides.renderSlides();
                    app.ui.showToast(`נוצרו ${processedSlides.length} שקפים עם ${this.imageGenerationCount} תמונות!`, 'success');
                    app.ui.showLoading(false);
                }
            }

            async suggestImage() {
                if (app.slides.currentSlideIndex === -1) {
                    app.ui.showToast('בחר שקף תחילה', 'error');
                    return;
                }
                
                const slide = app.slides.slides[app.slides.currentSlideIndex];
                
                // עדכון שימוש ב-templates
                const newGradient = app.templates.generateGradientForSlide(slide.title, Math.random() * 1000);
                app.slides.updateSlideStyle('backgroundColor', newGradient); // שינוי רקע
                app.ui.showToast('רקע חדש נוצר!', 'success');
            }

            async proofreadCurrentSlide() {
                if (app.slides.currentSlideIndex === -1) {
                    app.ui.showToast('בחר שקף תחילה', 'error');
                    return;
                }
                
                const slide = app.slides.slides[app.slides.currentSlideIndex];
                
                const prompt = `
תקן שגיאות כתיב, דקדוק ושפר את הניסוח של השקף הבא.
שמור על אותו מבנה ומספר נקודות, רק שפר את האיכות.

כותרת: ${slide.title}
תוכן: ${JSON.stringify(slide.content, null, 2)}

החזר JSON:
{
    "title": "כותרת משופרת",
    "content": ["נקודה משופרת 1", "נקודה משופרת 2", ...]
}
`;

                const result = await this.callGemini(prompt);
                if (result && result.title && result.content) {
                    app.history.saveState();
                    slide.title = result.title;
                    slide.content = result.content;
                    app.slides.renderSlides();
                    app.ui.showToast('הטקסט שופר בהצלחה!', 'success');
                }
            }

            async generateQuizSlide() {
                if (app.slides.slides.length === 0) {
                    app.ui.showToast('צור מצגת תחילה', 'error');
                    return;
                }

                const slidesContent = app.slides.slides
                    .map(s => `${s.title}: ${s.content.join(", ")}`)
                    .join("\n\n");
                
                const prompt = `
בהתבסס על תוכן המצגת הבא, צור שקף חידון אמריקאי מאתגר.

תוכן המצגת:
${slidesContent}

החזר JSON:
{
    "title": "חידון: [נושא]",
    "content": [
        "שאלה: [שאלה מעניינת ומאתגרת]",
        "א. [תשובה 1]",
        "ב. [תשובה 2]",
        "ג. [תשובה 3]",
        "ד. [תשובה 4]"
    ],
    "notes": "התשובה הנכונה: [אות]. הסבר: ..."
}
`;

                const result = await this.callGemini(prompt);
                if (result) {
                    app.history.saveState();
                    
                    // השתמש ב-app.templates.getTemplateById וב-app.templates.getRandomTemplate
                    const template = app.templates.getTemplateById('colorful_vibrant') || app.templates.getRandomTemplate();
                    const design = app.advancedDesign.generateRandomDesign();
                    
                    app.slides.slides.push({
                        id: Utils.generateId(),
                        title: result.title,
                        content: result.content,
                        gradient: `linear-gradient(135deg, #f9a11b 0%, #ff0844 100%)`, // צבע חידון
                        notes: result.notes,
                        layout: 'centered',
                        style: { ...design.colorScheme, font: design.font, titleSize: design.titleSize, contentSize: design.contentSize }
                    });
                    
                    app.slides.currentSlideIndex = app.slides.slides.length - 1;
                    app.slides.renderSlides();
                    app.ui.showToast('שקף חידון נוצר!', 'success');
                }
            }

            async processSummary() {
                const text = document.getElementById('textToSummarize').value.trim();
                if (!text) {
                    app.ui.showToast('נא להזין טקסט לסיכום', 'error');
                    return;
                }
                
                app.ui.closeSummaryModal();

                const prompt = `
סכם את הטקסט הבא ל-4 עד 7 שקפי מצגת.
כל שקף צריך להתמקד בנקודה מרכזית אחת עם פירוט.

הטקסט:
${text.substring(0, 15000)}

החזר מערך JSON של שקפים:
[
    {
        "title": "כותרת השקף",
        "content": ["נקודה 1", "נקודה 2", "נקודה 3"],
        "imageKeyword": "מילת מפתח באנגלית לתמונה"
    }
]
`;

                const result = await this.callGemini(prompt);
                if (result && Array.isArray(result)) {
                    app.history.saveState();
                    
                    const newSlides = result.map((s, index) => {
                        const design = app.advancedDesign.generateRandomDesign();
                        return {
                            id: Utils.generateId(),
                            title: s.title,
                            content: s.content,
                            gradient: app.templates.generateGradientForSlide(s.title, index),
                            notes: 'נוצר מסיכום אוטומטי',
                            layout: design.layout,
                            style: {
                                backgroundColor: design.colorScheme.bg,
                                textColor: design.colorScheme.text,
                                accentColor: design.colorScheme.accent,
                                font: design.font,
                                titleSize: design.titleSize,
                                contentSize: design.contentSize,
                                pattern: design.pattern,
                                textStyle: design.textStyle,
                                borderStyle: design.borderStyle,
                                shadow: design.shadow,
                                borderRadius: design.borderRadius.value,
                                opacity: design.opacity,
                                padding: design.padding,
                                lineHeight: design.lineHeight,
                                letterSpacing: design.letterSpacing
                            }
                        };
                    });
                    
                    // שאל את המשתמש אם להוסיף או להחליף
                    if (app.slides.slides.length > 0) {
                        if (confirm('האם להחליף את המצגת הקיימת או להוסיף את השקפים החדשים?')) {
                            app.slides.loadSlides([...app.slides.slides, ...newSlides]);
                        } else {
                            app.slides.loadSlides(newSlides);
                        }
                    } else {
                        app.slides.loadSlides(newSlides);
                    }
                    
                    app.ui.showToast(`${newSlides.length} שקפים נוצרו מהטקסט!`, 'success');
                    document.getElementById('textToSummarize').value = '';
                }
            }
        }

        // ========================================
        // Export Manager
        // ========================================

        class ExportManager {
            cleanMarkdown(text) {
                if (!text) return text;
                return text
                    .replace(/\*\*(.+?)\*\*/g, '$1') // הסרת **bold**
                    .replace(/\*(.+?)\*/g, '$1')     // הסרת *italic*
                    .replace(/__(.+?)__/g, '$1')     // הסרת __bold__
                    .replace(/_(.+?)_/g, '$1')       // הסרת _italic_
                    .replace(/~~(.+?)~~/g, '$1')     // הסרת ~~strikethrough~~
                    .replace(/`(.+?)`/g, '$1')       // הסרת `code`
                    .trim();
            }

            async exportToPptx() {
                if (app.slides.slides.length === 0) {
                    app.ui.showToast('אין שקפים לייצא', 'error');
                    return;
                }

                try {
                    app.ui.showLoading(true, 'מייצא מצגת...');
                    
                    const pptx = new PptxGenJS();
                    
                    // הגדרות כלליות
                    pptx.layout = 'LAYOUT_16x9';
                    pptx.author = 'SlideGenius AI Pro';
                    pptx.company = 'AI Presentations';
                    pptx.subject = 'AI Generated Presentation';
                    pptx.title = this.cleanMarkdown(app.slides.slides[0]?.title) || 'מצגת';
                    pptx.rtlMode = true;

                    for (const slideData of app.slides.slides) {
                        const slide = pptx.addSlide();
                        
                        const style = slideData.style || {};
                        const bgColor = style.backgroundColor || '#ffffff';
                        const textColor = style.textColor || '#1f2937';
                        const accentColor = style.accentColor || '#667eea';
                        const fontFace = 'Arial'; // פונט תואם לעברית
                        const titleSize = Math.min(parseInt(style.titleSize) || 32, 44);
                        const contentSize = Math.min(parseInt(style.contentSize) || 18, 24);
                        
                        // רקע השקף
                        if (bgColor.startsWith('linear-gradient') || bgColor.startsWith('radial-gradient')) {
                            // המרת גרדיאנט לצבע אחיד (לוקחים את הצבע הראשון)
                            const colorMatch = bgColor.match(/#[0-9a-fA-F]{6}/);
                            if (colorMatch) {
                                slide.background = { color: colorMatch[0].replace('#', '') };
                            } else {
                                slide.background = { color: 'ffffff' };
                            }
                        } else {
                            slide.background = { color: bgColor.replace('#', '') };
                        }
                        
                        // פריסה בהתאם לאם יש תמונה
                        let titleX = 0.5;
                        let titleY = 0.7;
                        let titleW = '90%';
                        let titleH = 1.2;
                        
                        let contentX = 0.5;
                        let contentY = 2.2;
                        let contentW = '90%';
                        
                        if (slideData.imageUrl) {
                            try {
                                await slide.addImage({
                                    path: slideData.imageUrl,
                                    x: '52%',
                                    y: 0.5,
                                    w: '45%',
                                    h: 5.5,
                                    sizing: { type: 'cover', w: '45%', h: 5.5 }
                                });
                                
                                // כשיש תמונה, הטקסט בצד שמאל
                                titleW = '48%';
                                contentW = '48%';
                            } catch (imgError) {
                                console.error('Image load error in PPTX:', imgError);
                            }
                        }

                        const cleanTitle = this.cleanMarkdown(slideData.title);
                        slide.addText(cleanTitle, {
                            x: titleX,
                            y: titleY,
                            w: titleW,
                            h: titleH,
                            fontSize: titleSize,
                            bold: true,
                            color: accentColor.replace('#', '').substring(0, 6),
                            align: 'right',
                            fontFace: fontFace,
                            rtlMode: true,
                            valign: 'middle'
                        });

                        const lineHeight = 0.65;
                        slideData.content.forEach((item, index) => {
                            const cleanContent = this.cleanMarkdown(item);
                            slide.addText(`• ${cleanContent}`, {
                                x: contentX,
                                y: contentY + (index * lineHeight),
                                w: contentW,
                                h: 0.6,
                                fontSize: contentSize,
                                color: textColor.replace('#', '').substring(0, 6),
                                align: 'right',
                                fontFace: fontFace,
                                valign: 'top',
                                rtlMode: true,
                                bullet: false // השבתנו bullets כי אנחנו מוסיפים ידנית
                            });
                        });

                        // הערות למרצה
                        if (slideData.notes) {
                            const cleanNotes = this.cleanMarkdown(slideData.notes);
                            slide.addNotes(cleanNotes);
                        }
                    }

                    const fileName = `${this.cleanMarkdown(app.slides.slides[0]?.title) || 'מצגת'}_${new Date().getTime()}.pptx`;
                    await pptx.writeFile({ fileName });
                    
                    app.ui.showLoading(false);
                    app.ui.showToast('המצגת יוצאה בהצלחה!', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    app.ui.showLoading(false);
                    app.ui.showToast('שגיאה בייצוא המצגת: ' + error.message, 'error');
                }
            }
        }

        // ========================================
        // History Manager
        // ========================================

        class HistoryManager {
            constructor() {
                this.undoStack = [];
                this.redoStack = [];
                this.maxHistory = 30;
                this.versions = [];
            }

            saveState() {
                const state = JSON.stringify({
                    slides: app.slides.slides,
                    currentIndex: app.slides.currentSlideIndex
                });
                
                // מניעת שמירת מצבים זהים ברצף
                if (this.undoStack.length > 0 && this.undoStack[this.undoStack.length - 1] === state) {
                    return;
                }
                
                this.undoStack.push(state);
                if (this.undoStack.length > this.maxHistory) {
                    this.undoStack.shift();
                }
                
                this.redoStack = []; // איפוס ה-redo stack בכל שינוי חדש
                app.ui.updateHistoryButtons(); // עדכון כפתורי undo/redo
            }

            undo() {
                if (this.undoStack.length === 0) {
                    app.ui.showToast('אין מה לבטל', 'error');
                    return;
                }
                
                // שמירת המצב הנוכחי ב-redo stack לפני הביטול
                const currentState = JSON.stringify({
                    slides: app.slides.slides,
                    currentIndex: app.slides.currentSlideIndex
                });
                this.redoStack.push(currentState);
                
                const prevState = JSON.parse(this.undoStack.pop());
                app.slides.loadSlides(prevState.slides, prevState.currentIndex);
                app.ui.showToast('בוטל', 'success');
                app.ui.updateHistoryButtons();
            }

            redo() {
                if (this.redoStack.length === 0) {
                    app.ui.showToast('אין מה לבצע שוב', 'error');
                    return;
                }
                
                // שמירת המצב הנוכחי ב-undo stack לפני ה-redo
                const currentState = JSON.stringify({
                    slides: app.slides.slides,
                    currentIndex: app.slides.currentSlideIndex
                });
                this.undoStack.push(currentState);
                
                const nextState = JSON.parse(this.redoStack.pop());
                app.slides.loadSlides(nextState.slides, nextState.currentIndex);
                app.ui.showToast('בוצע שוב', 'success');
                app.ui.updateHistoryButtons();
            }

            saveVersion() {
                const versionName = prompt('שם הגרסה:', `גרסה ${this.versions.length + 1}`);
                if (!versionName) return;
                
                this.versions.push({
                    id: Utils.generateId(),
                    name: versionName,
                    timestamp: new Date().toISOString(),
                    data: JSON.stringify(app.slides.slides) // שמירת כל השקפים
                });
                
                localStorage.setItem('slidegenius_versions', JSON.stringify(this.versions));
                this.renderVersionList();
                app.ui.showToast('גרסה נשמרה בהצלחה!', 'success');
            }

            loadVersion(versionId) {
                const version = this.versions.find(v => v.id === versionId);
                if (!version) return;
                
                if (confirm(`האם לטעון את הגרסה "${version.name}"? פעולה זו תבטל את השינויים האחרונים.`)) {
                    app.history.saveState(); // שמור את המצב הנוכחי לפני טעינת גרסה
                    const slides = JSON.parse(version.data);
                    app.slides.loadSlides(slides); // טעינת הגרסה
                    app.ui.showToast(`גרסה "${version.name}" נטענה`, 'success');
                }
            }

            deleteVersion(versionId) {
                if (confirm('האם למחוק את הגרסה?')) {
                    this.versions = this.versions.filter(v => v.id !== versionId);
                    localStorage.setItem('slidegenius_versions', JSON.stringify(this.versions));
                    this.renderVersionList();
                    app.ui.showToast('גרסה נמחקה', 'success');
                }
            }

            renderVersionList() {
                const container = document.getElementById('versionList');
                if (this.versions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">אין גרסאות שמורות</p>';
                    return;
                }
                
                container.innerHTML = this.versions.map(v => {
                    const date = new Date(v.timestamp);
                    return `
                        <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200 mb-2">
                            <div>
                                <p class="font-semibold text-gray-800">${v.name}</p>
                                <p class="text-xs text-gray-500">${date.toLocaleString('he-IL')}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="app.history.loadVersion('${v.id}')" 
                                        class="text-blue-600 hover:text-blue-800 transition">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="app.history.deleteVersion('${v.id}')" 
                                        class="text-red-600 hover:text-red-800 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            loadVersionsFromStorage() {
                try {
                    const saved = localStorage.getItem('slidegenius_versions');
                    if (saved) {
                        this.versions = JSON.parse(saved);
                        this.renderVersionList();
                    }
                } catch (e) {
                    console.error('Error loading versions:', e);
                }
            }
        }

        // ========================================
        // Application Instance
        // ========================================
        
        window.app = {
            slides: new SlidesManager(),
            ui: new UIManager(),
            ai: null, // נאתחל אחרי
            export: null, // נאתחל אחרי
            history: new HistoryManager(),
            advancedDesign: new AdvancedDesignSystem(),
            templates: null // נאתחל אחרי
        };
        
        // עכשיו נאתחל את templates עם advancedDesign
        window.app.templates = new DesignTemplates(window.app.advancedDesign);
        
        // ועכשיו נאתחל את השאר
        window.app.ai = new AIManager();
        window.app.export = new ExportManager();


        // ========================================
        // Initialization
        // ========================================

        window.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 SlideGenius AI Pro - Initializing...');
            
            // טעינת נתונים מהזיכרון
            app.slides.loadFromLocalStorage();
            app.history.loadVersionsFromStorage();
            app.ui.updateApiKeyStatus();
            app.ui.updateHistoryButtons(); // עדכון כפתורי undo/redo בהתחלה
            
            // בדיקה אם יש שקפים, אם לא - הצג הודעת ברוכים הבאים
            if (app.slides.slides.length === 0) {
                setTimeout(() => {
                    app.ui.showToast('ברוכים הבאים ל-SlideGenius AI Pro! 🎉', 'success');
                }, 500);
            }
            
            console.log('✅ System ready!');
        });

        // קיצורי מקלדת
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z / Cmd+Z - Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                app.history.undo();
            }
            
            // Ctrl+Shift+Z / Cmd+Shift+Z - Redo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                app.history.redo();
            }
            
            // Ctrl+S / Cmd+S - Save Version
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                app.history.saveVersion();
            }
            
            // Ctrl+E / Cmd+E - Export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                app.export.exportToPptx();
            }
        });

        console.log('🎨 SlideGenius AI Pro - Loaded Successfully!');
    </script>
</body>
</html>
